<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WTI MORNING BRIEF</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Mono:ital,wght@0,300;0,400;0,500;1,300&family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
:root {
  --bg:      #12141a;
  --surface: #1a1d25;
  --card:    #20242e;
  --inset:   #161920;
  --hdr:     #0d0f15;
  --border:  #282c3a;
  --border2: #343a50;
  --green:   #34d875;
  --red:     #f87171;
  --text:    #e8ecf4;       /* ê¸°ë³¸ í…ìŠ¤íŠ¸ â€” ë°ê²Œ */
  --text2:   #c4cce0;       /* ë³´ì¡° í…ìŠ¤íŠ¸ â€” ì¶©ë¶„íˆ ë°ê²Œ */
  --dim:     #6a7490;
  --ylw:     #fbbf24;
  --ylw2:    #fde68a;
  --ylw3:    #fef3c7;
  --gold:    #f59e0b;
  --ylw-dim: #7a560e;
  --quote-txt: #ffffff;     /* ì›ë¬¸ ì¸ìš© â€” í°ìƒ‰ìœ¼ë¡œ ê°•í™” */
  --ctr-txt:   #d4dae8;     /* ë°˜ëŒ€ìš”ì¸ ì›ë¬¸ */
  --tag-bear-bg:#2a1818; --tag-bear-txt:#f87171; --tag-bear-bd:#7a2c2c;
  --tag-bull-bg:#182a1c; --tag-bull-txt:#34d875; --tag-bull-bd:#2a6636;
  --tag-dim-bg: #1c2030; --tag-dim-txt: #8898b8; --tag-dim-bd: #2c3550;
  --mono:'DM Mono',monospace; --sans:'Noto Sans KR',sans-serif; --disp:'Bebas Neue',sans-serif;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
html,body{min-height:100%;background:var(--bg);color:var(--text);font-family:var(--sans);}

/* â•â• HEADER â•â• */
.hdr{
  position:sticky;top:0;z-index:100;
  background:var(--hdr);border-bottom:2px solid var(--gold);
  display:flex;align-items:center;justify-content:space-between;
  padding:0 48px;height:72px;
  box-shadow:0 2px 28px rgba(0,0,0,.7);
}
.hdr-left{display:flex;align-items:baseline;gap:20px;}
.hdr-logo{font-family:var(--disp);font-size:38px;letter-spacing:.14em;color:var(--ylw);}
.hdr-sub{font-family:var(--mono);font-size:12px;letter-spacing:.2em;color:var(--dim);text-transform:uppercase;}
.hdr-right{display:flex;align-items:center;gap:14px;}
.hdr-clock{font-family:var(--mono);font-size:14px;color:var(--ylw2);}
.btn-new{
  background:var(--gold);color:#140e00;border:none;border-radius:5px;
  padding:10px 26px;font-family:var(--mono);font-size:13px;
  font-weight:700;letter-spacing:.12em;text-transform:uppercase;cursor:pointer;transition:background .15s;
}
.btn-new:hover{background:var(--ylw);}
.btn-refresh{
  background:transparent;border:1px solid var(--border2);color:var(--dim);
  padding:9px 18px;border-radius:5px;font-family:var(--mono);font-size:12px;
  letter-spacing:.1em;text-transform:uppercase;cursor:pointer;transition:all .15s;
}
.btn-refresh:hover{border-color:var(--ylw);color:var(--ylw);}

/* â•â• ê²€ìƒ‰ë°” â•â• */
.search-bar{
  background:var(--hdr);border-bottom:1px solid var(--border);
  padding:14px 48px;display:flex;align-items:center;gap:16px;
}
.sb-label{font-family:var(--mono);font-size:11px;letter-spacing:.16em;text-transform:uppercase;color:var(--ylw);white-space:nowrap;}
.sb-input{
  background:var(--card);border:1px solid var(--border2);border-radius:5px;
  color:var(--ylw2);font-family:var(--mono);font-size:14px;
  padding:8px 14px;outline:none;transition:border-color .15s;width:175px;
}
.sb-input:focus{border-color:var(--gold);}
.sb-btn{
  background:transparent;border:1px solid var(--border2);color:var(--dim);
  padding:8px 16px;border-radius:5px;font-family:var(--mono);font-size:11px;
  letter-spacing:.1em;text-transform:uppercase;cursor:pointer;transition:all .15s;
}
.sb-btn:hover{border-color:var(--ylw);color:var(--ylw);}
.sb-result{font-family:var(--mono);font-size:12px;color:var(--dim);margin-left:auto;}

/* â•â• ë ˆì´ì•„ì›ƒ â•â• */
.wrap{max-width:1500px;margin:0 auto;padding:44px 48px 100px;}
.empty{text-align:center;padding:100px 0;font-family:var(--mono);font-size:13px;letter-spacing:.12em;color:var(--dim);}
.empty .e-icon{font-size:52px;margin-bottom:20px;opacity:.18;}
.loading{text-align:center;padding:70px 0;font-family:var(--mono);font-size:13px;color:var(--dim);}
.spinner{width:34px;height:34px;border:2px solid var(--border2);border-top-color:var(--gold);border-radius:50%;animation:spin .7s linear infinite;margin:0 auto 16px;}
@keyframes spin{to{transform:rotate(360deg)}}
.date-group{margin-bottom:48px;}

/* â•â• CARD â•â• */
.brief{
  background:var(--surface);border:1px solid var(--border);
  border-radius:12px;overflow:hidden;
  box-shadow:0 6px 36px rgba(0,0,0,.5);
  animation:fadeUp .3s ease both;
}
.brief.dir-dn{border-left:6px solid var(--red);}
.brief.dir-up{border-left:6px solid var(--green);}
.brief.dir-flt{border-left:6px solid var(--dim);}
@keyframes fadeUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:none}}
.brief.sub-source{margin-top:8px;border-radius:8px;border-left:6px solid var(--ylw-dim);}

/* â•â• ê°€ê²© í—¤ë” â•â• */
.brief-header{
  display:flex;align-items:stretch;
  background:var(--card);border-bottom:1px solid var(--border);
  min-height:180px;
}

/* ë‚ ì§œ */
.bh-date{
  padding:30px 36px;border-right:1px solid var(--border);
  display:flex;flex-direction:column;justify-content:center;gap:10px;
  min-width:220px;flex-shrink:0;
}
.bh-date-val{font-family:var(--mono);font-size:28px;color:var(--ylw2);font-weight:700;letter-spacing:.04em;}
.bh-date-cont{font-family:var(--mono);font-size:14px;color:var(--dim);}

/* ê°€ê²© â€” ì¢…ê°€ë¥¼ í¬ê³  ì„íŒ©íŠ¸ìˆê²Œ */
.bh-price{
  display:flex;align-items:center;gap:12px;
  padding:24px 40px;flex-shrink:0;
}
.bh-arrow{font-family:var(--disp);font-size:56px;line-height:1;flex-shrink:0;}
.bh-arrow.up{color:var(--green);}
.bh-arrow.dn{color:var(--red);}
.bh-arrow.flt{color:var(--dim);}
.bh-price-block{display:flex;flex-direction:column;gap:4px;}
.bh-price-label{font-family:var(--mono);font-size:11px;letter-spacing:.18em;text-transform:uppercase;color:var(--ylw);opacity:.8;}
.bh-val{font-family:var(--disp);font-size:160px;line-height:.88;letter-spacing:.01em;}
.bh-val.up{color:var(--green);}
.bh-val.dn{color:var(--red);}
.bh-val.flt{color:var(--text);}
.bh-unit{font-family:var(--mono);font-size:16px;color:var(--dim);align-self:flex-end;padding-bottom:16px;line-height:1.6;}

/* ë¸íƒ€ */
.bh-delta{
  display:flex;flex-direction:column;justify-content:center;gap:16px;
  padding:24px 36px;border-left:1px solid var(--border);flex-shrink:0;
}
.bh-d-row{display:flex;align-items:center;gap:14px;}
.bh-d-label{font-family:var(--mono);font-size:12px;letter-spacing:.12em;color:var(--dim);width:36px;text-transform:uppercase;}
.bh-d-val{font-family:var(--mono);font-size:44px;font-weight:700;line-height:1;}
.bh-d-val.up{color:var(--green);}
.bh-d-val.dn{color:var(--red);}

/* ë°©í–¥ ë±ƒì§€ */
.bh-dir{
  padding:24px 32px;border-left:1px solid var(--border);
  display:flex;flex-direction:column;align-items:center;justify-content:center;gap:10px;flex-shrink:0;
}
.bh-dir-badge{
  font-family:var(--sans);font-size:26px;font-weight:800;
  padding:12px 32px;border-radius:36px;white-space:nowrap;
}
.bh-dir-badge.up{background:rgba(52,216,117,.18);color:var(--green);border:1px solid rgba(52,216,117,.4);}
.bh-dir-badge.dn{background:rgba(248,113,113,.18);color:var(--red);border:1px solid rgba(248,113,113,.4);}
.bh-dir-badge.flt{background:rgba(106,116,144,.18);color:var(--dim);border:1px solid var(--border2);}
.bh-dir-label{font-family:var(--mono);font-size:11px;color:var(--dim);letter-spacing:.14em;text-transform:uppercase;}

/* EDIT/DEL */
.bh-actions{margin-left:auto;display:flex;flex-direction:column;border-left:1px solid var(--border);min-width:90px;align-self:stretch;}
.act-btn{
  flex:1;display:flex;align-items:center;justify-content:center;
  background:transparent;border:none;cursor:pointer;
  font-family:var(--mono);font-size:12px;letter-spacing:.1em;color:var(--dim);
  padding:0 16px;transition:all .15s;text-transform:uppercase;
  border-bottom:1px solid var(--border);
}
.act-btn:last-child{border-bottom:none;}
.act-btn.edit:hover{background:rgba(251,191,36,.08);color:var(--ylw);}
.act-btn.del:hover{background:rgba(248,113,113,.08);color:var(--red);}

/* â•â• ì†ŒìŠ¤ í—¤ë” (ì¶”ê°€íŒŒì‹±) â•â• */
.source-header{
  display:flex;align-items:center;justify-content:space-between;
  padding:16px 32px;background:var(--card);border-bottom:1px solid var(--border);
}
.src-badge{
  font-family:var(--mono);font-size:13px;letter-spacing:.14em;text-transform:uppercase;
  color:var(--ylw);background:rgba(245,158,11,.1);border:1px solid var(--ylw-dim);
  padding:6px 16px;border-radius:4px;
}
.src-actions{display:flex;gap:8px;}
.src-act-btn{
  background:transparent;border:1px solid var(--border2);color:var(--dim);
  padding:6px 14px;border-radius:4px;font-family:var(--mono);font-size:12px;
  text-transform:uppercase;cursor:pointer;transition:all .15s;letter-spacing:.08em;
}
.src-act-btn.edit:hover{border-color:var(--ylw);color:var(--ylw);}
.src-act-btn.del:hover{border-color:var(--red);color:var(--red);}

/* â•â• ì•„ì½”ë””ì–¸ â•â• */
.accordion-toggle{
  width:100%;padding:16px 32px;
  background:var(--inset);border:none;border-top:1px solid var(--border);
  display:flex;align-items:center;justify-content:space-between;
  cursor:pointer;transition:background .15s;
}
.accordion-toggle:hover{background:rgba(245,158,11,.05);}
.at-label{font-family:var(--mono);font-size:13px;letter-spacing:.14em;text-transform:uppercase;color:var(--ylw);display:flex;align-items:center;gap:10px;}
.at-arrow{font-size:14px;color:var(--ylw);transition:transform .22s;}
.at-arrow.open{transform:rotate(180deg);}
.accordion-body{display:none;}
.accordion-body.open{display:block;}

/* â•â• 2ì»¬ëŸ¼ íŒ©íŠ¸ íŒ¨ë„ â•â• */
.brief-facts{
  display:grid;grid-template-columns:1fr 1fr;
  border-bottom:1px solid var(--border);
}
.fact-col{
  padding:30px 34px;
  display:flex;flex-direction:column;gap:16px;
}
.fact-col:first-child{border-right:1px solid var(--border);}

.fact-col-title{
  display:flex;align-items:center;gap:10px;
  font-family:var(--mono);font-size:13px;letter-spacing:.18em;text-transform:uppercase;
  color:var(--ylw);padding-bottom:14px;border-bottom:1px solid var(--border);
}
.fact-col-title.counter{color:var(--ylw-dim);}
.fc-dot{width:9px;height:9px;border-radius:50%;flex-shrink:0;}
.fc-dot.bear{background:var(--red);}
.fc-dot.bull{background:var(--green);}
.fc-dot.dim{background:var(--dim);}

.factor-tags{display:flex;flex-wrap:wrap;gap:10px;}
.factor-tag{
  display:inline-block;padding:8px 18px;border-radius:24px;
  font-size:16px;font-weight:600;letter-spacing:.02em;
}
.factor-tag.bear{background:var(--tag-bear-bg);color:var(--tag-bear-txt);border:1px solid var(--tag-bear-bd);}
.factor-tag.bull{background:var(--tag-bull-bg);color:var(--tag-bull-txt);border:1px solid var(--tag-bull-bd);}
.factor-tag.dim{background:var(--tag-dim-bg);color:var(--tag-dim-txt);border:1px solid var(--tag-dim-bd);}
.fact-empty{font-family:var(--mono);font-size:13px;color:var(--dim);opacity:.6;}

/* ì›ë¬¸ ì¸ìš© */
.source-quote{
  background:var(--inset);
  border:1px solid var(--ylw-dim);
  border-left:4px solid var(--gold);
  border-radius:8px;padding:16px 20px;
}
.sq-label{
  font-family:var(--mono);font-size:11px;letter-spacing:.16em;text-transform:uppercase;
  color:var(--ylw);margin-bottom:10px;display:flex;align-items:center;gap:7px;
}
.sq-text{
  font-size:16px;line-height:1.82;
  color:var(--quote-txt);  /* í°ìƒ‰ */
  font-style:italic;font-weight:400;
  display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden;
}
.sq-text::before{content:'"';font-size:22px;line-height:0;vertical-align:-4px;margin-right:3px;color:var(--gold);}
.sq-text::after{content:'"';font-size:22px;line-height:0;vertical-align:-4px;margin-left:3px;color:var(--gold);}

/* ë°˜ëŒ€ìš”ì¸ ì›ë¬¸ â€” ë³„ë„ ìƒ‰ìƒ */
.source-quote.counter{border-color:var(--border2);border-left-color:var(--dim);background:rgba(22,25,32,.7);}
.source-quote.counter .sq-label{color:var(--ylw-dim);}
.source-quote.counter .sq-text{color:var(--ctr-txt);} /* ë°ì€ ê·¸ë ˆì´ */
.source-quote.counter .sq-text::before,
.source-quote.counter .sq-text::after{color:var(--dim);}

/* â•â• ì½”ë©˜í„°ë¦¬ â•â• */
.brief-commentary{
  padding:28px 34px;border-bottom:1px solid var(--border);
  background:var(--inset);
  border-left:6px solid var(--gold);
}
.co-label{
  font-family:var(--mono);font-size:12px;letter-spacing:.18em;text-transform:uppercase;
  color:var(--ylw);margin-bottom:14px;display:flex;align-items:center;gap:10px;
}
.co-label::after{content:'';flex:1;height:1px;background:var(--ylw-dim);opacity:.4;}
.co-text{
  font-size:22px;line-height:1.88;
  color:var(--ylw3);           /* ì•„ì´ë³´ë¦¬ */
  white-space:pre-wrap;font-weight:500;  /* 500ìœ¼ë¡œ ë‘ê»ê²Œ */
}

/* â•â• COPY ROW â•â• */
.brief-copy{
  padding:16px 30px;display:flex;align-items:center;justify-content:flex-end;gap:10px;
  background:var(--card);
}
.cp-btn{
  font-family:var(--mono);font-size:12px;letter-spacing:.08em;text-transform:uppercase;
  background:transparent;border:1px solid var(--border2);color:var(--dim);
  padding:9px 20px;border-radius:5px;cursor:pointer;transition:all .15s;
}
.cp-btn:hover{border-color:var(--ylw);color:var(--ylw);}
.cp-btn.img:hover{border-color:var(--green);color:var(--green);}
.cp-btn.ok{border-color:var(--green);color:var(--green);}

/* â•â• MODAL â•â• */
#overlay{
  position:fixed;inset:0;z-index:200;
  background:rgba(0,0,0,.8);backdrop-filter:blur(10px);
  display:none;align-items:center;justify-content:center;
}
#overlay.open{display:flex;}
#modal{
  width:820px;max-height:92vh;
  background:var(--surface);border:1px solid var(--border2);border-radius:14px;
  display:flex;flex-direction:column;overflow:hidden;
  box-shadow:0 32px 90px rgba(0,0,0,.75);animation:mIn .22s ease;
}
@keyframes mIn{from{opacity:0;transform:translateY(14px) scale(.98)}to{opacity:1;transform:none}}
.mhdr{
  display:flex;align-items:center;justify-content:space-between;
  padding:18px 30px;border-bottom:1px solid var(--border);
  background:var(--hdr);flex-shrink:0;
}
.mhdr-title{font-family:var(--mono);font-size:14px;letter-spacing:.16em;text-transform:uppercase;color:var(--ylw);}
.mhdr-close{
  background:transparent;border:1px solid var(--border2);color:var(--dim);
  width:34px;height:34px;border-radius:4px;cursor:pointer;font-size:17px;
  display:flex;align-items:center;justify-content:center;transition:all .15s;
}
.mhdr-close:hover{border-color:var(--red);color:var(--red);}
.mbody{
  flex:1;overflow-y:auto;padding:26px 30px;
  display:flex;flex-direction:column;gap:20px;background:var(--bg);
}
.m-sec{
  background:var(--surface);border:1px solid var(--border);border-radius:9px;
  padding:18px 22px;display:flex;flex-direction:column;gap:13px;
}
.m-sec-label{
  font-family:var(--mono);font-size:12px;letter-spacing:.18em;text-transform:uppercase;
  color:var(--ylw);display:flex;align-items:center;gap:8px;
}
.m-sec-label::after{content:'';flex:1;height:1px;background:var(--ylw-dim);opacity:.35;}
#news-ta{
  width:100%;height:150px;resize:vertical;
  background:var(--card);border:1px solid var(--border2);border-radius:6px;
  color:var(--text);font-family:var(--sans);font-size:14px;line-height:1.72;
  padding:13px 15px;outline:none;transition:border-color .15s;
}
#news-ta:focus{border-color:var(--gold);}
#news-ta::placeholder{color:var(--dim);font-size:13px;}
#parsed-wrap,#step-factors{display:none;}
.pf-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;}
.pf-grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
.pfield{display:flex;flex-direction:column;gap:6px;}
.pfield label{font-family:var(--mono);font-size:11px;letter-spacing:.1em;text-transform:uppercase;color:var(--ylw-dim);}
.pfield input,.pfield select,.pfield textarea{
  background:var(--card);border:1px solid var(--border2);border-radius:6px;
  color:var(--text);font-family:var(--mono);font-size:14px;
  padding:10px 12px;outline:none;width:100%;transition:border-color .15s;
}
.pfield input:focus,.pfield select:focus,.pfield textarea:focus{border-color:var(--gold);}
.pfield input.hi{color:var(--ylw2);font-weight:700;border-color:var(--ylw-dim);background:rgba(245,158,11,.05);}
.pfield textarea{resize:vertical;min-height:58px;font-family:var(--sans);font-size:13px;line-height:1.65;}
.parse-status{
  font-family:var(--mono);font-size:12px;padding:10px 14px;
  border-radius:6px;margin-top:4px;display:none;
}
.parse-status.ok{background:rgba(52,216,117,.08);border:1px solid rgba(52,216,117,.3);color:var(--green);}
.parse-status.warn{background:rgba(251,191,36,.08);border:1px solid rgba(251,191,36,.3);color:var(--ylw);}
.parse-status.err{background:rgba(248,113,113,.08);border:1px solid rgba(248,113,113,.3);color:var(--red);}
.chip-sec-label{
  font-family:var(--mono);font-size:11px;letter-spacing:.14em;text-transform:uppercase;
  color:var(--ylw-dim);margin-bottom:6px;margin-top:8px;
}
.chip-sec-label:first-child{margin-top:0;}
.chip-wrap{display:flex;flex-wrap:wrap;gap:7px;}
.chip{
  font-family:var(--sans);font-size:13px;font-weight:500;
  padding:6px 14px;border-radius:20px;border:1px solid var(--border2);
  color:var(--dim);background:var(--card);cursor:pointer;transition:all .12s;user-select:none;
}
.chip:hover{border-color:var(--ylw);color:var(--ylw);}
.chip.sel-bear{background:var(--tag-bear-bg);border-color:var(--tag-bear-bd);color:var(--tag-bear-txt);}
.chip.sel-bull{background:var(--tag-bull-bg);border-color:var(--tag-bull-bd);color:var(--tag-bull-txt);}
.divider{height:1px;background:var(--border);margin:4px 0;}
.mftr{
  flex-shrink:0;padding:16px 30px;border-top:1px solid var(--border);
  display:flex;gap:10px;background:var(--surface);
}
.mf-btn{
  padding:12px 20px;border:none;border-radius:6px;cursor:pointer;
  font-family:var(--mono);font-size:13px;letter-spacing:.1em;
  text-transform:uppercase;font-weight:700;transition:all .15s;
}
.mf-parse{flex:1;background:var(--card);color:var(--ylw);border:1px solid var(--ylw-dim);}
.mf-parse:hover{background:rgba(245,158,11,.1);border-color:var(--ylw);}
.mf-save{flex:2;background:var(--gold);color:#140e00;display:none;}
.mf-save:hover{background:var(--ylw);}
.mf-close{
  background:transparent;border:1px solid var(--border2);color:var(--dim);
  padding:12px 18px;border-radius:6px;cursor:pointer;font-family:var(--mono);font-size:13px;transition:all .15s;
}
.mf-close:hover{border-color:var(--red);color:var(--red);}

/* â•â• TOAST â•â• */
#toast{
  position:fixed;bottom:30px;right:30px;z-index:9999;
  padding:14px 22px;border-radius:8px;font-family:var(--mono);font-size:14px;
  font-weight:500;color:#fff;opacity:0;transform:translateY(10px);
  transition:all .24s;pointer-events:none;max-width:360px;
  box-shadow:0 8px 30px rgba(0,0,0,.6);
}
#toast.show{opacity:1;transform:translateY(0);}
#toast.ok{background:#166534;}
#toast.err{background:#991b1b;}
#toast.inf{background:#1e3a5f;}

::-webkit-scrollbar{width:5px;}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:3px;}
</style>
</head>
<body>

<header class="hdr">
  <div class="hdr-left">
    <div class="hdr-logo">WTI BRIEF</div>
    <div class="hdr-sub">Crude Oil Â· Morning Monitor</div>
  </div>
  <div class="hdr-right">
    <div class="hdr-clock" id="clock"></div>
    <button class="btn-refresh" onclick="loadData()">â†» REFRESH</button>
    <button class="btn-new" onclick="openModal()">+ NEW ENTRY</button>
  </div>
</header>

<div class="search-bar">
  <span class="sb-label">â—ˆ ë‚ ì§œ ê²€ìƒ‰</span>
  <input type="date" class="sb-input" id="sb-date">
  <button class="sb-btn" onclick="doSearch()">ğŸ” ê²€ìƒ‰</button>
  <button class="sb-btn" id="sb-clear" onclick="clearSearch()" style="display:none">âœ• ì „ì²´ë³´ê¸°</button>
  <span class="sb-result" id="sb-result"></span>
</div>

<div class="wrap">
  <div id="loading" style="display:none"><div class="spinner"></div>ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
  <div class="empty" id="empty" style="display:none">
    <div class="e-icon">â—ˆ</div>
    <div style="color:var(--ylw2)">NO ENTRIES YET</div>
    <div style="margin-top:10px;font-size:12px;color:var(--dim)">
      <strong style="color:var(--ylw)">+ NEW ENTRY</strong> ë²„íŠ¼ìœ¼ë¡œ ì²« ë²ˆì§¸ ë¸Œë¦¬í”„ë¥¼ ì¶”ê°€í•˜ì„¸ìš”
    </div>
  </div>
  <div id="cards"></div>
</div>

<!-- MODAL -->
<div id="overlay">
  <div id="modal">
    <div class="mhdr">
      <div class="mhdr-title" id="modal-title">â—ˆ NEW WTI ENTRY</div>
      <button class="mhdr-close" onclick="closeModal()">âœ•</button>
    </div>
    <div class="mbody">
      <div class="m-sec">
        <div class="m-sec-label">01 Â· ë‰´ìŠ¤ í…ìŠ¤íŠ¸</div>
        <textarea id="news-ta" placeholder="WTI ê¸°ì‚¬ ì „ë¬¸ ë¶™ì—¬ë„£ê¸° â†’ íŒŒì‹± ë²„íŠ¼ í´ë¦­
ìˆ˜ì¹˜ / ì›”ë¬¼ / ë‚ ì§œ / ì£¼ìš”ì¸ / ë°˜ëŒ€ìš”ì¸ / ì›ë¬¸ / ì½”ë©˜í„°ë¦¬ ìë™ ìƒì„±
ê°™ì€ ë‚ ì§œ ì¶”ê°€ íŒŒì‹± â†’ ì•„ì½”ë””ì–¸ìœ¼ë¡œ ì¹´ë“œì— ì¶”ê°€ë©ë‹ˆë‹¤"></textarea>
        <div class="parse-status" id="parse-st"></div>
      </div>
      <div class="m-sec" id="parsed-wrap">
        <div class="m-sec-label">02 Â· ìˆ˜ì¹˜ í™•ì¸ Â· ìˆ˜ì •</div>
        <div class="pf-grid" style="margin-bottom:12px">
          <div class="pfield"><label>WTI ì¢…ê°€ ($/bbl) *</label>
            <input type="number" id="f-wti" step="0.01" placeholder="62.33" class="hi"></div>
          <div class="pfield"><label>ì „ì¼æ¯” $</label>
            <input type="number" id="f-abs" step="0.01" placeholder="-0.56" oninput="autoPct()"></div>
          <div class="pfield"><label>ë³€ë™ë¥  %</label>
            <input type="number" id="f-pct" step="0.01" placeholder="-0.89"></div>
        </div>
        <div class="pf-grid-2" style="margin-bottom:12px">
          <div class="pfield"><label>ê¸°ì¤€ì¼ *</label>
            <input type="date" id="f-date"></div>
          <div class="pfield"><label>ì›”ë¬¼ *</label>
            <select id="f-cont">
              <option value="Mar">3ì›”ë¬¼ (Mar)</option>
              <option value="Apr">4ì›”ë¬¼ (Apr)</option>
              <option value="May">5ì›”ë¬¼ (May)</option>
              <option value="Jun">6ì›”ë¬¼ (Jun)</option>
            </select></div>
        </div>
        <div class="pf-grid-2">
          <div class="pfield"><label>ì½”ë©˜í„°ë¦¬</label>
            <textarea id="f-commentary" placeholder="ìë™ ìƒì„± ë˜ëŠ” ì§ì ‘ ì…ë ¥"></textarea></div>
          <div class="pfield"><label>ì£¼ìš”ì¸ ì›ë¬¸ (í•œ ë¬¸ì¥)</label>
            <textarea id="f-main-quote" placeholder="ìë™ ì¶”ì¶œ ë˜ëŠ” ì§ì ‘ ì…ë ¥"></textarea></div>
        </div>
      </div>
      <div class="m-sec" id="step-factors">
        <div class="m-sec-label">03 Â· ì£¼ìš”ì¸ ì„ íƒ</div>
        <div class="chip-sec-label">â–¼ BEARISH Â· í•˜ë½ ìš”ì¸</div>
        <div class="chip-wrap" id="main-chips-bear"></div>
        <div class="chip-sec-label">â–² BULLISH Â· ìƒìŠ¹ ìš”ì¸</div>
        <div class="chip-wrap" id="main-chips-bull"></div>
        <div class="divider"></div>
        <div class="m-sec-label">04 Â· ë°˜ëŒ€ìš”ì¸ (ì„ íƒì‚¬í•­)</div>
        <div class="chip-sec-label">â–¼ BEARISH</div>
        <div class="chip-wrap" id="counter-chips-bear"></div>
        <div class="chip-sec-label">â–² BULLISH</div>
        <div class="chip-wrap" id="counter-chips-bull"></div>
        <div style="margin-top:12px">
          <div class="pfield"><label>ë°˜ëŒ€ìš”ì¸ ì›ë¬¸ (í•œ ë¬¸ì¥)</label>
            <textarea id="f-counter-quote" placeholder="ìë™ ì¶”ì¶œ ë˜ëŠ” ì§ì ‘ ì…ë ¥"></textarea></div>
        </div>
      </div>
    </div>
    <div class="mftr">
      <button class="mf-btn mf-parse" onclick="doParse()">ğŸ” íŒŒì‹±</button>
      <button class="mf-btn mf-save" id="btn-save" onclick="doSave()">â–¶ êµ¬ê¸€ì‹œíŠ¸ ì €ì¥</button>
      <button class="mf-close" onclick="closeModal()">ë‹«ê¸°</button>
    </div>
  </div>
</div>

<div id="toast"></div>

<script>
const GAS_URL='https://script.google.com/macros/s/AKfycbw-pDuq9xGaVmGg56lAxzV8bGLeHecSQdRK5bEpGY-_u1ibPgEHxE0eiRBxjXQSWQx7/exec';

// â”€â”€ CLOCK â”€â”€
function tick(){
  const k=new Date(Date.now()+9*3600000);
  document.getElementById('clock').textContent=
    k.toISOString().slice(0,10)+'  '+k.toISOString().slice(11,19)+' KST';
}
tick();setInterval(tick,1000);

// â”€â”€ ë‚ ì§œ í¬ë§· â”€â”€
function fmtDate(raw){
  if(!raw)return'';
  const s=String(raw).trim();
  const m=s.match(/(\d{4})[.\-\/](\d{1,2})[.\-\/](\d{1,2})/);
  if(m)return`${m[1]}.${m[2].padStart(2,'0')}.${m[3].padStart(2,'0')}`;
  if(!isNaN(s)&&s.length<6){
    const d=new Date(Math.round((parseFloat(s)-25569)*86400000));
    return d.getFullYear()+'.'+String(d.getMonth()+1).padStart(2,'0')+'.'+String(d.getDate()).padStart(2,'0');
  }
  return s.slice(0,10).replace(/-/g,'.');
}

// â”€â”€ FACTORS â”€â”€
const FACTORS=[
  {t:'bear',kr:'ë¯¸Â·ì´ë€ í•µ í˜‘ìƒ ì§„ì „',   kw:['ì´ë€',['í•©ì˜','ì§„ì „','í˜‘ìƒ']]},
  {t:'bear',kr:'ì¤‘ë™ ì§€ì •í•™ ë¦¬ìŠ¤í¬ ì™„í™”', kw:['ì¤‘ë™','ì™„í™”']},
  {t:'bear',kr:'IEA ìˆ˜ìš” ì „ë§ í•˜í–¥',      kw:['iea','í•˜í–¥']},
  {t:'bear',kr:'OPEC+ ì¦ì‚° ë…¼ì˜',         kw:['opec','ì¦ì‚°']},
  {t:'bear',kr:'ì¹´ìí í…¡ê¸°ì¦ˆ ìœ ì „ ì¬ê°œ', kw:[['í…¡ê¸°ì¦ˆ','ì¹´ìí']]},
  {t:'bear',kr:'ë¯¸ ì›ìœ  ì¬ê³  ì¦ê°€ (EIA)', kw:['ì¬ê³ ','ì¦ê°€']},
  {t:'bear',kr:'ë‹¬ëŸ¬ ê°•ì„¸',               kw:['ë‹¬ëŸ¬','ê°•ì„¸']},
  {t:'bear',kr:'ê²½ê¸°ì¹¨ì²´ ìš°ë ¤',           kw:['ê²½ê¸°ì¹¨ì²´']},
  {t:'bull',kr:'ì¤‘ë™ ê¸´ì¥ ê³ ì¡°',          kw:['ì¤‘ë™','ê¸´ì¥']},
  {t:'bull',kr:'í˜¸ë¥´ë¬´ì¦ˆ í•´í˜‘ ë¦¬ìŠ¤í¬',    kw:['í˜¸ë¥´ë¬´ì¦ˆ']},
  {t:'bull',kr:'OPEC+ ê°ì‚° ìœ ì§€Â·ê°•í™”',   kw:['opec','ê°ì‚°']},
  {t:'bull',kr:'ë¯¸ ì›ìœ  ì¬ê³  ê°ì†Œ (EIA)',  kw:['ì¬ê³ ','ê°ì†Œ']},
  {t:'bull',kr:'IEA/EIA ìˆ˜ìš” ì „ë§ ìƒí–¥',  kw:['iea','ìƒí–¥']},
  {t:'bull',kr:'ë‹¬ëŸ¬ ì•½ì„¸',               kw:['ë‹¬ëŸ¬','ì•½ì„¸']},
  {t:'bull',kr:'í•­ëª¨ ì „ë‹¨ ë°°ì¹˜',          kw:['í•­ëª¨','ì „ë‹¨']},
];

const mainSel=new Set(),counterSel=new Set();
let editKey=null,allEntries=[];

// â”€â”€ í…ìŠ¤íŠ¸ ì²˜ë¦¬ â”€â”€
function trimSent(s,max=100){
  if(!s)return'';
  s=s.replace(/^[^ê°€-í£a-zA-Z$\d"]+/,'').trim();
  if(s.length<=max)return s;
  const cut=s.lastIndexOf(' ',max);
  return(cut>60?s.slice(0,cut):s.slice(0,max))+'â€¦';
}
function splitSents(txt){
  return txt.split(/(?<=[ë‹¤ìŠµë‹ˆë‹¤ê¹Œìš”ì—ˆë‹¤]\.)\s+|(?<=ë‹¤\.\s)|(?<=\n)/)
    .map(s=>s.trim()).filter(s=>s.length>15&&s.length<300);
}
function extractMainQuote(txt){
  const ss=splitSents(txt);
  const pp=[
    /ê°€ìš´ë°.{4,80}(?:í•˜ë½|ìƒìŠ¹|ì•½ì„¸|ê°•ì„¸|ë§ˆê°|ë‚®ì•„|ë†’ì•„)/,
    /ì†Œì‹[ì´ì—].{2,60}(?:í•˜ë½|ìƒìŠ¹|ì••ë°•|ì§€ì§€|ì˜í–¥)/,
    /ë•Œë¬¸ìœ¼ë¡œ\s*ë¶„ì„/,
    /ì˜í–¥ìœ¼ë¡œ.{4,60}(?:í•˜ë½|ìƒìŠ¹|ë§ˆê°)/,
    /ìœ„í—˜\s*í”„ë¦¬ë¯¸ì—„.{0,40}(?:ì•½í•´|ê°•í•´|ë‚®ì•„|ë†’ì•„)/,
    /(?:í•˜ë½|ìƒìŠ¹)ì„¸ë¥¼\s*ë³´ì˜€/,
  ];
  for(const p of pp){const f=ss.find(s=>p.test(s));if(f)return trimSent(f);}
  return null;
}
function extractCounterQuote(txt,idxSet){
  if(!idxSet.size)return null;
  const ss=splitSents(txt);
  const kws=[...idxSet].flatMap(i=>FACTORS[i].kw.flat().filter(k=>typeof k==='string'));
  for(const kw of kws){const f=ss.find(s=>s.includes(kw));if(f)return trimSent(f);}
  return null;
}
function autoDetect(txt,direction){
  const lo=txt.toLowerCase();mainSel.clear();counterSel.clear();
  FACTORS.forEach((f,i)=>{
    const hit=f.kw.every(k=>Array.isArray(k)?k.some(kk=>lo.includes(kk)):lo.includes(k));
    if(!hit)return;
    if(direction==='í•˜ë½'&&f.t==='bear')mainSel.add(i);
    else if(direction==='ìƒìŠ¹'&&f.t==='bull')mainSel.add(i);
    else counterSel.add(i);
  });
}
function buildCommentary(wti,pct,abs,direction){
  const ps=(pct>=0?'+':'')+pct.toFixed(2)+'%';
  const as=abs!==null?`${abs>=0?'+':''}${abs.toFixed(2)} USD, `:'';
  const mArr=[...mainSel].map(i=>FACTORS[i].kr);
  const cArr=[...counterSel].map(i=>FACTORS[i].kr);
  let t=`WTI ì›ìœ ëŠ” ë°°ëŸ´ë‹¹ $${wti.toFixed(2)} (${as}${ps})ë¡œ ${direction} ë§ˆê°.`;
  if(mArr.length)t+=` ${mArr.slice(0,2).join(', ')} ë“±ì´ ì£¼ìš” ${direction} ìš”ì¸ìœ¼ë¡œ ì‘ìš©.`;
  if(cArr.length)t+=` ë‹¤ë§Œ ${cArr[0]} ë“±ì€ ${direction==='í•˜ë½'?'ë‚™í­':'ìƒìŠ¹í­'}ì„ ì œí•œ.`;
  return t;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  rowToEntry â€” ì»¬ëŸ¼ ì¸ë±ìŠ¤ ìë™ ê°ì§€
//  ì‹œíŠ¸ì— ìˆœë²ˆ(Cì—´) ìˆìœ¼ë©´ 12ì»¬ëŸ¼, ì—†ìœ¼ë©´ 11ì»¬ëŸ¼
//  r[2]ê°€ ìˆ«ì(ìˆœë²ˆ)ì´ë©´ ìƒˆ êµ¬ì¡°, ë¬¸ìì—´ì´ë©´ êµ¬ë²„ì „
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function rowToEntry(r){
  // r[2]ê°€ ìˆœë²ˆ(ìˆ«ì)ì¸ì§€ WTIê°€ê²©(ìˆ«ì)ì¸ì§€ íŒë³„
  // ìˆœë²ˆì€ ë³´í†µ 1~10, WTIê°€ê²©ì€ 50~120 ì‚¬ì´
  const r2=parseFloat(r[2]);
  const hasSeqCol = !isNaN(r2) && r2 < 30; // 30 ë¯¸ë§Œì´ë©´ ìˆœë²ˆìœ¼ë¡œ íŒë‹¨

  if(hasSeqCol){
    // ìƒˆ êµ¬ì¡°: Aê¸°ì¤€ì¼ Bì›”ë¬¼ Cìˆœë²ˆ Dê°€ê²© Eì „ì¼ë¹„ Fë³€ë™ë¥  Gë°©í–¥ Hì£¼ìš”ì¸ Iì£¼ìš”ì¸ì›ë¬¸ Jì½”ë©˜í„°ë¦¬ Kë°˜ëŒ€ìš”ì¸ Lë°˜ëŒ€ìš”ì¸ì›ë¬¸
    return{
      date:           fmtDate(r[0]),
      contract:       String(r[1]||'').trim(),
      seq:            parseInt(r[2])||1,
      wti:            parseFloat(r[3])||0,
      abs:            (r[4]!==''&&r[4]!=null)?parseFloat(r[4]):null,
      pct:            parseFloat(r[5])||0,
      direction:      String(r[6]||'').trim(),
      mainFactors:    String(r[7]||'').trim(),
      mainQuote:      String(r[8]||'').trim(),
      commentary:     String(r[9]||'').trim(),
      counterFactors: String(r[10]||'').trim(),
      counterQuote:   String(r[11]||'').trim(),
    };
  } else {
    // êµ¬ë²„ì „: Aê¸°ì¤€ì¼ Bì›”ë¬¼ Cê°€ê²© Dì „ì¼ë¹„ Eë³€ë™ë¥  Fë°©í–¥ Gì£¼ìš”ì¸ Hì£¼ìš”ì¸ì›ë¬¸ Iì½”ë©˜í„°ë¦¬ Jë°˜ëŒ€ìš”ì¸ Kë°˜ëŒ€ìš”ì¸ì›ë¬¸
    return{
      date:           fmtDate(r[0]),
      contract:       String(r[1]||'').trim(),
      seq:            1,
      wti:            parseFloat(r[2])||0,
      abs:            (r[3]!==''&&r[3]!=null)?parseFloat(r[3]):null,
      pct:            parseFloat(r[4])||0,
      direction:      String(r[5]||'').trim(),
      mainFactors:    String(r[6]||'').trim(),
      mainQuote:      String(r[7]||'').trim(),
      commentary:     String(r[8]||'').trim(),
      counterFactors: String(r[9]||'').trim(),
      counterQuote:   String(r[10]||'').trim(),
    };
  }
}

// â”€â”€ LOAD â”€â”€
async function loadData(){
  document.getElementById('loading').style.display='block';
  document.getElementById('cards').innerHTML='';
  document.getElementById('empty').style.display='none';
  document.getElementById('sb-result').textContent='';
  try{
    const res=await fetch(GAS_URL+'?t='+Date.now());
    const json=await res.json();
    if(!json.success)throw new Error(json.message);
    allEntries=(json.data||[]).slice(1).map(rowToEntry).filter(e=>e.date&&e.wti>0);
    renderAll();
  }catch(e){
    toast('âŒ ë¡œë“œ ì‹¤íŒ¨: '+e.message,'err');
    document.getElementById('empty').style.display='block';
  }finally{
    document.getElementById('loading').style.display='none';
  }
}

// â”€â”€ ê²€ìƒ‰ â”€â”€
function doSearch(){
  const v=document.getElementById('sb-date').value;
  if(!v){clearSearch();return;}
  const fmted=fmtDate(v);
  const filtered=allEntries.filter(e=>e.date===fmted);
  renderEntries(filtered);
  document.getElementById('sb-clear').style.display='';
  document.getElementById('sb-result').textContent=
    filtered.length?`${fmted} Â· ${filtered.length}ê±´`:`${fmted} â€” ê²°ê³¼ ì—†ìŒ`;
}
function clearSearch(){
  document.getElementById('sb-date').value='';
  document.getElementById('sb-clear').style.display='none';
  document.getElementById('sb-result').textContent='';
  renderAll();
}
function renderAll(){renderEntries(allEntries);}

// â”€â”€ ê·¸ë£¹ ë Œë” â”€â”€
function renderEntries(entries){
  if(!entries.length){
    document.getElementById('empty').style.display='block';
    document.getElementById('cards').innerHTML='';
    return;
  }
  document.getElementById('empty').style.display='none';
  const groups={};
  [...entries].reverse().forEach(e=>{
    const key=e.date+'__'+e.contract;
    if(!groups[key])groups[key]=[];
    groups[key].push(e);
  });
  Object.values(groups).forEach(g=>g.sort((a,b)=>a.seq-b.seq));
  const sortedKeys=Object.keys(groups).sort((a,b)=>{
    return b.split('__')[0].localeCompare(a.split('__')[0]);
  });
  document.getElementById('cards').innerHTML=sortedKeys.map(k=>renderGroup(groups[k])).join('');
}

function buildTags(factors){
  if(!factors||!factors.trim())return'';
  return factors.split(',').filter(s=>s.trim()).map(kr=>{
    const f=FACTORS.find(x=>x.kr===kr.trim());
    return`<span class="factor-tag ${f?f.t:'dim'}">${kr.trim()}</span>`;
  }).join('');
}

function renderFactPanel(e,dir,dirTxt){
  const mainTags=buildTags(e.mainFactors);
  const counterTags=buildTags(e.counterFactors);
  const hasBody=mainTags||e.mainQuote||counterTags||e.counterQuote;
  if(!hasBody)return'';
  return`<div class="brief-facts">
    <div class="fact-col">
      <div class="fact-col-title">
        <span class="fc-dot ${dir==='up'?'bull':'bear'}"></span>ì£¼ìš”ì¸ Â· ${dirTxt}
      </div>
      ${mainTags?`<div class="factor-tags">${mainTags}</div>`:'<div class="fact-empty">ê°ì§€ëœ ì£¼ìš”ì¸ ì—†ìŒ</div>'}
      ${e.mainQuote?`<div class="source-quote"><div class="sq-label">ğŸ“° ì›ë¬¸ ì°¸ê³ </div><div class="sq-text">${e.mainQuote}</div></div>`:''}
    </div>
    <div class="fact-col">
      <div class="fact-col-title counter">
        <span class="fc-dot dim"></span>ë°˜ëŒ€ìš”ì¸ Â· ì œí•œì  ì˜í–¥
      </div>
      ${counterTags?`<div class="factor-tags">${counterTags}</div>`:'<div class="fact-empty">ë°˜ëŒ€ìš”ì¸ ì—†ìŒ</div>'}
      ${e.counterQuote?`<div class="source-quote counter"><div class="sq-label">ğŸ“° ë°˜ëŒ€ìš”ì¸ ì›ë¬¸</div><div class="sq-text">${e.counterQuote}</div></div>`:''}
    </div>
  </div>`;
}

function renderGroup(group){
  const p=group[0];
  const extras=group.slice(1);
  const dir=p.pct>0?'up':p.pct<0?'dn':'flt';
  const arrow=p.pct>0?'â–²':p.pct<0?'â–¼':'â”€';
  const dirTxt=p.direction||(p.pct>0?'ìƒìŠ¹':p.pct<0?'í•˜ë½':'ë³´í•©');
  const pctStr=(p.pct>=0?'+':'')+p.pct.toFixed(2)+'%';
  const absStr=p.abs!=null?(p.abs>=0?'+':'')+p.abs.toFixed(2)+' USD':'';
  const cardId='card-'+p.date.replace(/\./g,'-')+'-'+p.contract;
  const eJson=encodeURIComponent(JSON.stringify(p));

  let html=`<div class="brief dir-${dir}" id="${cardId}">

    <div class="brief-header">
      <div class="bh-date">
        <div class="bh-date-val">${p.date}</div>
        <div class="bh-date-cont">NYMEX Â· ${p.contract}ì›”ë¬¼</div>
      </div>
      <div class="bh-price">
        <div class="bh-arrow ${dir}">${arrow}</div>
        <div class="bh-price-block">
          <div class="bh-price-label">WTI ì¢…ê°€</div>
          <div class="bh-val ${dir}">${p.wti.toFixed(2)}</div>
        </div>
        <div class="bh-unit">USD<br>/ bbl</div>
      </div>
      <div class="bh-delta">
        ${absStr?`<div class="bh-d-row"><span class="bh-d-label">Î”$</span><span class="bh-d-val ${dir}">${absStr}</span></div>`:''}
        <div class="bh-d-row"><span class="bh-d-label">Î”%</span><span class="bh-d-val ${dir}">${pctStr}</span></div>
      </div>
      <div class="bh-dir">
        <div class="bh-dir-badge ${dir}">${dirTxt}</div>
        <div class="bh-dir-label">direction</div>
      </div>
      <div class="bh-actions">
        <button class="act-btn edit" onclick="openModal(JSON.parse(decodeURIComponent('${eJson}')))">âœ EDIT</button>
        <button class="act-btn del" onclick="deleteEntry('${p.date}','${p.contract}',1)">âœ• DEL</button>
      </div>
    </div>

    ${renderFactPanel(p,dir,dirTxt)}

    ${p.commentary?`<div class="brief-commentary">
      <div class="co-label">ì½”ë©˜í„°ë¦¬ Â· ì†ŒìŠ¤ 1</div>
      <div class="co-text">${p.commentary}</div>
    </div>`:''}

    <div class="brief-copy">
      <button class="cp-btn img" onclick="downloadImage('${cardId}','${p.date}')">â¬‡ ì´ë¯¸ì§€</button>
      <button class="cp-btn" onclick="copyText('${cardId}')">Copy</button>
    </div>`;

  if(extras.length>0){
    const accId='acc-'+cardId;
    html+=`<button class="accordion-toggle" onclick="toggleAcc('${accId}')">
      <span class="at-label">+ ì¶”ê°€ íŒŒì‹± ì†ŒìŠ¤ ${extras.length}ê°œ ë³´ê¸°</span>
      <span class="at-arrow" id="arr-${accId}">â–¼</span>
    </button>
    <div class="accordion-body" id="${accId}">`;

    extras.forEach(ex=>{
      const exJson=encodeURIComponent(JSON.stringify(ex));
      const exCardId=cardId+'-s'+ex.seq;
      html+=`<div class="brief sub-source" id="${exCardId}">
        <div class="source-header">
          <span class="src-badge">ì†ŒìŠ¤ ${ex.seq}</span>
          <div class="src-actions">
            <button class="src-act-btn edit" onclick="openModal(JSON.parse(decodeURIComponent('${exJson}')))">âœ EDIT</button>
            <button class="src-act-btn del" onclick="deleteEntry('${ex.date}','${ex.contract}',${ex.seq})">âœ• DEL</button>
          </div>
        </div>
        ${renderFactPanel(ex,dir,dirTxt)}
        ${ex.commentary?`<div class="brief-commentary">
          <div class="co-label">ì½”ë©˜í„°ë¦¬ Â· ì†ŒìŠ¤ ${ex.seq}</div>
          <div class="co-text">${ex.commentary}</div>
        </div>`:''}
        <div class="brief-copy">
          <button class="cp-btn" onclick="copyText('${exCardId}')">Copy</button>
        </div>
      </div>`;
    });
    html+=`</div>`;
  }

  html+=`</div>`;
  return`<div class="date-group">${html}</div>`;
}

function toggleAcc(id){
  document.getElementById(id).classList.toggle('open');
  const arr=document.getElementById('arr-'+id);
  if(arr)arr.classList.toggle('open');
}

// â”€â”€ MODAL â”€â”€
function openModal(entryForEdit=null){
  editKey=null;mainSel.clear();counterSel.clear();
  document.getElementById('modal-title').textContent=entryForEdit?'â—ˆ EDIT ENTRY':'â—ˆ NEW WTI ENTRY';
  document.getElementById('news-ta').value='';
  document.getElementById('parse-st').style.display='none';
  document.getElementById('parsed-wrap').style.display='none';
  document.getElementById('step-factors').style.display='none';
  document.getElementById('btn-save').style.display='none';
  const today=new Date(Date.now()+9*3600000).toISOString().slice(0,10);
  document.getElementById('f-date').value=today;
  document.getElementById('f-cont').value='Mar';
  ['f-wti','f-abs','f-pct','f-commentary','f-main-quote','f-counter-quote']
    .forEach(id=>document.getElementById(id).value='');
  if(entryForEdit){
    editKey={date:entryForEdit.date,contract:entryForEdit.contract,seq:entryForEdit.seq||1};
    document.getElementById('f-wti').value          =entryForEdit.wti;
    document.getElementById('f-abs').value          =entryForEdit.abs??'';
    document.getElementById('f-pct').value          =entryForEdit.pct;
    document.getElementById('f-date').value         =entryForEdit.date.replace(/\./g,'-');
    document.getElementById('f-cont').value         =entryForEdit.contract;
    document.getElementById('f-commentary').value   =entryForEdit.commentary;
    document.getElementById('f-main-quote').value   =entryForEdit.mainQuote;
    document.getElementById('f-counter-quote').value=entryForEdit.counterQuote;
    entryForEdit.mainFactors.split(',').map(s=>s.trim()).forEach(kr=>{
      const idx=FACTORS.findIndex(f=>f.kr===kr);if(idx>=0)mainSel.add(idx);
    });
    entryForEdit.counterFactors.split(',').map(s=>s.trim()).forEach(kr=>{
      const idx=FACTORS.findIndex(f=>f.kr===kr);if(idx>=0)counterSel.add(idx);
    });
    document.getElementById('parsed-wrap').style.display='block';
    document.getElementById('step-factors').style.display='block';
    document.getElementById('btn-save').style.display='block';
  }
  buildChips();
  document.getElementById('overlay').classList.add('open');
}
function closeModal(){document.getElementById('overlay').classList.remove('open');}
document.addEventListener('keydown',e=>{if(e.key==='Escape')closeModal();});
document.getElementById('overlay').addEventListener('click',e=>{
  if(e.target===document.getElementById('overlay'))closeModal();
});
function buildChips(){
  buildChipGroup('main-chips-bear',mainSel,'bear');
  buildChipGroup('main-chips-bull',mainSel,'bull');
  buildChipGroup('counter-chips-bear',counterSel,'bear');
  buildChipGroup('counter-chips-bull',counterSel,'bull');
}
function buildChipGroup(cid,selSet,tf){
  const c=document.getElementById(cid);c.innerHTML='';
  FACTORS.forEach((f,i)=>{
    if(f.t!==tf)return;
    const ch=document.createElement('div');
    ch.className='chip'+(selSet.has(i)?` sel-${f.t}`:'');
    ch.textContent=f.kr;
    ch.addEventListener('click',()=>{
      if(selSet.has(i)){selSet.delete(i);ch.className='chip';}
      else{selSet.add(i);ch.className=`chip sel-${f.t}`;}
    });
    c.appendChild(ch);
  });
}

// â”€â”€ PARSE â”€â”€
function doParse(){
  const txt=document.getElementById('news-ta').value.trim();
  if(!txt){
    document.getElementById('parsed-wrap').style.display='block';
    document.getElementById('step-factors').style.display='block';
    document.getElementById('btn-save').style.display='block';
    buildChips();showStatus('warn','í…ìŠ¤íŠ¸ ì—†ìŒ â€” ìˆ˜ë™ ì…ë ¥ ëª¨ë“œ');return;
  }
  const f={};let m;
  m=txt.match(/(?:í•˜ë½í•œ|ì˜¤ë¥¸|ë°€ë¦°|ë‚´ë¦°)\s*ë°°ëŸ´ë‹¹\s*([\d.]+)ë‹¬ëŸ¬/);if(m)f.wti=parseFloat(m[1]);
  if(!f.wti){m=txt.match(/ë°°ëŸ´ë‹¹\s*[\d.]+%\s*(?:í•˜ë½í•œ|ìƒìŠ¹í•œ|ì˜¤ë¥¸)\s*([\d.]+)ë‹¬ëŸ¬/);if(m)f.wti=parseFloat(m[1]);}
  if(!f.wti){m=txt.match(/ë°°ëŸ´ë‹¹\s*([\d.]+)ë‹¬ëŸ¬ì—\s*(?:ê±°ë˜|ë§ˆê°|ì²´ê²°)/);if(m)f.wti=parseFloat(m[1]);}
  const ws=(txt.match(/(?:WTI|ì„œë¶€í…ì‚¬ìŠ¤|í…ì‚¬ìŠ¤ì‚°ì›ìœ )[^\nã€‚]{0,250}/)||[''])[0];
  m=ws.match(/([\d.]+)ë‹¬ëŸ¬\(([\d.]+)%\)\s*(?:í•˜ë½|ë‚´ë¦°|ë°€ë¦°|ë–¨ì–´ì§„)/);
  if(m){f.abs=-parseFloat(m[1]);f.pct=-parseFloat(m[2]);}
  if(!f.abs){m=txt.match(/([\d.]+)ë‹¬ëŸ¬\(([\d.]+)%\)\s*(?:í•˜ë½|ë‚´ë¦°|ë°€ë¦°|ë–¨ì–´ì§„)/);if(m){f.abs=-parseFloat(m[1]);f.pct=-parseFloat(m[2]);}}
  if(!f.abs){m=ws.match(/([\d.]+)ë‹¬ëŸ¬\(([\d.]+)%\)\s*(?:ìƒìŠ¹|ì˜¤ë¥¸|ì˜¬ë¼)/);if(m){f.abs=parseFloat(m[1]);f.pct=parseFloat(m[2]);}}
  if(!f.pct){m=txt.match(/ë°°ëŸ´ë‹¹\s*([\d.]+)%\s*(í•˜ë½|ìƒìŠ¹)/);if(m)f.pct=m[2]==='í•˜ë½'?-parseFloat(m[1]):parseFloat(m[1]);}
  if(!f.abs&&f.wti&&f.pct){const p=f.wti/(1+f.pct/100);f.abs=parseFloat((f.wti-p).toFixed(2));}

  // ì›”ë¬¼
  const contM=txt.match(/(3|4|5|6)ì›”\s*(?:ì¸ë„ë¶„|ë¬¼)/);
  if(contM){const map={'3':'Mar','4':'Apr','5':'May','6':'Jun'};document.getElementById('f-cont').value=map[contM[1]]||'Mar';}

  // â”€â”€ ë‚ ì§œ íŒŒì‹± (ê¸°ì‚¬ ë‚´ ì—°ì›” ê¸°ì¤€) â”€â”€
  let articleYear=null,articleMonth=null;
  const ymM=txt.match(/(\d{4})[ë…„.\-\/]\s*(\d{1,2})[ì›”.\-\/]/);
  if(ymM){articleYear=parseInt(ymM[1]);articleMonth=parseInt(ymM[2]);}

  // ìš°ì„ ìˆœìœ„1: "Nì¼ ì†Œí­ í•˜ë½/ìƒìŠ¹/ë§ˆê°/ê±°ë˜" â†’ ê±°ë˜ì¼ ì§ì ‘ ì–¸ê¸‰
  const tradeDayM=txt.match(/(\d{1,2})ì¼\s+(?:ì†Œí­\s*)?(?:í•˜ë½|ìƒìŠ¹|ë§ˆê°|ê±°ë˜|ì²´ê²°|ëŒì•„)/);
  if(tradeDayM&&articleYear&&articleMonth){
    const day=parseInt(tradeDayM[1]);
    document.getElementById('f-date').value=
      `${articleYear}-${String(articleMonth).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
  } else {
    // ìš°ì„ ìˆœìœ„2: "Nì¼(í˜„ì§€ì‹œê°„)" â†’ ê¸°ì‚¬ ë‚´ ì—°ì›” ê¸°ì¤€ +1
    const localM=txt.match(/(\d{1,2})ì¼\s*\(í˜„ì§€ì‹œê°„\)/);
    if(localM&&articleYear&&articleMonth){
      let day=parseInt(localM[1])+1;
      let mo=articleMonth,yr=articleYear;
      const maxDay=new Date(yr,mo,0).getDate();
      if(day>maxDay){day=1;mo=mo%12+1;if(mo===1)yr++;}
      document.getElementById('f-date').value=
        `${yr}-${String(mo).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
    } else {
      // ìš°ì„ ìˆœìœ„3: ì—°ì›”ì¼ ì§ì ‘ ëª…ì‹œ
      const fullDM=txt.match(/(\d{4})[ë…„.\-\/]\s*(\d{1,2})[ì›”.\-\/]\s*(\d{1,2})[ì¼]?/);
      if(fullDM)document.getElementById('f-date').value=
        `${fullDM[1]}-${fullDM[2].padStart(2,'0')}-${fullDM[3].padStart(2,'0')}`;
    }
  }

  if(f.wti)document.getElementById('f-wti').value=f.wti.toFixed(2);
  if(f.abs!=null)document.getElementById('f-abs').value=f.abs.toFixed(2);
  if(f.pct!=null)document.getElementById('f-pct').value=f.pct.toFixed(2);

  const direction=(f.pct??0)>0?'ìƒìŠ¹':(f.pct??0)<0?'í•˜ë½':'ë³´í•©';
  autoDetect(txt,direction);
  const mainQuote=extractMainQuote(txt);
  const counterQuote=extractCounterQuote(txt,counterSel);
  if(mainQuote)document.getElementById('f-main-quote').value=mainQuote;
  if(counterQuote)document.getElementById('f-counter-quote').value=counterQuote;
  if(f.wti&&f.pct!=null)
    document.getElementById('f-commentary').value=buildCommentary(f.wti,f.pct,f.abs??null,direction);

  document.getElementById('parsed-wrap').style.display='block';
  document.getElementById('step-factors').style.display='block';
  document.getElementById('btn-save').style.display='block';
  buildChips();

  const ok=f.wti&&f.pct!=null;
  const bits=[];
  if(ok)bits.push(`âœ“ WTI $${f.wti.toFixed(2)} (${f.pct>=0?'+':''}${f.pct.toFixed(2)}%)`);
  bits.push(`ì£¼ìš”ì¸ ${mainSel.size}ê°œ`);
  if(counterSel.size)bits.push(`ë°˜ëŒ€ìš”ì¸ ${counterSel.size}ê°œ`);
  if(mainQuote)bits.push('ì£¼ìš”ì¸ ì›ë¬¸');
  if(counterQuote)bits.push('ë°˜ëŒ€ìš”ì¸ ì›ë¬¸');
  bits.push('ì½”ë©˜í„°ë¦¬ ìƒì„±');
  showStatus(ok?'ok':'warn',bits.join(' Â· '));
}

function showStatus(t,m){const el=document.getElementById('parse-st');el.style.display='block';el.className=`parse-status ${t}`;el.textContent=m;}
function autoPct(){
  const wti=parseFloat(document.getElementById('f-wti').value);
  const abs=parseFloat(document.getElementById('f-abs').value);
  if(wti&&!isNaN(abs)&&wti-abs>0)document.getElementById('f-pct').value=(abs/(wti-abs)*100).toFixed(2);
}

// â”€â”€ SAVE â”€â”€
async function doSave(){
  const wti=parseFloat(document.getElementById('f-wti').value);
  const pct=parseFloat(document.getElementById('f-pct').value);
  const dateRaw=document.getElementById('f-date').value;
  if(!dateRaw||isNaN(wti)||isNaN(pct)){showStatus('err','ê¸°ì¤€ì¼, WTI ì¢…ê°€, ë³€ë™ë¥ ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.');return;}
  const date=fmtDate(dateRaw);
  const abs=parseFloat(document.getElementById('f-abs').value)||null;
  const cont=document.getElementById('f-cont').value;
  const direction=pct>0?'ìƒìŠ¹':pct<0?'í•˜ë½':'ë³´í•©';
  const mainArr=[];mainSel.forEach(i=>mainArr.push(FACTORS[i].kr));
  const counterArr=[];counterSel.forEach(i=>counterArr.push(FACTORS[i].kr));
  const data={
    date,contract:cont,wti,abs:abs!==null?abs:'',pct,direction,
    mainFactors:mainArr.join(', '),
    mainQuote:document.getElementById('f-main-quote').value.trim(),
    commentary:document.getElementById('f-commentary').value.trim(),
    counterFactors:counterArr.join(', '),
    counterQuote:document.getElementById('f-counter-quote').value.trim(),
  };
  const btn=document.getElementById('btn-save');
  btn.textContent='ì €ì¥ ì¤‘...';btn.disabled=true;
  try{
    const res=await fetch(GAS_URL,{method:'POST',headers:{'Content-Type':'text/plain'},
      body:JSON.stringify({action:editKey?'edit':'save',rowKey:editKey,data})});
    const r=await res.json();
    if(r.success){toast('âœ… '+r.message,'ok');closeModal();await loadData();}
    else toast('âŒ '+r.message,'err');
  }catch(e){toast('âŒ ì˜¤ë¥˜: '+e.message,'err');}
  finally{btn.textContent='â–¶ êµ¬ê¸€ì‹œíŠ¸ ì €ì¥';btn.disabled=false;}
}

// â”€â”€ DELETE â”€â”€
async function deleteEntry(date,contract,seq){
  if(!confirm(`${date} ${contract} ì†ŒìŠ¤${seq} í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`))return;
  try{
    const res=await fetch(GAS_URL,{method:'POST',headers:{'Content-Type':'text/plain'},
      body:JSON.stringify({action:'delete',rowKey:{date,contract,seq}})});
    const r=await res.json();
    if(r.success){toast('ğŸ—‘ '+r.message,'ok');await loadData();}
    else toast('âŒ '+r.message,'err');
  }catch(e){toast('âŒ ì˜¤ë¥˜: '+e.message,'err');}
}

// â”€â”€ COPY â”€â”€
function copyText(cardId){
  const el=document.querySelector(`#${cardId} .co-text`);
  if(!el)return;
  navigator.clipboard.writeText(el.textContent.trim()).then(()=>{
    const btn=document.querySelector(`#${cardId} .cp-btn:not(.img)`);
    if(btn){btn.classList.add('ok');btn.textContent='âœ“ Copied';
      setTimeout(()=>{btn.classList.remove('ok');btn.textContent='Copy';},1800);}
  });
}

// â”€â”€ IMAGE â”€â”€
async function downloadImage(cardId,date){
  const el=document.getElementById(cardId);if(!el)return;
  const btn=el.querySelector('.cp-btn.img');
  if(btn){btn.textContent='ìº¡ì²˜ ì¤‘...';btn.disabled=true;}
  try{
    const canvas=await html2canvas(el,{backgroundColor:'#1a1d25',scale:2,useCORS:true,logging:false});
    const a=document.createElement('a');
    a.download=`WTI_${date}.png`;a.href=canvas.toDataURL('image/png');a.click();
    toast('âœ… ì´ë¯¸ì§€ ì €ì¥ë¨','ok');
  }catch(e){toast('âŒ ì´ë¯¸ì§€ ì˜¤ë¥˜: '+e.message,'err');}
  finally{if(btn){btn.textContent='â¬‡ ì´ë¯¸ì§€';btn.disabled=false;}}
}

// â”€â”€ TOAST â”€â”€
function toast(msg,type='inf',ms=3200){
  const t=document.getElementById('toast');
  t.textContent=msg;t.className=`show ${type}`;
  clearTimeout(t._t);t._t=setTimeout(()=>t.className='',ms);
}

loadData();
</script>
</body>
</html>
