<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WTI MORNING CHECK | JS KIM</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
:root {
  --primary: #0A2647;
  --accent:  #1597BB;
  --green:   #27ae60;
  --red:     #E74C3C;
  --orange:  #D35400;
  --gold:    #FFD700;
}
body { background:#f0f2f5; font-family:'Pretendard','Segoe UI',sans-serif; min-height:100vh; margin:0; }

/* â”€â”€ TOP BAR â”€â”€ */
.top-bar { background:var(--primary); padding:16px 28px; display:flex; align-items:center; justify-content:space-between; box-shadow:0 3px 15px rgba(0,0,0,.25); }
.top-bar .brand { font-size:.95rem; font-weight:900; color:var(--gold); letter-spacing:.05em; }
.top-bar .sub   { font-size:.65rem; color:rgba(255,255,255,.5); margin-top:2px; }
.btn-input-top  { background:var(--accent); color:white; border:none; padding:9px 18px; border-radius:20px; font-weight:900; font-size:.78rem; cursor:pointer; transition:background .2s; display:flex; align-items:center; gap:7px; }
.btn-input-top:hover { background:#0d86a8; }

/* â”€â”€ PAGE â”€â”€ */
.page-wrap { max-width:860px; margin:32px auto; padding:0 20px 80px; }

/* â”€â”€ HISTORY CARDS â”€â”€ */
.hcard { background:white; border-radius:14px; padding:22px 26px; box-shadow:0 6px 22px rgba(0,0,0,.07); margin-bottom:14px; border-left:5px solid #dee2e6; }
.hcard.up  { border-left-color:var(--green); }
.hcard.dn  { border-left-color:var(--red); }
.hcard.flt { border-left-color:#aaa; }

.hcard-top { display:flex; align-items:flex-start; justify-content:space-between; margin-bottom:14px; }
.hcard-date { font-size:1rem; font-weight:900; color:var(--primary); }
.hcard-sub  { font-size:.65rem; color:#bbb; margin-top:2px; }

.price-badge { display:inline-flex; align-items:baseline; gap:6px; padding:6px 14px; border-radius:20px; font-weight:900; flex-shrink:0; }
.price-badge.up  { background:#e8f8f0; color:#1e8449; }
.price-badge.dn  { background:#fce8e8; color:#c0392b; }
.price-badge.flt { background:#f0f0f0; color:#666; }
.price-badge .pv { font-size:1.15rem; }
.price-badge .pc { font-size:.78rem; }

.row-item { display:flex; border-bottom:1px solid #f5f5f5; padding:8px 0; align-items:flex-start; }
.row-item:last-child { border-bottom:none; }
.rl { width:110px; flex-shrink:0; font-size:.72rem; color:#aaa; font-weight:700; padding-top:2px; }
.rv { font-size:.86rem; color:#2d3436; font-weight:500; word-break:break-word; }
.rv.hi { color:var(--accent); font-weight:900; }
.cmt-box { background:#f8fafc; border-radius:8px; padding:10px 12px; border-left:4px solid #dee2e6; font-size:.78rem; color:#555; line-height:1.65; width:100%; margin-top:4px; }

.factor-tags { display:flex; flex-wrap:wrap; gap:5px; }
.ftag { display:inline-block; padding:3px 10px; border-radius:12px; font-size:.7rem; font-weight:700; }
.ftag.bear { background:#fce8e8; color:#c0392b; }
.ftag.bull { background:#e8f8f0; color:#1e8449; }

#empty-msg { text-align:center; padding:55px; color:#ccc; font-size:.9rem; }

/* â”€â”€ MODAL â”€â”€ */
#overlay { position:fixed; inset:0; background:rgba(5,20,50,.88); z-index:9000; display:none; align-items:center; justify-content:center; backdrop-filter:blur(5px); }
#overlay.open { display:flex; }
#modal { width:680px; max-height:94vh; background:white; border-radius:18px; box-shadow:0 24px 70px rgba(0,0,0,.5); display:flex; flex-direction:column; overflow:hidden; animation:mIn .22s ease; }
@keyframes mIn { from{opacity:0;transform:translateY(18px) scale(.97)} to{opacity:1;transform:none} }

.mhead { background:var(--primary); color:white; padding:16px 22px; display:flex; justify-content:space-between; align-items:center; flex-shrink:0; }
.mhead h3 { margin:0; font-size:.95rem; font-weight:900; }
.mhead .ver { background:var(--accent); font-size:.6rem; padding:3px 9px; border-radius:9px; font-weight:900; }

.mbody { padding:18px 22px; overflow-y:auto; flex:1; }
.mlabel { font-size:.65rem; font-weight:900; color:#aaa; text-transform:uppercase; letter-spacing:.1em; display:block; margin-bottom:7px; }

#news-input { width:100%; height:180px; border:2px solid #e2e8f0; border-radius:10px; padding:12px; font-size:.78rem; font-family:'Segoe UI',sans-serif; resize:vertical; line-height:1.72; color:#333; transition:border-color .2s; box-sizing:border-box; }
#news-input:focus { outline:none; border-color:var(--accent); }
#news-input::placeholder { color:#c5c9d0; line-height:1.9; }

/* íŒŒì‹± ê²°ê³¼ ê·¸ë¦¬ë“œ */
#pv-wrap { display:none; margin-top:16px; border:1.5px solid #e2e8f0; border-radius:12px; overflow:hidden; }
.pv-head { background:#f0f5f9; padding:10px 14px; font-size:.67rem; font-weight:900; color:var(--primary); border-bottom:1px solid #e2e8f0; display:flex; justify-content:space-between; align-items:center; }
.pbadge { font-size:.63rem; padding:3px 9px; border-radius:7px; font-weight:900; }
.pb-ok   { background:#d4efdf; color:#1e8449; }
.pb-warn { background:#fdebd0; color:#d35400; }

.pg { display:grid; grid-template-columns:1fr 1fr; }
.pf { padding:10px 14px; border-bottom:1px solid #f2f2f2; border-right:1px solid #f2f2f2; }
.pf:nth-child(2n) { border-right:none; }
.pf.full { grid-column:1/-1; border-right:none; }
.pf.price-ok   { background:linear-gradient(135deg,#eaf5fb,#d4edf5); border:1.5px solid var(--accent); }
.pl { font-size:.56rem; color:#bbb; text-transform:uppercase; font-weight:800; letter-spacing:.08em; }
.pv-input { width:100%; border:1.5px solid #e2e8f0; border-radius:7px; padding:6px 9px; font-size:.83rem; font-weight:700; color:#1a1a2e; background:white; box-sizing:border-box; transition:border-color .2s; }
.pv-input:focus { outline:none; border-color:var(--accent); }
.pv-input.hi { color:var(--accent); }
.pv-input.up { color:var(--green); }
.pv-input.dn { color:var(--red); }
select.pv-input { cursor:pointer; }

/* ìš”ì¸ ì²´í¬ë¦¬ìŠ¤íŠ¸ */
.factor-section { padding:10px 14px; border-bottom:1px solid #f2f2f2; grid-column:1/-1; }
.factor-section-title { font-size:.58rem; font-weight:900; color:#aaa; text-transform:uppercase; letter-spacing:.1em; margin-bottom:8px; display:flex; align-items:center; gap:6px; }
.factor-section-title .dot { width:8px; height:8px; border-radius:50%; }
.chip-grid { display:flex; flex-wrap:wrap; gap:5px; }
.fchip { padding:4px 11px; border-radius:14px; font-size:.72rem; font-weight:700; border:1.5px solid #e2e8f0; color:#999; cursor:pointer; transition:all .12s; user-select:none; }
.fchip:hover { border-color:#ccc; color:#666; }
.fchip.sel-bear { background:#fce8e8; border-color:#e74c3c; color:#c0392b; }
.fchip.sel-bull { background:#e8f8f0; border-color:#27ae60; color:#1e8449; }

/* ì½”ë©˜í„°ë¦¬ ì¶œë ¥ */
.commentary-out { display:none; margin-top:14px; border:1.5px solid #e2e8f0; border-radius:12px; overflow:hidden; }
.co-head { background:#f0f5f9; padding:10px 14px; font-size:.67rem; font-weight:900; color:var(--primary); border-bottom:1px solid #e2e8f0; display:flex; justify-content:space-between; align-items:center; }
.co-grid { display:grid; grid-template-columns:1fr 1fr; }
.co-pane { display:flex; flex-direction:column; border-right:1px solid #f2f2f2; }
.co-pane:last-child { border-right:none; }
.co-pane-label { font-size:.58rem; font-weight:900; color:#aaa; text-transform:uppercase; letter-spacing:.1em; padding:8px 12px; background:#fafafa; border-bottom:1px solid #f2f2f2; }
.co-ta { border:none; outline:none; resize:none; width:100%; min-height:130px; padding:10px 12px; font-size:.78rem; line-height:1.75; color:#333; background:white; font-family:'Segoe UI',sans-serif; }
.co-ta.kr { font-family:'Pretendard','Segoe UI',sans-serif; }

.mfoot { padding:12px 22px; border-top:1px solid #eee; display:flex; gap:8px; flex-shrink:0; background:#fafafa; }
.btn-m { padding:11px 16px; border:none; border-radius:9px; cursor:pointer; font-weight:900; font-size:.8rem; transition:all .2s; }
.btn-parse    { flex:1; background:var(--accent); color:white; }
.btn-parse:hover { background:#0d86a8; }
.btn-generate { flex:1; background:var(--green); color:white; display:none; }
.btn-generate:hover { background:#1e8449; }
.btn-copy     { flex:1; background:var(--primary); color:white; display:none; }
.btn-copy:hover { background:#0a1e38; }
.btn-close    { padding:11px 14px; background:#ecf0f1; color:#666; border:none; border-radius:9px; cursor:pointer; font-weight:700; font-size:.8rem; }

/* TOAST */
#toast { position:fixed; bottom:26px; right:26px; padding:12px 18px; border-radius:10px; font-size:.79rem; font-weight:700; z-index:19999; opacity:0; transform:translateY(14px); transition:all .26s; pointer-events:none; max-width:280px; color:white; }
#toast.show { opacity:1; transform:translateY(0); }
#toast.ok  { background:#1e8449; }
#toast.er  { background:#c0392b; }
#toast.inf { background:var(--primary); }
</style>
</head>
<body>

<!-- TOP BAR -->
<div class="top-bar">
  <div>
    <div class="brand">WTI MORNING CHECK | JS KIM</div>
    <div class="sub" id="topClock">ì›ìœ  ì‹œí™© ëª¨ë‹ˆí„°ë§</div>
  </div>
  <button class="btn-input-top" onclick="openModal()">
    <span>ğŸ“‹</span> ë‰´ìŠ¤ ì…ë ¥Â·íŒŒì‹±
  </button>
</div>

<!-- ëª¨ë‹¬ -->
<div id="overlay">
  <div id="modal">
    <div class="mhead">
      <h3>ğŸ“‹ WTI ë‰´ìŠ¤ íŒŒì‹± & ì½”ë©˜í„°ë¦¬ ìƒì„±</h3>
      <span class="ver">No API</span>
    </div>

    <div class="mbody">
      <span class="mlabel">í•œêµ­ ë‰´ìŠ¤ ê¸°ì‚¬ í…ìŠ¤íŠ¸ ë¶™ì—¬ë„£ê¸° (ì—°í•©Â·KBSÂ·ì´ˆì´ìŠ¤ê²½ì œ ë“±)</span>
      <textarea id="news-input" placeholder="ì•„ì¹¨ WTI ë‰´ìŠ¤ ê¸°ì‚¬ ì „ë¬¸ì„ ì—¬ê¸°ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.

ì˜ˆì‹œ:
ë‰´ìš•ìƒì—…ê±°ë˜ì†Œì—ì„œ 3ì›”ë¬¼ ë¯¸êµ­ ì„œë¶€ í…ì‚¬ìŠ¤ì‚° ì›ìœ (WTI)ëŠ”
ì „ ê±°ë˜ì¼ ëŒ€ë¹„ 0.62ë‹¬ëŸ¬(0.99%) í•˜ë½í•œ ë°°ëŸ´ë‹¹ 62.27ë‹¬ëŸ¬ì— ê±°ë˜ëë‹¤.
ëŸ°ë˜ ICEì„ ë¬¼ê±°ë˜ì†Œì—ì„œ 4ì›”ë¬¼ ë¸Œë ŒíŠ¸ìœ ëŠ” 1.24ë‹¬ëŸ¬(1.81%) ë‚´ë¦°
ë°°ëŸ´ë‹¹ 67.41ë‹¬ëŸ¬ë¡œ ì§‘ê³„ëë‹¤.

ë¯¸êµ­ê³¼ ì´ë€ì´ í•µ í˜‘ìƒì—ì„œ ê¸°ë³¸ ì›ì¹™ì— í•©ì˜..."></textarea>

      <!-- íŒŒì‹± ê²°ê³¼ -->
      <div id="pv-wrap">
        <div class="pv-head">
          <span>ğŸ“Š íŒŒì‹± ê²°ê³¼ â€” ìˆ˜ì • ê°€ëŠ¥</span>
          <span id="pbadge" class="pbadge pb-ok">âœ… íŒŒì‹± ì™„ë£Œ</span>
        </div>
        <div class="pg" id="pg"></div>
      </div>

      <!-- ì½”ë©˜í„°ë¦¬ ì¶œë ¥ -->
      <div class="commentary-out" id="co-wrap">
        <div class="co-head">
          <span>ğŸ“ ìƒì„±ëœ ì½”ë©˜í„°ë¦¬ â€” ì§ì ‘ í¸ì§‘ ê°€ëŠ¥</span>
          <span style="font-size:.63rem;color:#888">Copy Both ë²„íŠ¼ìœ¼ë¡œ í•œë²ˆì— ë³µì‚¬</span>
        </div>
        <div class="co-grid">
          <div class="co-pane">
            <div class="co-pane-label">ğŸ‡ºğŸ‡¸ English</div>
            <textarea class="co-ta" id="co-en"></textarea>
          </div>
          <div class="co-pane">
            <div class="co-pane-label">ğŸ‡°ğŸ‡· í•œêµ­ì–´</div>
            <textarea class="co-ta kr" id="co-kr"></textarea>
          </div>
        </div>
      </div>
    </div>

    <div class="mfoot">
      <button class="btn-m btn-parse"    id="btn-parse"    onclick="doParse()">ğŸ” íŒŒì‹±</button>
      <button class="btn-m btn-generate" id="btn-gen"      onclick="doGenerate()">âœï¸ ì½”ë©˜í„°ë¦¬ ìƒì„±</button>
      <button class="btn-m btn-copy"     id="btn-copy"     onclick="doCopyBoth()">â§‰ Copy Both</button>
      <button class="btn-close"                            onclick="closeModal()">ë‹«ê¸°</button>
    </div>
  </div>
</div>

<!-- ì´ë ¥ ì¹´ë“œ ì˜ì—­ -->
<div class="page-wrap">
  <div id="empty-msg">
    ğŸ“‹ ìš°ì¸¡ ìƒë‹¨ <strong>ë‰´ìŠ¤ ì…ë ¥Â·íŒŒì‹±</strong> ë²„íŠ¼ìœ¼ë¡œ ì˜¤ëŠ˜ WTI ì‹œí™©ì„ ì…ë ¥í•˜ì„¸ìš”.<br>
    <span style="font-size:.8rem;color:#bbb;margin-top:6px;display:block">ì…ë ¥ëœ ì‹œí™©ì€ ì•„ë˜ì— ì¹´ë“œë¡œ ëˆ„ì ë©ë‹ˆë‹¤.</span>
  </div>
  <div id="historyArea"></div>
</div>

<div id="toast"></div>

<script>
// â”€â”€ CLOCK â”€â”€
function tick() {
  const k = new Date(Date.now() + 9*3600000);
  const s = k.toISOString();
  document.getElementById('topClock').textContent =
    s.slice(0,10).replace(/-/g,'.') + '  ' + s.slice(11,19) + ' KST Â· WTI ì›ìœ  ì‹œí™©';
}
tick(); setInterval(tick, 1000);

// â”€â”€ FACTOR DATA â”€â”€
const FACTORS = [
  { t:'bear', kr:'ë¯¸Â·ì´ë€ í•µ í˜‘ìƒ ì§„ì „', en:'US-Iran nuclear deal progress' },
  { t:'bear', kr:'ì¤‘ë™ ì§€ì •í•™ ë¦¬ìŠ¤í¬ ì™„í™”', en:'Easing Middle East risk premium' },
  { t:'bear', kr:'IEA ìˆ˜ìš” ì „ë§ í•˜í–¥', en:'IEA demand forecast downgraded' },
  { t:'bear', kr:'OPEC+ ì¦ì‚° ë…¼ì˜', en:'OPEC+ output increase discussed' },
  { t:'bear', kr:'ì¹´ìí í…¡ê¸°ì¦ˆ ìœ ì „ ìƒì‚° ì¬ê°œ', en:'Tengiz oilfield ramping up (Kazakhstan)' },
  { t:'bear', kr:'ë¯¸ ì›ìœ  ì¬ê³  ì¦ê°€(EIA)', en:'US crude inventory build (EIA)' },
  { t:'bear', kr:'ë‹¬ëŸ¬ ê°•ì„¸', en:'USD strengthened' },
  { t:'bear', kr:'ê²½ê¸°ì¹¨ì²´ ìš°ë ¤', en:'Recession/slowdown concerns' },
  { t:'bull', kr:'ì¤‘ë™ ê¸´ì¥ ê³ ì¡°', en:'Middle East tensions escalating' },
  { t:'bull', kr:'í˜¸ë¥´ë¬´ì¦ˆ í•´í˜‘ ë¦¬ìŠ¤í¬', en:'Hormuz Strait disruption risk' },
  { t:'bull', kr:'OPEC+ ê°ì‚° ìœ ì§€Â·ê°•í™”', en:'OPEC+ maintained/deepened cuts' },
  { t:'bull', kr:'ë¯¸ ì›ìœ  ì¬ê³  ê°ì†Œ(EIA)', en:'US crude inventory draw (EIA)' },
  { t:'bull', kr:'IEA/EIA ìˆ˜ìš” ì „ë§ ìƒí–¥', en:'IEA/EIA demand upgrade' },
  { t:'bull', kr:'ë‹¬ëŸ¬ ì•½ì„¸', en:'USD weakened' },
];

const selFactors = new Set();
let history = JSON.parse(localStorage.getItem('wti_history') || '[]');

// â”€â”€ MODAL â”€â”€
function openModal() {
  document.getElementById('news-input').value = '';
  document.getElementById('pv-wrap').style.display = 'none';
  document.getElementById('co-wrap').style.display = 'none';
  document.getElementById('btn-gen').style.display = 'none';
  document.getElementById('btn-copy').style.display = 'none';
  selFactors.clear();
  document.getElementById('overlay').classList.add('open');
  setTimeout(() => document.getElementById('news-input').focus(), 120);
}
function closeModal() { document.getElementById('overlay').classList.remove('open'); }
document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });
document.getElementById('overlay').addEventListener('click', e => {
  if (e.target === document.getElementById('overlay')) closeModal();
});

// â”€â”€ PARSE â”€â”€
function doParse() {
  const txt = document.getElementById('news-input').value.trim();
  if (!txt) { toast('ê¸°ì‚¬ í…ìŠ¤íŠ¸ë¥¼ ë¶™ì—¬ë„£ì–´ ì£¼ì„¸ìš”.', 'er'); return; }

  const f = {};
  let m;

  // WTI ì¢…ê°€
  m = txt.match(/(?:í•˜ë½í•œ|ì˜¤ë¥¸|ë°€ë¦°|ë‚´ë¦°)\s*ë°°ëŸ´ë‹¹\s*([\d.]+)ë‹¬ëŸ¬/);
  if (m) f.wti = parseFloat(m[1]);
  if (!f.wti) {
    m = txt.match(/ë°°ëŸ´ë‹¹\s*[\d.]+%\s*(?:í•˜ë½í•œ|ìƒìŠ¹í•œ|ì˜¤ë¥¸)\s*([\d.]+)ë‹¬ëŸ¬/);
    if (m) f.wti = parseFloat(m[1]);
  }

  // ì „ì¼æ¯” $ & %
  const wtiSeg = (txt.match(/(?:WTI|ì„œë¶€í…ì‚¬ìŠ¤|í…ì‚¬ìŠ¤ì‚°ì›ìœ )[^\nã€‚]{0,200}/) || [''])[0];
  m = wtiSeg.match(/([\d.]+)ë‹¬ëŸ¬\(([\d.]+)%\)\s*(?:í•˜ë½|ë‚´ë¦°|ë°€ë¦°|ë–¨ì–´ì§„)/);
  if (m) { f.abs = -parseFloat(m[1]); f.pct = -parseFloat(m[2]); }
  if (!f.abs) { m = wtiSeg.match(/([\d.]+)ë‹¬ëŸ¬\(([\d.]+)%\)\s*(?:ìƒìŠ¹|ì˜¤ë¥¸|ì˜¬ë¼)/); if (m) { f.abs = parseFloat(m[1]); f.pct = parseFloat(m[2]); } }
  if (!f.abs) { m = txt.match(/([\d.]+)ë‹¬ëŸ¬\(([\d.]+)%\)\s*(?:í•˜ë½|ë‚´ë¦°|ë°€ë¦°|ë–¨ì–´ì§„)/); if (m) { f.abs = -parseFloat(m[1]); f.pct = -parseFloat(m[2]); } }
  if (!f.pct) { m = txt.match(/ë°°ëŸ´ë‹¹\s*([\d.]+)%\s*(í•˜ë½|ìƒìŠ¹)/); if (m) f.pct = m[2]==='í•˜ë½' ? -parseFloat(m[1]) : parseFloat(m[1]); }

  // ë¸Œë ŒíŠ¸ ì¢…ê°€
  const brSegs = txt.match(/ë¸Œë ŒíŠ¸ìœ [^\nã€‚]{0,150}/g) || [];
  for (const seg of brSegs) {
    const pm = seg.match(/(?:ë°°ëŸ´ë‹¹|ê°€ê²©ì€)\s*([\d.]+)ë‹¬ëŸ¬/);
    if (pm && parseFloat(pm[1]) > 10) { f.brent = parseFloat(pm[1]); break; }
  }
  // ë¸Œë ŒíŠ¸ ë³€ë™ë¥ 
  for (const seg of brSegs) {
    let bm = seg.match(/[\d.]+ë‹¬ëŸ¬\(([\d.]+)%\)\s*(?:ë‚´ë¦°|í•˜ë½í•œ|ë–¨ì–´ì§„)/);
    if (bm) { f.brentPct = -parseFloat(bm[1]); break; }
    bm = seg.match(/ë‹¬ëŸ¬ë¡œ\s*([\d.]+)%\s*(í•˜ë½|ìƒìŠ¹)/);
    if (bm) { f.brentPct = bm[2]==='í•˜ë½' ? -parseFloat(bm[1]) : parseFloat(bm[1]); break; }
    bm = seg.match(/\(([\d.]+)%\)\s*(?:ë‚´ë¦°|í•˜ë½)/);
    if (bm) { f.brentPct = -parseFloat(bm[1]); break; }
  }

  // ê¸°ì‚¬ ë‚ ì§œ ì¶”ì¶œ (YYYY-MM-DD)
  const dateM = txt.match(/20(\d{2})[.\-\/](\d{1,2})[.\-\/](\d{1,2})/);
  const today = new Date(Date.now() + 9*3600000).toISOString().slice(0,10);
  f.date = dateM ? `20${dateM[1]}-${String(dateM[2]).padStart(2,'0')}-${String(dateM[3]).padStart(2,'0')}` : today;

  const priceOk = f.wti !== undefined;
  const allOk   = priceOk && f.abs !== undefined && f.pct !== undefined;

  // ìš”ì¸ í‚¤ì›Œë“œ ìë™ ê°ì§€ (ì„ íƒ ë„ì›€)
  const autoSel = new Set();
  const lo = txt.toLowerCase();
  if (lo.includes('ì´ë€') && (lo.includes('í•©ì˜')||lo.includes('ì§„ì „'))) autoSel.add(0);
  if (lo.includes('ì¤‘ë™') && lo.includes('ì™„í™”')) autoSel.add(1);
  if (lo.includes('iea') && lo.includes('í•˜í–¥')) autoSel.add(2);
  if (lo.includes('opec') && (lo.includes('ì¦ì‚°')||lo.includes('ì¦ê°€'))) autoSel.add(3);
  if (lo.includes('í…¡ê¸°ì¦ˆ') || lo.includes('ì¹´ìí')) autoSel.add(4);
  if (lo.includes('ì¬ê³ ') && lo.includes('ì¦ê°€')) autoSel.add(5);
  if (lo.includes('ë‹¬ëŸ¬') && (lo.includes('ê°•ì„¸')||lo.includes('ìƒìŠ¹'))) autoSel.add(6);
  if (lo.includes('ì´ë€') && (lo.includes('ê¸´ì¥')||lo.includes('ê°ˆë“±'))) autoSel.add(8);
  if (lo.includes('í˜¸ë¥´ë¬´ì¦ˆ')) autoSel.add(9);
  if (lo.includes('opec') && lo.includes('ê°ì‚°')) autoSel.add(10);
  if (lo.includes('ì¬ê³ ') && lo.includes('ê°ì†Œ')) autoSel.add(11);
  autoSel.forEach(i => selFactors.add(i));

  // ê·¸ë¦¬ë“œ ë Œë”
  const pctStr = f.pct !== undefined ? `${f.pct >= 0 ? '+' : ''}${f.pct.toFixed(2)}%` : '-';
  const absStr = f.abs !== undefined ? `${f.abs >= 0 ? '+' : ''}${f.abs.toFixed(2)}` : '-';
  const pctCls = f.pct > 0 ? 'up' : f.pct < 0 ? 'dn' : '';

  document.getElementById('pg').innerHTML = `
    <div class="pf price-ok">
      <div class="pl">WTI ì¢…ê°€ ($/bbl) *</div>
      <input class="pv-input hi" id="ed-wti" value="${f.wti !== undefined ? f.wti.toFixed(2) : ''}" placeholder="ì§ì ‘ ì…ë ¥">
    </div>
    <div class="pf">
      <div class="pl">ì „ì¼æ¯” $</div>
      <input class="pv-input ${pctCls}" id="ed-abs" value="${f.abs !== undefined ? f.abs.toFixed(2) : ''}" placeholder="ì˜ˆ: -0.56">
    </div>
    <div class="pf">
      <div class="pl">ë³€ë™ë¥  %</div>
      <input class="pv-input ${pctCls}" id="ed-pct" value="${f.pct !== undefined ? f.pct.toFixed(2) : ''}" placeholder="ì˜ˆ: -0.89">
    </div>
    <div class="pf">
      <div class="pl">ë¸Œë ŒíŠ¸ ì¢…ê°€ ($/bbl)</div>
      <input class="pv-input" id="ed-brent" value="${f.brent !== undefined ? f.brent.toFixed(2) : ''}" placeholder="ì˜ˆ: 67.29">
    </div>
    <div class="pf">
      <div class="pl">ë¸Œë ŒíŠ¸ ë³€ë™ë¥  %</div>
      <input class="pv-input" id="ed-brentpct" value="${f.brentPct !== undefined ? f.brentPct.toFixed(2) : ''}" placeholder="ì˜ˆ: -1.98">
    </div>
    <div class="pf">
      <div class="pl">ì›”ë¬¼</div>
      <select class="pv-input" id="ed-cont">
        <option value="3ì›”ë¬¼(Mar)">3ì›”ë¬¼ (Mar)</option>
        <option value="4ì›”ë¬¼(Apr)">4ì›”ë¬¼ (Apr)</option>
        <option value="5ì›”ë¬¼(May)">5ì›”ë¬¼ (May)</option>
      </select>
    </div>
    <div class="pf">
      <div class="pl">ê¸°ì‚¬ ê¸°ì¤€ì¼</div>
      <input class="pv-input" id="ed-date" value="${f.date}" type="date">
    </div>
    <div class="pf">
      <div class="pl">ì¶”ê°€ ì‹œì¥ ë©”ëª¨</div>
      <input class="pv-input" id="ed-memo" placeholder="Nat.Gas -6.26% / DXY +0.24%">
    </div>

    <!-- í•˜ë½ ìš”ì¸ -->
    <div class="factor-section">
      <div class="factor-section-title">
        <span class="dot" style="background:#e74c3c"></span>â–¼ í•˜ë½ ìš”ì¸ (í´ë¦­ ì„ íƒ Â· ìë™ ê°ì§€ í‘œì‹œë¨)
      </div>
      <div class="chip-grid" id="bear-chips"></div>
    </div>
    <!-- ìƒìŠ¹ ìš”ì¸ -->
    <div class="factor-section" style="border-bottom:none">
      <div class="factor-section-title">
        <span class="dot" style="background:#27ae60"></span>â–² ìƒìŠ¹ ìš”ì¸
      </div>
      <div class="chip-grid" id="bull-chips"></div>
    </div>`;

  // ì¹© ë Œë”
  ['bear','bull'].forEach(t => {
    const container = document.getElementById(`${t}-chips`);
    FACTORS.forEach((f, i) => {
      if (f.t !== t) return;
      const ch = document.createElement('div');
      ch.className = 'fchip' + (selFactors.has(i) ? ` sel-${t}` : '');
      ch.textContent = f.kr;
      ch.addEventListener('click', () => {
        if (selFactors.has(i)) { selFactors.delete(i); ch.className = 'fchip'; }
        else { selFactors.add(i); ch.className = `fchip sel-${t}`; }
      });
      container.appendChild(ch);
    });
  });

  const badge = document.getElementById('pbadge');
  badge.textContent = allOk ? 'âœ… íŒŒì‹± ì™„ë£Œ' : priceOk ? 'âš ï¸ ì¼ë¶€ ë¯¸ì¸ì‹ â€” í™•ì¸ í•„ìš”' : 'âŒ ìˆ˜ë™ ì…ë ¥ í•„ìš”';
  badge.className   = `pbadge ${allOk ? 'pb-ok' : 'pb-warn'}`;

  document.getElementById('pv-wrap').style.display = 'block';
  document.getElementById('btn-gen').style.display = 'block';
  document.getElementById('co-wrap').style.display = 'none';
  document.getElementById('btn-copy').style.display = 'none';

  toast(allOk ? `âœ… WTI $${f.wti?.toFixed(2)} (${pctStr}) íŒŒì‹± ì™„ë£Œ` : 'âš ï¸ ìˆ˜ì¹˜ í™•ì¸ í›„ ìˆ˜ì •í•˜ì„¸ìš”.', allOk ? 'ok' : 'inf');
}

// â”€â”€ GENERATE COMMENTARY â”€â”€
function doGenerate() {
  const wti     = parseFloat(document.getElementById('ed-wti').value);
  const abs     = parseFloat(document.getElementById('ed-abs').value);
  const pct     = parseFloat(document.getElementById('ed-pct').value);
  const brent   = parseFloat(document.getElementById('ed-brent').value);
  const brentPct= parseFloat(document.getElementById('ed-brentpct').value);
  const cont    = document.getElementById('ed-cont').value;
  const dateV   = document.getElementById('ed-date').value;
  const memo    = document.getElementById('ed-memo').value.trim();

  if (isNaN(wti) || isNaN(pct)) { toast('WTI ì¢…ê°€ì™€ ë³€ë™ë¥ ì„ ì…ë ¥í•˜ì„¸ìš”.', 'er'); return; }

  const pctStr  = (pct >= 0 ? '+' : '') + pct.toFixed(2) + '%';
  const absStr  = (abs >= 0 ? '+' : '') + abs.toFixed(2);
  const dir     = pct > 0 ? 'higher' : pct < 0 ? 'lower' : 'unchanged';
  const dirKR   = pct > 0 ? 'ìƒìŠ¹' : pct < 0 ? 'í•˜ë½' : 'ë³´í•©';

  const d       = new Date(dateV + 'T00:00:00Z');
  const enDate  = d.toLocaleDateString('en-US', {year:'numeric',month:'long',day:'numeric',timeZone:'UTC'});
  const krDate  = dateV.replace(/-/g,'.');
  const contEN  = cont.match(/\((\w+)\)/)?.[1] || 'Mar';

  const bears = [], bulls = [];
  selFactors.forEach(i => { FACTORS[i].t === 'bear' ? bears.push(FACTORS[i]) : bulls.push(FACTORS[i]); });

  // EN
  let en = `[WTI] ${d.toLocaleDateString('en-US',{month:'short',day:'numeric',timeZone:'UTC'})} Â· $${wti.toFixed(2)}/bbl (${pctStr})\n${'â”€'.repeat(50)}\n\n`;
  en += `WTI crude (${contEN} contract, NYMEX) settled ${dir} on ${enDate}, closing at $${wti.toFixed(2)}/bbl (${absStr} USD, ${pctStr}).`;
  if (!isNaN(brent) && !isNaN(brentPct)) en += ` Brent (ICE): $${brent.toFixed(2)}/bbl (${(brentPct>=0?'+':'')+brentPct.toFixed(2)}%).`;
  en += '\n\n';
  if (bears.length) { en += 'Downside drivers:\n'; bears.forEach(f => { en += `  â€¢ ${f.en}\n`; }); en += '\n'; }
  if (bulls.length) { en += 'Upside drivers:\n';   bulls.forEach(f => { en += `  â€¢ ${f.en}\n`; }); en += '\n'; }
  if (memo) en += `Market: ${memo}\n\n`;
  if (pct < 0 && bears.length) en += `Bearish pressure from ${bears[0].en.toLowerCase()} dominated sentiment.`;
  else if (pct > 0 && bulls.length) en += `Prices supported by ${bulls[0].en.toLowerCase()}.`;
  else if (bears.length || bulls.length) en += `Mixed signals kept prices range-bound.`;

  // KR
  let kr = `[WTI ì‹œí™©] ${krDate} Â· $${wti.toFixed(2)} (${pctStr})\n${'â”€'.repeat(36)}\n\n`;
  kr += `WTI ì›ìœ (${cont}, NYMEX)ëŠ” ${krDate} ì „ ê±°ë˜ì¼ ëŒ€ë¹„ ${absStr} USD(${pctStr}) ${dirKR}í•œ ë°°ëŸ´ë‹¹ $${wti.toFixed(2)}ì— ë§ˆê°í–ˆë‹¤.`;
  if (!isNaN(brent) && !isNaN(brentPct)) kr += ` ë¸Œë ŒíŠ¸ìœ (ICE)ëŠ” $${brent.toFixed(2)}/ë°°ëŸ´(${(brentPct>=0?'+':'')+brentPct.toFixed(2)}%).`;
  kr += '\n\n';
  if (bears.length) { kr += 'â–¼ í•˜ë½ ìš”ì¸\n'; bears.forEach(f => { kr += `  â€¢ ${f.kr}\n`; }); kr += '\n'; }
  if (bulls.length) { kr += 'â–² ìƒìŠ¹ ìš”ì¸\n'; bulls.forEach(f => { kr += `  â€¢ ${f.kr}\n`; }); kr += '\n'; }
  if (memo) kr += `[ê´€ë ¨ ì‹œì¥] ${memo}\n\n`;
  if (pct < 0 && bears.length) kr += `${bears[0].kr} ë“± í•˜ë°© ì¬ë£Œ ì••ë°•ìœ¼ë¡œ ì•½ì„¸ ë§ˆê°.`;
  else if (pct > 0 && bulls.length) kr += `${bulls[0].kr} ë“±ì´ ìœ ê°€ë¥¼ ì§€ì§€í•˜ë©° ê°•ì„¸ ë§ˆê°.`;
  else if (bears.length || bulls.length) kr += `ìƒÂ·í•˜ë°© ì¬ë£Œ í˜¼ì¬ ì† ë°©í–¥ì„± íƒìƒ‰.`;

  document.getElementById('co-en').value = en;
  document.getElementById('co-kr').value = kr;
  document.getElementById('co-wrap').style.display = 'block';
  document.getElementById('btn-copy').style.display = 'block';

  // ì´ë ¥ì— ì €ì¥
  const entry = { wti, abs, pct, brent, brentPct, cont, date: dateV, memo, bears: bears.map(f=>f.kr), bulls: bulls.map(f=>f.kr), en, kr };
  history.unshift(entry);
  if (history.length > 30) history = history.slice(0, 30);
  localStorage.setItem('wti_history', JSON.stringify(history));
  renderHistory();

  toast('âœï¸ ì½”ë©˜í„°ë¦¬ ìƒì„± ì™„ë£Œ!', 'ok');
}

// â”€â”€ COPY â”€â”€
function doCopyBoth() {
  const en = document.getElementById('co-en').value;
  const kr = document.getElementById('co-kr').value;
  navigator.clipboard.writeText(en + '\n\n' + 'â”'.repeat(50) + '\n\n' + kr).then(() => {
    toast('âœ… EN + KR ë³µì‚¬ ì™„ë£Œ!', 'ok');
    const btn = document.getElementById('btn-copy');
    btn.textContent = 'âœ“ Copied!';
    setTimeout(() => { btn.textContent = 'â§‰ Copy Both'; }, 2000);
  });
}

// â”€â”€ HISTORY CARDS â”€â”€
function renderHistory() {
  const area = document.getElementById('historyArea');
  const empty = document.getElementById('empty-msg');
  if (!history.length) { empty.style.display='block'; area.innerHTML=''; return; }
  empty.style.display = 'none';

  area.innerHTML = history.map((h, i) => {
    const pctStr = (h.pct >= 0 ? '+' : '') + h.pct.toFixed(2) + '%';
    const absStr = (h.abs >= 0 ? '+' : '') + h.abs.toFixed(2);
    const dir    = h.pct > 0 ? 'up' : h.pct < 0 ? 'dn' : 'flt';
    const arrow  = h.pct > 0 ? 'â–²' : h.pct < 0 ? 'â–¼' : 'â”€';
    const factorHTML = [
      ...h.bears.map(f => `<span class="ftag bear">â–¼ ${f}</span>`),
      ...h.bulls.map(f => `<span class="ftag bull">â–² ${f}</span>`),
    ].join('');

    return `<div class="hcard ${dir}">
      <div class="hcard-top">
        <div>
          <div class="hcard-date">${h.date.replace(/-/g,'.')}  ${h.cont}</div>
          <div class="hcard-sub">NYMEX WTI Crude Â· ${arrow} ${dir === 'up' ? 'ìƒìŠ¹' : dir === 'dn' ? 'í•˜ë½' : 'ë³´í•©'} ë§ˆê°</div>
        </div>
        <div class="price-badge ${dir}">
          <span class="pv">$${h.wti.toFixed(2)}</span>
          <span class="pc">${pctStr}</span>
        </div>
      </div>
      ${h.brent ? `<div class="row-item"><div class="rl">Brent</div><div class="rv">$${h.brent.toFixed(2)} (${(h.brentPct>=0?'+':'')+h.brentPct.toFixed(2)}%)</div></div>` : ''}
      <div class="row-item"><div class="rl">ì „ì¼æ¯”</div><div class="rv hi">${absStr} USD (${pctStr})</div></div>
      ${factorHTML ? `<div class="row-item" style="flex-direction:column">
        <div class="rl" style="margin-bottom:6px">ìš”ì¸</div>
        <div class="factor-tags">${factorHTML}</div>
      </div>` : ''}
      ${h.memo ? `<div class="row-item"><div class="rl">ê´€ë ¨ì‹œì¥</div><div class="rv" style="font-size:.78rem;color:#666">${h.memo}</div></div>` : ''}
      <div class="row-item" style="flex-direction:column;border-bottom:none">
        <div class="rl" style="margin-bottom:5px">ì½”ë©˜í„°ë¦¬ (KR)</div>
        <div class="cmt-box">${h.kr.replace(/\n/g,'<br>')}</div>
      </div>
    </div>`;
  }).join('');
}

// TOAST
function toast(msg, type='inf', ms=3000) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.className = `show ${type}`;
  clearTimeout(t._t); t._t = setTimeout(() => t.className='', ms);
}

// INIT
renderHistory();
</script>
</body>
</html>
