<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WTI MORNING BRIEF</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Mono:ital,wght@0,300;0,400;0,500;1,300&family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg:       #08090c;
  --surface:  #0d1117;
  --card:     #111620;
  --border:   #1c2535;
  --border2:  #2a3a50;
  --acc:      #c8a84b;       /* gold */
  --acc2:     #3b82f6;       /* blue */
  --green:    #22c55e;
  --red:      #ef4444;
  --text:     #d4dce8;
  --dim:      #4a5a70;
  --bright:   #f0f6ff;
  --mono:     'DM Mono', monospace;
  --sans:     'Noto Sans KR', sans-serif;
  --display:  'Bebas Neue', sans-serif;
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html, body { height: 100%; background: var(--bg); color: var(--text); font-family: var(--sans); }

/* ‚îÄ‚îÄ‚îÄ SCANLINE TEXTURE ‚îÄ‚îÄ‚îÄ */
body::before {
  content: '';
  position: fixed; inset: 0; z-index: 0; pointer-events: none;
  background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,0,0,.04) 2px, rgba(0,0,0,.04) 4px);
}

/* ‚îÄ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ‚îÄ */
.hdr {
  position: sticky; top: 0; z-index: 100;
  background: rgba(8,9,12,.92); backdrop-filter: blur(12px);
  border-bottom: 1px solid var(--border);
  display: flex; align-items: center; justify-content: space-between;
  padding: 0 28px; height: 52px;
}
.hdr-left { display: flex; align-items: baseline; gap: 14px; }
.hdr-logo { font-family: var(--display); font-size: 22px; letter-spacing: .12em; color: var(--acc); }
.hdr-sub  { font-family: var(--mono); font-size: 9px; letter-spacing: .2em; color: var(--dim); text-transform: uppercase; }
.hdr-right { display: flex; align-items: center; gap: 12px; }
.hdr-clock { font-family: var(--mono); font-size: 11px; color: var(--dim); letter-spacing: .06em; }

.btn-new {
  display: flex; align-items: center; gap: 6px;
  background: var(--acc); color: #08090c;
  border: none; border-radius: 3px;
  padding: 7px 16px; font-family: var(--mono); font-size: 10px;
  font-weight: 500; letter-spacing: .14em; text-transform: uppercase;
  cursor: pointer; transition: background .15s;
}
.btn-new:hover { background: #dbb85a; }

/* ‚îÄ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ‚îÄ */
.wrap { max-width: 960px; margin: 0 auto; padding: 32px 24px 80px; position: relative; z-index: 1; }

/* ‚îÄ‚îÄ‚îÄ EMPTY STATE ‚îÄ‚îÄ‚îÄ */
.empty {
  text-align: center; padding: 80px 0;
  font-family: var(--mono); font-size: 11px; letter-spacing: .12em; color: var(--dim);
}
.empty .e-icon { font-size: 36px; margin-bottom: 16px; opacity: .3; }

/* ‚îÄ‚îÄ‚îÄ BRIEF CARD ‚îÄ‚îÄ‚îÄ */
.brief {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 4px;
  margin-bottom: 20px;
  overflow: hidden;
  animation: fadeUp .3s ease both;
}
@keyframes fadeUp { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:none; } }

/* CARD HEADER STRIP */
.brief-strip {
  display: flex; align-items: stretch;
  border-bottom: 1px solid var(--border);
}
.strip-date {
  padding: 14px 20px;
  border-right: 1px solid var(--border);
  display: flex; flex-direction: column; justify-content: center; gap: 2px;
  min-width: 130px;
}
.strip-date .sd-date { font-family: var(--mono); font-size: 11px; color: var(--dim); letter-spacing: .1em; }
.strip-date .sd-cont { font-family: var(--mono); font-size: 9px; color: var(--dim); opacity: .5; margin-top: 2px; }

/* PRICE BLOCK */
.strip-price {
  flex: 1; display: flex; align-items: center; padding: 14px 24px; gap: 20px;
}
.sp-val { font-family: var(--display); font-size: 52px; letter-spacing: .02em; line-height: 1; }
.sp-val.up  { color: var(--green); }
.sp-val.dn  { color: var(--red); }
.sp-val.flt { color: var(--text); }
.sp-unit { font-family: var(--mono); font-size: 10px; color: var(--dim); align-self: flex-end; padding-bottom: 6px; }

.sp-delta {
  display: flex; flex-direction: column; gap: 4px; padding-left: 20px;
  border-left: 1px solid var(--border);
}
.sp-d-row { display: flex; align-items: center; gap: 8px; }
.sp-d-label { font-family: var(--mono); font-size: 8px; letter-spacing: .12em; color: var(--dim); width: 28px; }
.sp-d-val { font-family: var(--mono); font-size: 13px; font-weight: 500; }
.sp-d-val.up { color: var(--green); }
.sp-d-val.dn { color: var(--red); }

/* BRENT ROW */
.strip-brent {
  padding: 14px 20px; border-left: 1px solid var(--border);
  display: flex; flex-direction: column; justify-content: center; gap: 4px;
  min-width: 130px;
}
.sb-label { font-family: var(--mono); font-size: 8px; letter-spacing: .14em; color: var(--dim); text-transform: uppercase; }
.sb-val   { font-family: var(--mono); font-size: 16px; font-weight: 500; color: var(--text); }
.sb-chg   { font-family: var(--mono); font-size: 10px; }
.sb-chg.up { color: var(--green); } .sb-chg.dn { color: var(--red); }

/* CARD ACTIONS */
.strip-actions {
  display: flex; flex-direction: column; border-left: 1px solid var(--border);
}
.act-btn {
  flex: 1; display: flex; align-items: center; justify-content: center;
  background: transparent; border: none; cursor: pointer;
  font-family: var(--mono); font-size: 9px; letter-spacing: .1em; color: var(--dim);
  padding: 0 14px; transition: all .15s; text-transform: uppercase; gap: 4px;
  border-bottom: 1px solid var(--border);
}
.act-btn:last-child { border-bottom: none; }
.act-btn:hover.edit { background: rgba(59,130,246,.08); color: var(--acc2); }
.act-btn:hover.del  { background: rgba(239,68,68,.06); color: var(--red); }

/* FACTORS SECTION */
.brief-body { padding: 16px 20px; }

.factors-row { display: flex; gap: 12px; margin-bottom: 14px; }
.factor-col { flex: 1; }
.fc-title {
  font-family: var(--mono); font-size: 8px; letter-spacing: .18em; text-transform: uppercase;
  padding-bottom: 6px; margin-bottom: 8px; border-bottom: 1px solid var(--border);
  display: flex; align-items: center; gap: 5px;
}
.fc-title.bear { color: var(--red); }
.fc-title.bull { color: var(--green); }
.fc-dot { width: 5px; height: 5px; border-radius: 50%; flex-shrink: 0; }
.fc-dot.bear { background: var(--red); }
.fc-dot.bull { background: var(--green); }

.factor-item {
  display: flex; align-items: flex-start; gap: 7px;
  padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,.03);
  font-size: 12px; line-height: 1.5; color: var(--text);
}
.factor-item:last-child { border-bottom: none; }
.fi-bullet { font-family: var(--mono); font-size: 10px; flex-shrink: 0; margin-top: 1px; }
.fi-bullet.bear { color: var(--red); }
.fi-bullet.bull { color: var(--green); }
.fi-kr { flex: 1; }
.fi-en { font-family: var(--mono); font-size: 9px; color: var(--dim); margin-top: 1px; }

/* MEMO */
.brief-memo {
  margin-top: 10px; padding: 10px 14px;
  background: rgba(255,255,255,.02); border: 1px solid var(--border);
  border-radius: 2px;
  font-family: var(--mono); font-size: 10px; color: var(--dim); line-height: 1.7;
}
.memo-label { font-size: 8px; letter-spacing: .14em; text-transform: uppercase; color: var(--dim); opacity: .5; margin-bottom: 4px; }

/* COMMENTARY SECTION */
.brief-commentary {
  border-top: 1px solid var(--border);
  display: grid; grid-template-columns: 1fr 1fr;
}
.co-pane { padding: 14px 20px; }
.co-pane:first-child { border-right: 1px solid var(--border); }
.co-label {
  font-family: var(--mono); font-size: 8px; letter-spacing: .16em; text-transform: uppercase;
  color: var(--dim); margin-bottom: 8px; display: flex; align-items: center; gap: 6px;
}
.co-label::after { content: ''; flex: 1; height: 1px; background: var(--border); }
.co-text { font-size: 12px; line-height: 1.85; color: var(--text); white-space: pre-wrap; font-family: var(--sans); }
.co-text.en { font-family: var(--mono); font-size: 11px; }

/* COPY ROW */
.brief-copy {
  border-top: 1px solid var(--border);
  padding: 10px 20px; display: flex; align-items: center; justify-content: flex-end; gap: 6px;
}
.cp-btn {
  font-family: var(--mono); font-size: 9px; letter-spacing: .1em; text-transform: uppercase;
  background: transparent; border: 1px solid var(--border2); color: var(--dim);
  padding: 5px 12px; border-radius: 2px; cursor: pointer; transition: all .15s;
}
.cp-btn:hover { border-color: var(--acc); color: var(--acc); }
.cp-btn.pri { background: var(--acc2); color: #fff; border-color: var(--acc2); }
.cp-btn.pri:hover { background: #2563eb; }
.cp-btn.ok  { border-color: var(--green); color: var(--green); }

/* ‚îÄ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ‚îÄ */
#overlay {
  position: fixed; inset: 0; z-index: 200;
  background: rgba(4,6,10,.92); backdrop-filter: blur(8px);
  display: none; align-items: center; justify-content: center;
}
#overlay.open { display: flex; }

#modal {
  width: 700px; max-height: 92vh;
  background: var(--card); border: 1px solid var(--border2);
  border-radius: 6px; display: flex; flex-direction: column;
  overflow: hidden; box-shadow: 0 32px 80px rgba(0,0,0,.7);
  animation: mIn .2s ease;
}
@keyframes mIn { from{opacity:0;transform:translateY(16px) scale(.98)} to{opacity:1;transform:none} }

.mhdr {
  display: flex; align-items: center; justify-content: space-between;
  padding: 14px 20px; border-bottom: 1px solid var(--border);
  background: var(--surface); flex-shrink: 0;
}
.mhdr-title { font-family: var(--mono); font-size: 11px; letter-spacing: .14em; text-transform: uppercase; color: var(--acc); }
.mhdr-close {
  background: transparent; border: 1px solid var(--border2); color: var(--dim);
  width: 26px; height: 26px; border-radius: 2px; cursor: pointer; font-size: 14px;
  display: flex; align-items: center; justify-content: center; transition: all .15s;
}
.mhdr-close:hover { border-color: var(--red); color: var(--red); }

.mbody { flex: 1; overflow-y: auto; padding: 18px 20px; display: flex; flex-direction: column; gap: 14px; }

/* PARSE AREA */
.m-section-label {
  font-family: var(--mono); font-size: 8px; letter-spacing: .18em; text-transform: uppercase;
  color: var(--dim); margin-bottom: 6px;
}
#news-ta {
  width: 100%; height: 140px; resize: vertical;
  background: var(--surface); border: 1px solid var(--border); border-radius: 3px;
  color: var(--text); font-family: var(--sans); font-size: 12px; line-height: 1.7;
  padding: 10px 12px; outline: none; transition: border-color .15s;
}
#news-ta:focus { border-color: var(--acc2); }
#news-ta::placeholder { color: var(--dim); font-size: 11px; }

/* PARSED FIELDS GRID */
#parsed-wrap { display: none; }
.pf-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
.pf-grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
.pfield { display: flex; flex-direction: column; gap: 3px; }
.pfield label { font-family: var(--mono); font-size: 8px; letter-spacing: .12em; text-transform: uppercase; color: var(--dim); }
.pfield input, .pfield select, .pfield textarea {
  background: var(--surface); border: 1px solid var(--border); border-radius: 3px;
  color: var(--text); font-family: var(--mono); font-size: 13px;
  padding: 7px 9px; outline: none; width: 100%; transition: border-color .15s;
}
.pfield input:focus, .pfield select:focus, .pfield textarea:focus { border-color: var(--acc2); }
.pfield input.hi { color: var(--acc); font-weight: 500; border-color: rgba(200,168,75,.3); }
.pfield input.up { color: var(--green); }
.pfield input.dn { color: var(--red); }
.pfield textarea { resize: vertical; min-height: 50px; font-family: var(--sans); font-size: 12px; line-height: 1.6; }

/* PARSE STATUS */
.parse-status {
  font-family: var(--mono); font-size: 10px; padding: 7px 10px;
  border-radius: 3px; margin-top: 6px; display: none;
}
.parse-status.ok  { background: rgba(34,197,94,.08); border: 1px solid rgba(34,197,94,.2); color: var(--green); }
.parse-status.warn{ background: rgba(200,168,75,.08); border: 1px solid rgba(200,168,75,.2); color: var(--acc); }
.parse-status.err { background: rgba(239,68,68,.08); border: 1px solid rgba(239,68,68,.2); color: var(--red); }

/* FACTOR CHIPS */
.chip-wrap { display: flex; flex-wrap: wrap; gap: 5px; }
.chip {
  font-family: var(--mono); font-size: 9px; letter-spacing: .06em;
  padding: 4px 10px; border-radius: 2px; border: 1px solid var(--border2);
  color: var(--dim); cursor: pointer; transition: all .12s; user-select: none;
}
.chip:hover { color: var(--text); border-color: var(--dim); }
.chip.sel-bear { background: rgba(239,68,68,.08); border-color: rgba(239,68,68,.4); color: var(--red); }
.chip.sel-bull { background: rgba(34,197,94,.08); border-color: rgba(34,197,94,.4); color: var(--green); }
.chip-group { margin-bottom: 4px; font-family: var(--mono); font-size: 8px; letter-spacing: .14em; text-transform: uppercase; color: var(--dim); opacity: .5; }

/* MFOOTER */
.mftr {
  flex-shrink: 0; padding: 12px 20px; border-top: 1px solid var(--border);
  display: flex; gap: 8px; background: var(--surface);
}
.mf-btn {
  padding: 9px 16px; border: none; border-radius: 3px; cursor: pointer;
  font-family: var(--mono); font-size: 10px; letter-spacing: .12em; text-transform: uppercase;
  font-weight: 500; transition: all .15s;
}
.mf-parse  { flex: 1; background: var(--border2); color: var(--text); }
.mf-parse:hover { background: var(--acc2); color: #fff; }
.mf-save   { flex: 2; background: var(--acc); color: #08090c; display: none; }
.mf-save:hover { background: #dbb85a; }
.mf-close  { background: transparent; border: 1px solid var(--border2); color: var(--dim); padding: 9px 14px; }
.mf-close:hover { border-color: var(--red); color: var(--red); }

/* SCROLLBAR */
::-webkit-scrollbar { width: 4px; }
::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 2px; }
::-webkit-scrollbar-track { background: transparent; }
</style>
</head>
<body>

<!-- HEADER -->
<header class="hdr">
  <div class="hdr-left">
    <div class="hdr-logo">WTI BRIEF</div>
    <div class="hdr-sub">Crude Oil ¬∑ Morning Monitor</div>
  </div>
  <div class="hdr-right">
    <div class="hdr-clock" id="clock"></div>
    <button class="btn-new" onclick="openModal()">+ NEW ENTRY</button>
  </div>
</header>

<!-- MAIN -->
<div class="wrap">
  <div class="empty" id="empty">
    <div class="e-icon">‚óà</div>
    <div>NO ENTRIES YET</div>
    <div style="margin-top:6px;font-size:9px">Click <strong style="color:var(--acc)">+ NEW ENTRY</strong> to add today's WTI brief</div>
  </div>
  <div id="cards"></div>
</div>

<!-- MODAL -->
<div id="overlay">
  <div id="modal">
    <div class="mhdr">
      <div class="mhdr-title" id="modal-title">‚óà NEW WTI ENTRY</div>
      <button class="mhdr-close" onclick="closeModal()">‚úï</button>
    </div>

    <div class="mbody">

      <!-- STEP 1: Îâ¥Ïä§ Î∂ôÏó¨ÎÑ£Í∏∞ -->
      <div id="step-parse">
        <div class="m-section-label">01 ¬∑ Îâ¥Ïä§ ÌÖçÏä§Ìä∏ Î∂ôÏó¨ÎÑ£Í∏∞ (ÏÑ†ÌÉù)</div>
        <textarea id="news-ta" placeholder="Ïó∞Ìï©¬∑KBS¬∑Ï¥àÏù¥Ïä§Í≤ΩÏ†ú Îì± WTI Îâ¥Ïä§ Í∏∞ÏÇ¨ Ï†ÑÎ¨∏ÏùÑ Î∂ôÏó¨ÎÑ£ÏúºÎ©¥ ÏàòÏπòÎ•º ÏûêÎèô Ïù∏ÏãùÌï©ÎãàÎã§.

ÏßÅÏ†ë ÏàòÏπò ÏûÖÎ†•ÎèÑ Í∞ÄÎä•Ìï©ÎãàÎã§ ‚Äî ÌååÏã± ÏóÜÏù¥ Î∞îÎ°ú ÏïÑÎûò ÌïÑÎìúÎ•º Ï±ÑÏõåÏ£ºÏÑ∏Ïöî."></textarea>
        <div class="parse-status" id="parse-st"></div>
      </div>

      <!-- STEP 2: ÏàòÏπò ÌïÑÎìú -->
      <div id="parsed-wrap">
        <div class="m-section-label">02 ¬∑ ÏàòÏπò ÌôïÏù∏ Î∞è ÏàòÏ†ï</div>
        <div class="pf-grid" style="margin-bottom:8px">
          <div class="pfield">
            <label>WTI Ï¢ÖÍ∞Ä ($/bbl) *</label>
            <input type="number" id="f-wti" step="0.01" placeholder="62.33" class="hi">
          </div>
          <div class="pfield">
            <label>Ï†ÑÏùºÊØî $</label>
            <input type="number" id="f-abs" step="0.01" placeholder="-0.56" oninput="autoPct()">
          </div>
          <div class="pfield">
            <label>Î≥ÄÎèôÎ•† %</label>
            <input type="number" id="f-pct" step="0.01" placeholder="-0.89">
          </div>
        </div>
        <div class="pf-grid" style="margin-bottom:8px">
          <div class="pfield">
            <label>Î∏åÎ†åÌä∏ Ï¢ÖÍ∞Ä ($/bbl)</label>
            <input type="number" id="f-brent" step="0.01" placeholder="67.29">
          </div>
          <div class="pfield">
            <label>Î∏åÎ†åÌä∏ Î≥ÄÎèôÎ•† %</label>
            <input type="number" id="f-brentpct" step="0.01" placeholder="-1.98">
          </div>
          <div class="pfield">
            <label>ÏõîÎ¨º</label>
            <select id="f-cont">
              <option value="Mar">3ÏõîÎ¨º (Mar)</option>
              <option value="Apr">4ÏõîÎ¨º (Apr)</option>
              <option value="May">5ÏõîÎ¨º (May)</option>
            </select>
          </div>
        </div>
        <div class="pf-grid-2">
          <div class="pfield">
            <label>Í∏∞Ï§ÄÏùº</label>
            <input type="date" id="f-date">
          </div>
          <div class="pfield">
            <label>Ï∂îÍ∞Ä ÏãúÏû• Î©îÎ™®</label>
            <input type="text" id="f-memo" placeholder="Nat.Gas -6.26% / DXY +0.24%">
          </div>
        </div>
      </div>

      <!-- STEP 3: ÏöîÏù∏ -->
      <div id="step-factors" style="display:none">
        <div class="m-section-label">03 ¬∑ Í∞ÄÍ≤© Î≥ÄÎèô ÏöîÏù∏ ÏÑ†ÌÉù</div>
        <div class="chip-group">‚ñº BEARISH ‚Äî ÌïòÎùΩ</div>
        <div class="chip-wrap" id="bear-chips"></div>
        <div class="chip-group" style="margin-top:10px">‚ñ≤ BULLISH ‚Äî ÏÉÅÏäπ</div>
        <div class="chip-wrap" id="bull-chips"></div>
      </div>

    </div>

    <div class="mftr">
      <button class="mf-btn mf-parse" id="btn-parse" onclick="doParse()">üîç ÌååÏã±</button>
      <button class="mf-btn mf-save"  id="btn-save"  onclick="doSave()">‚ñ∂ Ï†ÄÏû•</button>
      <button class="mf-btn mf-close"                onclick="closeModal()">Îã´Í∏∞</button>
    </div>
  </div>
</div>

<script>
// ‚îÄ‚îÄ‚îÄ CLOCK ‚îÄ‚îÄ‚îÄ
function tick() {
  const k = new Date(Date.now() + 9*3600000);
  document.getElementById('clock').textContent =
    k.toISOString().slice(0,10) + '  ' + k.toISOString().slice(11,19) + ' KST';
}
tick(); setInterval(tick, 1000);

// ‚îÄ‚îÄ‚îÄ FACTORS ‚îÄ‚îÄ‚îÄ
const FACTORS = [
  { t:'bear', kr:'ÎØ∏¬∑Ïù¥ÎûÄ Ìïµ ÌòëÏÉÅ ÏßÑÏ†Ñ',      en:'US-Iran nuclear deal progress',       kw:['Ïù¥ÎûÄ',['Ìï©Ïùò','ÏßÑÏ†Ñ']] },
  { t:'bear', kr:'Ï§ëÎèô ÏßÄÏ†ïÌïô Î¶¨Ïä§ÌÅ¨ ÏôÑÌôî',    en:'Easing Middle East risk premium',     kw:['Ï§ëÎèô','ÏôÑÌôî'] },
  { t:'bear', kr:'IEA ÏàòÏöî Ï†ÑÎßù ÌïòÌñ•',         en:'IEA demand forecast downgraded',      kw:['iea','ÌïòÌñ•'] },
  { t:'bear', kr:'OPEC+ Ï¶ùÏÇ∞ ÎÖºÏùò',            en:'OPEC+ output increase discussed',     kw:['opec','Ï¶ùÏÇ∞'] },
  { t:'bear', kr:'Ïπ¥ÏûêÌùê ÌÖ°Í∏∞Ï¶à Ïú†Ï†Ñ Ïû¨Í∞ú',    en:'Tengiz oilfield ramping up',          kw:[['ÌÖ°Í∏∞Ï¶à','Ïπ¥ÏûêÌùê']] },
  { t:'bear', kr:'ÎØ∏ ÏõêÏú† Ïû¨Í≥† Ï¶ùÍ∞Ä (EIA)',     en:'US crude inventory build (EIA)',      kw:['Ïû¨Í≥†','Ï¶ùÍ∞Ä'] },
  { t:'bear', kr:'Îã¨Îü¨ Í∞ïÏÑ∏',                  en:'USD strengthened (DXY up)',           kw:['Îã¨Îü¨','Í∞ïÏÑ∏'] },
  { t:'bear', kr:'Í≤ΩÍ∏∞Ïπ®Ï≤¥ Ïö∞Î†§',              en:'Recession/slowdown concerns',         kw:['Í≤ΩÍ∏∞Ïπ®Ï≤¥'] },
  { t:'bull', kr:'Ï§ëÎèô Í∏¥Ïû• Í≥†Ï°∞',             en:'Middle East tensions escalating',     kw:['Ï§ëÎèô','Í∏¥Ïû•'] },
  { t:'bull', kr:'Ìò∏Î•¥Î¨¥Ï¶à Ìï¥Ìòë Î¶¨Ïä§ÌÅ¨',       en:'Hormuz Strait disruption risk',       kw:['Ìò∏Î•¥Î¨¥Ï¶à'] },
  { t:'bull', kr:'OPEC+ Í∞êÏÇ∞ Ïú†ÏßÄ¬∑Í∞ïÌôî',       en:'OPEC+ maintained/deepened cuts',      kw:['opec','Í∞êÏÇ∞'] },
  { t:'bull', kr:'ÎØ∏ ÏõêÏú† Ïû¨Í≥† Í∞êÏÜå (EIA)',     en:'US crude inventory draw (EIA)',       kw:['Ïû¨Í≥†','Í∞êÏÜå'] },
  { t:'bull', kr:'IEA/EIA ÏàòÏöî Ï†ÑÎßù ÏÉÅÌñ•',     en:'IEA/EIA demand upgrade',              kw:['iea','ÏÉÅÌñ•'] },
  { t:'bull', kr:'Îã¨Îü¨ ÏïΩÏÑ∏',                  en:'USD weakened',                        kw:['Îã¨Îü¨','ÏïΩÏÑ∏'] },
];

const selF = new Set();
let editId = null;

// Build chips
function buildChips() {
  ['bear','bull'].forEach(t => {
    const c = document.getElementById(`${t}-chips`);
    c.innerHTML = '';
    FACTORS.forEach((f, i) => {
      if (f.t !== t) return;
      const ch = document.createElement('div');
      ch.className = 'chip' + (selF.has(i) ? ` sel-${t}` : '');
      ch.textContent = f.kr;
      ch.addEventListener('click', () => {
        if (selF.has(i)) { selF.delete(i); ch.className = 'chip'; }
        else { selF.add(i); ch.className = `chip sel-${t}`; }
      });
      c.appendChild(ch);
    });
  });
}

// Auto-detect factors from text
function autoDetect(txt) {
  const lo = txt.toLowerCase();
  selF.clear();
  FACTORS.forEach((f, i) => {
    const hit = f.kw.every(k => {
      if (Array.isArray(k)) return k.some(kk => lo.includes(kk));
      return lo.includes(k);
    });
    if (hit) selF.add(i);
  });
}

// ‚îÄ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ‚îÄ
function openModal(id = null) {
  editId = id;
  selF.clear();
  document.getElementById('modal-title').textContent = id !== null ? '‚óà EDIT ENTRY' : '‚óà NEW WTI ENTRY';
  document.getElementById('news-ta').value = '';
  document.getElementById('parse-st').style.display = 'none';
  document.getElementById('parsed-wrap').style.display = 'none';
  document.getElementById('step-factors').style.display = 'none';
  document.getElementById('btn-save').style.display = 'none';

  // Init date
  const today = new Date(Date.now() + 9*3600000).toISOString().slice(0,10);
  document.getElementById('f-date').value = today;
  ['f-wti','f-abs','f-pct','f-brent','f-brentpct','f-memo'].forEach(id => document.getElementById(id).value = '');
  document.getElementById('f-cont').value = 'Mar';

  if (id !== null) {
    // Load existing entry for edit
    const entries = getEntries();
    const e = entries.find(x => x.id === id);
    if (e) {
      document.getElementById('f-wti').value     = e.wti;
      document.getElementById('f-abs').value     = e.abs ?? '';
      document.getElementById('f-pct').value     = e.pct;
      document.getElementById('f-brent').value   = e.brent ?? '';
      document.getElementById('f-brentpct').value= e.brentPct ?? '';
      document.getElementById('f-cont').value    = e.cont;
      document.getElementById('f-date').value    = e.date;
      document.getElementById('f-memo').value    = e.memo ?? '';
      e.bears.concat(e.bulls).forEach(kr => {
        const idx = FACTORS.findIndex(f => f.kr === kr);
        if (idx >= 0) selF.add(idx);
      });
      showParsed(); showFactors();
    }
  }

  buildChips();
  document.getElementById('overlay').classList.add('open');
}

function closeModal() { document.getElementById('overlay').classList.remove('open'); }
document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });
document.getElementById('overlay').addEventListener('click', e => {
  if (e.target === document.getElementById('overlay')) closeModal();
});

function showParsed() {
  document.getElementById('parsed-wrap').style.display = 'block';
  document.getElementById('step-factors').style.display = 'block';
  document.getElementById('btn-save').style.display = 'block';
}
function showFactors() { document.getElementById('step-factors').style.display = 'block'; }

// ‚îÄ‚îÄ‚îÄ PARSE ‚îÄ‚îÄ‚îÄ
function doParse() {
  const txt = document.getElementById('news-ta').value.trim();

  // Even if no text, show fields for manual entry
  if (!txt) { showParsed(); buildChips(); showStatus('warn','ÌÖçÏä§Ìä∏ ÏóÜÏùå ‚Äî ÏïÑÎûò ÌïÑÎìúÏóê ÏßÅÏ†ë ÏûÖÎ†•ÌïòÏÑ∏Ïöî.'); return; }

  const f = {}; let m;

  // WTI
  m = txt.match(/(?:ÌïòÎùΩÌïú|Ïò§Î•∏|Î∞ÄÎ¶∞|ÎÇ¥Î¶∞)\s*Î∞∞Îü¥Îãπ\s*([\d.]+)Îã¨Îü¨/);
  if (m) f.wti = parseFloat(m[1]);
  if (!f.wti) { m = txt.match(/Î∞∞Îü¥Îãπ\s*[\d.]+%\s*(?:ÌïòÎùΩÌïú|ÏÉÅÏäπÌïú|Ïò§Î•∏)\s*([\d.]+)Îã¨Îü¨/); if (m) f.wti = parseFloat(m[1]); }

  // Ï†ÑÏùºÊØî
  const ws = (txt.match(/(?:WTI|ÏÑúÎ∂ÄÌÖçÏÇ¨Ïä§|ÌÖçÏÇ¨Ïä§ÏÇ∞ÏõêÏú†)[^\n„ÄÇ]{0,200}/) || [''])[0];
  m = ws.match(/([\d.]+)Îã¨Îü¨\(([\d.]+)%\)\s*(?:ÌïòÎùΩ|ÎÇ¥Î¶∞|Î∞ÄÎ¶∞|Îñ®Ïñ¥ÏßÑ)/);
  if (m) { f.abs = -parseFloat(m[1]); f.pct = -parseFloat(m[2]); }
  if (!f.abs) { m = txt.match(/([\d.]+)Îã¨Îü¨\(([\d.]+)%\)\s*(?:ÌïòÎùΩ|ÎÇ¥Î¶∞|Î∞ÄÎ¶∞|Îñ®Ïñ¥ÏßÑ)/); if (m) { f.abs = -parseFloat(m[1]); f.pct = -parseFloat(m[2]); } }
  if (!f.abs) { m = ws.match(/([\d.]+)Îã¨Îü¨\(([\d.]+)%\)\s*(?:ÏÉÅÏäπ|Ïò§Î•∏|Ïò¨Îùº)/); if (m) { f.abs = parseFloat(m[1]); f.pct = parseFloat(m[2]); } }
  if (!f.pct) { m = txt.match(/Î∞∞Îü¥Îãπ\s*([\d.]+)%\s*(ÌïòÎùΩ|ÏÉÅÏäπ)/); if (m) f.pct = m[2]==='ÌïòÎùΩ'?-parseFloat(m[1]):parseFloat(m[1]); }
  // Ïó≠ÏÇ∞ abs
  if (!f.abs && f.wti && f.pct) { const prev = f.wti / (1 + f.pct/100); f.abs = parseFloat((f.wti - prev).toFixed(2)); }

  // Î∏åÎ†åÌä∏
  const brs = txt.match(/Î∏åÎ†åÌä∏Ïú†[^\n„ÄÇ]{0,150}/g) || [];
  for (const s of brs) { const pm = s.match(/(?:Î∞∞Îü¥Îãπ|Í∞ÄÍ≤©ÏùÄ)\s*([\d.]+)Îã¨Îü¨/); if (pm && parseFloat(pm[1])>10) { f.brent=parseFloat(pm[1]); break; } }
  for (const s of brs) {
    let bm = s.match(/[\d.]+Îã¨Îü¨\(([\d.]+)%\)\s*(?:ÎÇ¥Î¶∞|ÌïòÎùΩÌïú|Îñ®Ïñ¥ÏßÑ)/); if (bm) { f.brentPct=-parseFloat(bm[1]); break; }
    bm = s.match(/Îã¨Îü¨Î°ú\s*([\d.]+)%\s*(ÌïòÎùΩ|ÏÉÅÏäπ)/); if (bm) { f.brentPct=bm[2]==='ÌïòÎùΩ'?-parseFloat(bm[1]):parseFloat(bm[1]); break; }
    bm = s.match(/\(([\d.]+)%\)\s*(?:ÎÇ¥Î¶∞|ÌïòÎùΩ)/); if (bm) { f.brentPct=-parseFloat(bm[1]); break; }
  }

  // Fill fields
  if (f.wti)     { document.getElementById('f-wti').value     = f.wti.toFixed(2); }
  if (f.abs)     { document.getElementById('f-abs').value     = f.abs.toFixed(2); }
  if (f.pct)     { document.getElementById('f-pct').value     = f.pct.toFixed(2); }
  if (f.brent)   { document.getElementById('f-brent').value   = f.brent.toFixed(2); }
  if (f.brentPct){ document.getElementById('f-brentpct').value= f.brentPct.toFixed(2); }

  autoDetect(txt);
  showParsed();
  buildChips();

  const ok = f.wti && f.pct !== undefined;
  showStatus(ok ? 'ok' : 'warn',
    ok ? `‚úì WTI $${f.wti.toFixed(2)} (${f.pct>=0?'+':''}${f.pct.toFixed(2)}%) ¬∑ ${selF.size}Í∞ú ÏöîÏù∏ ÏûêÎèô Í∞êÏßÄ` : '‚ö† ÏùºÎ∂Ä ÏàòÏπò ÎØ∏Ïù∏Ïãù ‚Äî ÏïÑÎûòÏóêÏÑú ÏßÅÏ†ë ÏàòÏ†ïÌïòÏÑ∏Ïöî.');
}

function showStatus(type, msg) {
  const el = document.getElementById('parse-st');
  el.style.display = 'block';
  el.className = `parse-status ${type}`;
  el.textContent = msg;
}

function autoPct() {
  const wti = parseFloat(document.getElementById('f-wti').value);
  const abs = parseFloat(document.getElementById('f-abs').value);
  if (wti && !isNaN(abs)) {
    const prev = wti - abs;
    if (prev > 0) document.getElementById('f-pct').value = (abs/prev*100).toFixed(2);
  }
}

// ‚îÄ‚îÄ‚îÄ SAVE ‚îÄ‚îÄ‚îÄ
function getEntries() { return JSON.parse(localStorage.getItem('wti_entries') || '[]'); }
function setEntries(arr) { localStorage.setItem('wti_entries', JSON.stringify(arr)); }

function doSave() {
  const wti  = parseFloat(document.getElementById('f-wti').value);
  const pct  = parseFloat(document.getElementById('f-pct').value);
  if (isNaN(wti) || isNaN(pct)) { showStatus('err','WTI Ï¢ÖÍ∞ÄÏôÄ Î≥ÄÎèôÎ•†ÏùÄ ÌïÑÏàòÏûÖÎãàÎã§.'); return; }

  const abs      = parseFloat(document.getElementById('f-abs').value) || null;
  const brent    = parseFloat(document.getElementById('f-brent').value) || null;
  const brentPct = parseFloat(document.getElementById('f-brentpct').value) || null;
  const cont     = document.getElementById('f-cont').value;
  const date     = document.getElementById('f-date').value;
  const memo     = document.getElementById('f-memo').value.trim() || null;

  const bears = [], bulls = [];
  selF.forEach(i => { FACTORS[i].t==='bear' ? bears.push(FACTORS[i].kr) : bulls.push(FACTORS[i].kr); });

  // Build commentary
  const pctStr = (pct>=0?'+':'')+pct.toFixed(2)+'%';
  const absStr = abs !== null ? (abs>=0?'+':'')+abs.toFixed(2) : null;
  const dir    = pct>0?'higher':pct<0?'lower':'unchanged';
  const dirKR  = pct>0?'ÏÉÅÏäπ':pct<0?'ÌïòÎùΩ':'Î≥¥Ìï©';
  const d      = new Date(date+'T00:00:00Z');
  const enDate = d.toLocaleDateString('en-US',{year:'numeric',month:'long',day:'numeric',timeZone:'UTC'});
  const krDate = date.replace(/-/g,'.');
  const contLabel = FACTORS; // just use cont directly

  const bearF = bears.map(kr => FACTORS.find(f=>f.kr===kr)).filter(Boolean);
  const bullF = bulls.map(kr => FACTORS.find(f=>f.kr===kr)).filter(Boolean);

  let en = `WTI (${cont}, NYMEX) settled ${dir} on ${enDate} at $${wti.toFixed(2)}/bbl`;
  if (absStr) en += ` (${absStr} USD, ${pctStr})`;
  if (brent && brentPct) en += `. Brent (ICE): $${brent.toFixed(2)}/bbl (${(brentPct>=0?'+':'')+brentPct.toFixed(2)}%)`;
  en += '.';
  if (bearF.length) en += '\n\nDownside: ' + bearF.map(f=>'‚Ä¢ '+f.en).join('  ');
  if (bullF.length) en += '\nUpside: ' + bullF.map(f=>'‚Ä¢ '+f.en).join('  ');
  if (memo) en += '\n\nMarket: ' + memo;

  let kr = `WTI ÏõêÏú†(${cont}ÏõîÎ¨º, NYMEX)Îäî ${krDate} Ï†Ñ Í±∞ÎûòÏùº ÎåÄÎπÑ`;
  if (absStr) kr += ` ${absStr} USD(${pctStr})`;
  kr += ` ${dirKR}Ìïú Î∞∞Îü¥Îãπ $${wti.toFixed(2)}Ïóê ÎßàÍ∞êÌñàÎã§.`;
  if (brent && brentPct) kr += ` Î∏åÎ†åÌä∏Ïú†(ICE) $${brent.toFixed(2)} (${(brentPct>=0?'+':'')+brentPct.toFixed(2)}%).`;
  if (bearF.length) kr += '\n\n‚ñº ÌïòÎùΩ ÏöîÏù∏\n' + bearF.map(f=>'‚Ä¢ '+f.kr).join('\n');
  if (bullF.length) kr += '\n\n‚ñ≤ ÏÉÅÏäπ ÏöîÏù∏\n' + bullF.map(f=>'‚Ä¢ '+f.kr).join('\n');
  if (pct<0 && bearF.length) kr += `\n\n${bearF[0].kr} Îì± ÌïòÎ∞© Ïû¨Î£å ÏïïÎ∞ïÏúºÎ°ú ÏïΩÏÑ∏ ÎßàÍ∞ê.`;
  else if (pct>0 && bullF.length) kr += `\n\n${bullF[0].kr} Îì±Ïù¥ Ïú†Í∞ÄÎ•º ÏßÄÏßÄÌïòÎ©∞ Í∞ïÏÑ∏ ÎßàÍ∞ê.`;
  if (memo) kr += '\n\n[Í¥ÄÎ†® ÏãúÏû•] ' + memo;

  const entry = {
    id: editId !== null ? editId : Date.now(),
    wti, abs, pct, brent, brentPct, cont, date, memo, bears, bulls, en, kr,
    savedAt: new Date().toISOString()
  };

  let entries = getEntries();
  if (editId !== null) {
    entries = entries.map(e => e.id === editId ? entry : e);
  } else {
    entries.unshift(entry);
  }
  setEntries(entries);
  renderAll();
  closeModal();
}

// ‚îÄ‚îÄ‚îÄ DELETE ‚îÄ‚îÄ‚îÄ
function deleteEntry(id) {
  if (!confirm('Ïù¥ Ìï≠Î™©ÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return;
  setEntries(getEntries().filter(e => e.id !== id));
  renderAll();
}

// ‚îÄ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ‚îÄ
function renderAll() {
  const entries = getEntries();
  const empty = document.getElementById('empty');
  const cards = document.getElementById('cards');
  empty.style.display = entries.length ? 'none' : 'block';
  cards.innerHTML = entries.map(e => renderCard(e)).join('');
}

function renderCard(e) {
  const pct    = e.pct;
  const dir    = pct>0?'up':pct<0?'dn':'flt';
  const arrow  = pct>0?'‚ñ≤':pct<0?'‚ñº':'‚îÄ';
  const pctStr = (pct>=0?'+':'')+pct.toFixed(2)+'%';
  const absStr = e.abs!==null ? (e.abs>=0?'+':'')+e.abs.toFixed(2)+' USD' : '';
  const krDate = e.date.replace(/-/g,'.');

  const bearItems = e.bears.map(kr => {
    const f = FACTORS.find(x => x.kr === kr);
    return f ? `<div class="factor-item"><span class="fi-bullet bear">‚ñº</span><div><div class="fi-kr">${f.kr}</div><div class="fi-en">${f.en}</div></div></div>` : '';
  }).join('');

  const bullItems = e.bulls.map(kr => {
    const f = FACTORS.find(x => x.kr === kr);
    return f ? `<div class="factor-item"><span class="fi-bullet bull">‚ñ≤</span><div><div class="fi-kr">${f.kr}</div><div class="fi-en">${f.en}</div></div></div>` : '';
  }).join('');

  const hasFactors = bearItems || bullItems;

  return `<div class="brief" id="card-${e.id}">
    <div class="brief-strip">
      <div class="strip-date">
        <div class="sd-date">${krDate}</div>
        <div class="sd-cont">NYMEX ¬∑ ${e.cont}ÏõîÎ¨º</div>
      </div>
      <div class="strip-price">
        <div class="sp-val ${dir}">${arrow} ${e.wti.toFixed(2)}</div>
        <div class="sp-unit">USD / bbl</div>
        <div class="sp-delta">
          ${absStr ? `<div class="sp-d-row"><span class="sp-d-label">Œî$</span><span class="sp-d-val ${dir}">${absStr}</span></div>` : ''}
          <div class="sp-d-row"><span class="sp-d-label">Œî%</span><span class="sp-d-val ${dir}">${pctStr}</span></div>
        </div>
      </div>
      ${e.brent ? `<div class="strip-brent">
        <div class="sb-label">Brent ICE</div>
        <div class="sb-val">$${e.brent.toFixed(2)}</div>
        ${e.brentPct!==null ? `<div class="sb-chg ${e.brentPct>=0?'up':'dn'}">${(e.brentPct>=0?'+':'')+e.brentPct.toFixed(2)}%</div>` : ''}
      </div>` : ''}
      <div class="strip-actions">
        <button class="act-btn edit" onclick="openModal(${e.id})">‚úé EDIT</button>
        <button class="act-btn del"  onclick="deleteEntry(${e.id})">‚úï DEL</button>
      </div>
    </div>

    ${hasFactors ? `<div class="brief-body">
      <div class="factors-row">
        ${bearItems ? `<div class="factor-col">
          <div class="fc-title bear"><span class="fc-dot bear"></span>Bearish ¬∑ ÌïòÎùΩ ÏöîÏù∏</div>
          ${bearItems}
        </div>` : ''}
        ${bullItems ? `<div class="factor-col">
          <div class="fc-title bull"><span class="fc-dot bull"></span>Bullish ¬∑ ÏÉÅÏäπ ÏöîÏù∏</div>
          ${bullItems}
        </div>` : ''}
      </div>
      ${e.memo ? `<div class="brief-memo"><div class="memo-label">Related Markets</div>${e.memo}</div>` : ''}
    </div>` : ''}

    <div class="brief-commentary">
      <div class="co-pane">
        <div class="co-label">EN</div>
        <div class="co-text en">${e.en}</div>
      </div>
      <div class="co-pane">
        <div class="co-label">KR</div>
        <div class="co-text">${e.kr}</div>
      </div>
    </div>

    <div class="brief-copy">
      <button class="cp-btn" onclick="copyText('${e.id}','en')">Copy EN</button>
      <button class="cp-btn" onclick="copyText('${e.id}','kr')">Copy KR</button>
      <button class="cp-btn pri" onclick="copyText('${e.id}','both')">‚ßâ Copy Both</button>
    </div>
  </div>`;
}

function copyText(id, type) {
  const e = getEntries().find(x => x.id == id);
  if (!e) return;
  let txt = type==='en' ? e.en : type==='kr' ? e.kr : e.en + '\n\n' + '‚îÅ'.repeat(48) + '\n\n' + e.kr;
  navigator.clipboard.writeText(txt).then(() => {
    // flash the button
    const btns = document.querySelectorAll(`#card-${id} .cp-btn`);
    btns.forEach(b => { if (b.textContent.toLowerCase().includes(type==='both'?'both':type)) { b.classList.add('ok'); setTimeout(()=>b.classList.remove('ok'),1800); } });
  });
}

// INIT
renderAll();
</script>
</body>
</html>
