<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WTI MORNING BRIEF</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Mono:ital,wght@0,300;0,400;0,500;1,300&family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg:       #1a1f2e;
  --surface:  #222838;
  --card:     #262d3f;
  --inset:    #1e2434;
  --border:   #323d55;
  --border2:  #3d4d6a;
  --acc:      #e8c46a;
  --acc2:     #5b9cf6;
  --green:    #34d875;
  --red:      #f26b6b;
  --text:     #e2e8f4;
  --text2:    #b0bcd4;
  --dim:      #6a7a99;
  --quote:    #c8d6f0;
  --mono:     'DM Mono', monospace;
  --sans:     'Noto Sans KR', sans-serif;
  --display:  'Bebas Neue', sans-serif;
}
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html, body { min-height: 100%; background: var(--bg); color: var(--text); font-family: var(--sans); }

/* HEADER */
.hdr {
  position: sticky; top: 0; z-index: 100;
  background: rgba(26,31,46,.96); backdrop-filter: blur(14px);
  border-bottom: 1px solid var(--border);
  display: flex; align-items: center; justify-content: space-between;
  padding: 0 32px; height: 62px;
}
.hdr-left  { display: flex; align-items: baseline; gap: 16px; }
.hdr-logo  { font-family: var(--display); font-size: 30px; letter-spacing: .12em; color: var(--acc); }
.hdr-sub   { font-family: var(--mono); font-size: 11px; letter-spacing: .18em; color: var(--dim); text-transform: uppercase; }
.hdr-right { display: flex; align-items: center; gap: 14px; }
.hdr-clock { font-family: var(--mono); font-size: 13px; color: var(--text2); }
.btn-new {
  display: flex; align-items: center; gap: 7px;
  background: var(--acc); color: #1a1f2e; border: none; border-radius: 4px;
  padding: 9px 20px; font-family: var(--mono); font-size: 12px;
  font-weight: 500; letter-spacing: .12em; text-transform: uppercase; cursor: pointer; transition: background .15s;
}
.btn-new:hover { background: #f0d080; }

/* LAYOUT */
.wrap { max-width: 980px; margin: 0 auto; padding: 32px 24px 80px; }
.empty { text-align: center; padding: 90px 0; font-family: var(--mono); font-size: 12px; letter-spacing: .12em; color: var(--dim); }
.empty .e-icon { font-size: 40px; margin-bottom: 18px; opacity: .25; }

/* BRIEF CARD */
.brief {
  background: var(--surface); border: 1px solid var(--border); border-radius: 6px;
  margin-bottom: 24px; overflow: hidden;
  box-shadow: 0 4px 24px rgba(0,0,0,.2);
  animation: fadeUp .28s ease both;
}
@keyframes fadeUp { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:none} }

/* PRICE STRIP */
.brief-strip { display: flex; align-items: stretch; border-bottom: 1px solid var(--border); background: var(--card); }
.strip-date {
  padding: 20px 26px; border-right: 1px solid var(--border);
  display: flex; flex-direction: column; justify-content: center; gap: 5px; min-width: 170px;
}
.sd-date { font-family: var(--mono); font-size: 16px; color: var(--text); font-weight: 500; }
.sd-cont { font-family: var(--mono); font-size: 11px; color: var(--dim); }

.strip-price { flex: 1; display: flex; align-items: center; padding: 20px 30px; gap: 28px; }
.sp-val { font-family: var(--display); font-size: 72px; letter-spacing: .02em; line-height: 1; }
.sp-val.up  { color: var(--green); }
.sp-val.dn  { color: var(--red); }
.sp-val.flt { color: var(--text); }
.sp-unit { font-family: var(--mono); font-size: 13px; color: var(--dim); align-self: flex-end; padding-bottom: 8px; }
.sp-delta { display: flex; flex-direction: column; gap: 8px; padding-left: 28px; border-left: 1px solid var(--border); }
.sp-d-row   { display: flex; align-items: center; gap: 10px; }
.sp-d-label { font-family: var(--mono); font-size: 10px; letter-spacing: .1em; color: var(--dim); width: 32px; text-transform: uppercase; }
.sp-d-val   { font-family: var(--mono); font-size: 19px; font-weight: 500; }
.sp-d-val.up { color: var(--green); }
.sp-d-val.dn { color: var(--red); }

.strip-brent {
  padding: 20px 26px; border-left: 1px solid var(--border);
  display: flex; flex-direction: column; justify-content: center; gap: 6px; min-width: 155px;
}
.sb-label { font-family: var(--mono); font-size: 10px; letter-spacing: .14em; color: var(--dim); text-transform: uppercase; }
.sb-val   { font-family: var(--mono); font-size: 22px; font-weight: 500; color: var(--text); }
.sb-chg   { font-family: var(--mono); font-size: 13px; }
.sb-chg.up { color: var(--green); } .sb-chg.dn { color: var(--red); }

.strip-actions { display: flex; flex-direction: column; border-left: 1px solid var(--border); }
.act-btn {
  flex: 1; display: flex; align-items: center; justify-content: center;
  background: transparent; border: none; cursor: pointer;
  font-family: var(--mono); font-size: 11px; letter-spacing: .1em; color: var(--dim);
  padding: 0 20px; transition: all .15s; text-transform: uppercase; gap: 5px;
  border-bottom: 1px solid var(--border);
}
.act-btn:last-child { border-bottom: none; }
.act-btn.edit:hover { background: rgba(91,156,246,.1); color: var(--acc2); }
.act-btn.del:hover  { background: rgba(242,107,107,.08); color: var(--red); }

/* BODY */
.brief-body { padding: 22px 26px; border-bottom: 1px solid var(--border); }
.factors-row { display: flex; gap: 20px; margin-bottom: 0; }
.factor-col  { flex: 1; }
.fc-title {
  font-family: var(--mono); font-size: 10px; letter-spacing: .16em; text-transform: uppercase;
  padding-bottom: 9px; margin-bottom: 10px; border-bottom: 1px solid var(--border);
  display: flex; align-items: center; gap: 7px;
}
.fc-title.bear { color: var(--red); }
.fc-title.bull { color: var(--green); }
.fc-dot { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; }
.fc-dot.bear { background: var(--red); }
.fc-dot.bull { background: var(--green); }
.factor-item {
  display: flex; align-items: flex-start; gap: 10px;
  padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,.05);
}
.factor-item:last-child { border-bottom: none; }
.fi-bullet      { font-family: var(--mono); font-size: 12px; flex-shrink: 0; margin-top: 2px; }
.fi-bullet.bear { color: var(--red); }
.fi-bullet.bull { color: var(--green); }
.fi-kr { font-size: 15px; font-weight: 500; color: var(--text); }
.fi-en { font-family: var(--mono); font-size: 11px; color: var(--dim); margin-top: 3px; }

/* ì°¸ê³  ì›ë¬¸ */
.source-quote {
  background: var(--inset); border: 1px solid var(--border);
  border-left: 3px solid var(--acc); border-radius: 4px;
  padding: 13px 17px; margin-top: 18px;
}
.sq-label {
  font-family: var(--mono); font-size: 9px; letter-spacing: .16em; text-transform: uppercase;
  color: var(--acc); margin-bottom: 8px; display: flex; align-items: center; gap: 6px;
}
.sq-text {
  font-size: 14px; line-height: 1.8; color: var(--quote); font-style: italic;
}
.sq-text::before { content: '"'; color: var(--acc); font-size: 20px; line-height: 0; vertical-align: -4px; margin-right: 3px; }
.sq-text::after  { content: '"'; color: var(--acc); font-size: 20px; line-height: 0; vertical-align: -4px; margin-left: 3px; }

/* MEMO */
.brief-memo {
  margin-top: 14px; padding: 11px 16px;
  background: var(--inset); border: 1px solid var(--border); border-radius: 4px;
  font-family: var(--mono); font-size: 12px; color: var(--text2); line-height: 1.7;
}
.memo-label { font-size: 9px; letter-spacing: .14em; text-transform: uppercase; color: var(--dim); margin-bottom: 5px; }

/* COMMENTARY */
.brief-commentary { display: grid; grid-template-columns: 1fr 1fr; border-bottom: 1px solid var(--border); }
.co-pane { padding: 20px 26px; }
.co-pane:first-child { border-right: 1px solid var(--border); }
.co-label {
  font-family: var(--mono); font-size: 10px; letter-spacing: .16em; text-transform: uppercase;
  color: var(--dim); margin-bottom: 11px; display: flex; align-items: center; gap: 8px;
}
.co-label::after { content: ''; flex: 1; height: 1px; background: var(--border); }
.co-text    { font-size: 14px; line-height: 1.9; color: var(--text2); white-space: pre-wrap; }
.co-text.en { font-family: var(--mono); font-size: 12px; }

/* COPY ROW */
.brief-copy {
  padding: 13px 26px; display: flex; align-items: center; justify-content: flex-end; gap: 8px;
  background: var(--card);
}
.cp-btn {
  font-family: var(--mono); font-size: 11px; letter-spacing: .08em; text-transform: uppercase;
  background: transparent; border: 1px solid var(--border2); color: var(--dim);
  padding: 7px 16px; border-radius: 3px; cursor: pointer; transition: all .15s;
}
.cp-btn:hover { border-color: var(--acc); color: var(--acc); }
.cp-btn.pri   { background: var(--acc2); color: #fff; border-color: var(--acc2); }
.cp-btn.pri:hover { background: #4a8ef0; }
.cp-btn.ok    { border-color: var(--green); color: var(--green); }

/* MODAL */
#overlay {
  position: fixed; inset: 0; z-index: 200;
  background: rgba(14,18,30,.88); backdrop-filter: blur(10px);
  display: none; align-items: center; justify-content: center;
}
#overlay.open { display: flex; }
#modal {
  width: 720px; max-height: 92vh;
  background: var(--surface); border: 1px solid var(--border2); border-radius: 8px;
  display: flex; flex-direction: column; overflow: hidden;
  box-shadow: 0 32px 80px rgba(0,0,0,.5); animation: mIn .2s ease;
}
@keyframes mIn { from{opacity:0;transform:translateY(14px) scale(.98)} to{opacity:1;transform:none} }
.mhdr {
  display: flex; align-items: center; justify-content: space-between;
  padding: 16px 24px; border-bottom: 1px solid var(--border); background: var(--card); flex-shrink: 0;
}
.mhdr-title { font-family: var(--mono); font-size: 13px; letter-spacing: .14em; text-transform: uppercase; color: var(--acc); }
.mhdr-close {
  background: transparent; border: 1px solid var(--border2); color: var(--dim);
  width: 30px; height: 30px; border-radius: 3px; cursor: pointer; font-size: 16px;
  display: flex; align-items: center; justify-content: center; transition: all .15s;
}
.mhdr-close:hover { border-color: var(--red); color: var(--red); }
.mbody { flex: 1; overflow-y: auto; padding: 22px 24px; display: flex; flex-direction: column; gap: 18px; }
.m-section-label { font-family: var(--mono); font-size: 10px; letter-spacing: .18em; text-transform: uppercase; color: var(--dim); margin-bottom: 8px; }
#news-ta {
  width: 100%; height: 150px; resize: vertical;
  background: var(--card); border: 1px solid var(--border); border-radius: 4px;
  color: var(--text); font-family: var(--sans); font-size: 13px; line-height: 1.72;
  padding: 12px 14px; outline: none; transition: border-color .15s;
}
#news-ta:focus { border-color: var(--acc2); }
#news-ta::placeholder { color: var(--dim); font-size: 12px; }
#parsed-wrap { display: none; }
.pf-grid   { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
.pf-grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
.pfield { display: flex; flex-direction: column; gap: 5px; }
.pfield label { font-family: var(--mono); font-size: 10px; letter-spacing: .1em; text-transform: uppercase; color: var(--dim); }
.pfield input, .pfield select {
  background: var(--card); border: 1px solid var(--border); border-radius: 4px;
  color: var(--text); font-family: var(--mono); font-size: 15px;
  padding: 9px 11px; outline: none; width: 100%; transition: border-color .15s;
}
.pfield input:focus, .pfield select:focus { border-color: var(--acc2); }
.pfield input.hi { color: var(--acc); border-color: rgba(232,196,106,.35); }
.pfield input.up { color: var(--green); }
.pfield input.dn { color: var(--red); }
.parse-status {
  font-family: var(--mono); font-size: 12px; padding: 9px 13px;
  border-radius: 4px; margin-top: 6px; display: none;
}
.parse-status.ok   { background: rgba(52,216,117,.08); border: 1px solid rgba(52,216,117,.25); color: var(--green); }
.parse-status.warn { background: rgba(232,196,106,.08); border: 1px solid rgba(232,196,106,.25); color: var(--acc); }
.parse-status.err  { background: rgba(242,107,107,.08); border: 1px solid rgba(242,107,107,.25); color: var(--red); }
.chip-wrap  { display: flex; flex-wrap: wrap; gap: 7px; }
.chip-group { margin-bottom: 6px; font-family: var(--mono); font-size: 10px; letter-spacing: .14em; text-transform: uppercase; color: var(--dim); }
.chip {
  font-family: var(--mono); font-size: 11px; letter-spacing: .04em;
  padding: 5px 13px; border-radius: 3px; border: 1px solid var(--border2);
  color: var(--dim); cursor: pointer; transition: all .12s; user-select: none;
}
.chip:hover { color: var(--text2); border-color: var(--dim); }
.chip.sel-bear { background: rgba(242,107,107,.1); border-color: rgba(242,107,107,.45); color: var(--red); }
.chip.sel-bull { background: rgba(52,216,117,.1);  border-color: rgba(52,216,117,.45);  color: var(--green); }
.mftr { flex-shrink: 0; padding: 14px 24px; border-top: 1px solid var(--border); display: flex; gap: 8px; background: var(--card); }
.mf-btn { padding: 11px 18px; border: none; border-radius: 4px; cursor: pointer; font-family: var(--mono); font-size: 12px; letter-spacing: .1em; text-transform: uppercase; font-weight: 500; transition: all .15s; }
.mf-parse       { flex: 1; background: var(--border2); color: var(--text); }
.mf-parse:hover { background: var(--acc2); color: #fff; }
.mf-save        { flex: 2; background: var(--acc); color: #1a1f2e; display: none; }
.mf-save:hover  { background: #f0d080; }
.mf-close { background: transparent; border: 1px solid var(--border2); color: var(--dim); padding: 11px 16px; border-radius: 4px; cursor: pointer; font-family: var(--mono); font-size: 12px; transition: all .15s; }
.mf-close:hover { border-color: var(--red); color: var(--red); }
::-webkit-scrollbar { width: 5px; }
::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 3px; }
</style>
</head>
<body>

<header class="hdr">
  <div class="hdr-left">
    <div class="hdr-logo">WTI BRIEF</div>
    <div class="hdr-sub">Crude Oil Â· Morning Monitor</div>
  </div>
  <div class="hdr-right">
    <div class="hdr-clock" id="clock"></div>
    <button class="btn-new" onclick="openModal()">+ NEW ENTRY</button>
  </div>
</header>

<div class="wrap">
  <div class="empty" id="empty">
    <div class="e-icon">â—ˆ</div>
    <div>NO ENTRIES YET</div>
    <div style="margin-top:8px;font-size:10px">Click <strong style="color:var(--acc)">+ NEW ENTRY</strong> to add today's WTI brief</div>
  </div>
  <div id="cards"></div>
</div>

<div id="overlay">
  <div id="modal">
    <div class="mhdr">
      <div class="mhdr-title" id="modal-title">â—ˆ NEW WTI ENTRY</div>
      <button class="mhdr-close" onclick="closeModal()">âœ•</button>
    </div>
    <div class="mbody">
      <div>
        <div class="m-section-label">01 Â· ë‰´ìŠ¤ í…ìŠ¤íŠ¸ ë¶™ì—¬ë„£ê¸°</div>
        <textarea id="news-ta" placeholder="ì—°í•©Â·KBSÂ·ì´ˆì´ìŠ¤ê²½ì œ ë“± WTI ë‰´ìŠ¤ ê¸°ì‚¬ ì „ë¬¸ì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.
ìˆ˜ì¹˜ ìë™ íŒŒì‹± + í•µì‹¬ ì°¸ê³  ë¬¸ì¥ ìë™ ì¶”ì¶œ

í…ìŠ¤íŠ¸ ì—†ì´ íŒŒì‹± ë²„íŠ¼ â†’ ìˆ˜ë™ ì…ë ¥ ëª¨ë“œ"></textarea>
        <div class="parse-status" id="parse-st"></div>
      </div>
      <div id="parsed-wrap">
        <div class="m-section-label">02 Â· ìˆ˜ì¹˜ í™•ì¸ ë° ìˆ˜ì •</div>
        <div class="pf-grid" style="margin-bottom:10px">
          <div class="pfield"><label>WTI ì¢…ê°€ ($/bbl) *</label><input type="number" id="f-wti" step="0.01" placeholder="62.33" class="hi"></div>
          <div class="pfield"><label>ì „ì¼æ¯” $</label><input type="number" id="f-abs" step="0.01" placeholder="-0.56" oninput="autoPct()"></div>
          <div class="pfield"><label>ë³€ë™ë¥  %</label><input type="number" id="f-pct" step="0.01" placeholder="-0.89"></div>
        </div>
        <div class="pf-grid" style="margin-bottom:10px">
          <div class="pfield"><label>ë¸Œë ŒíŠ¸ ($/bbl)</label><input type="number" id="f-brent" step="0.01" placeholder="67.29"></div>
          <div class="pfield"><label>ë¸Œë ŒíŠ¸ ë³€ë™ë¥  %</label><input type="number" id="f-brentpct" step="0.01" placeholder="-1.98"></div>
          <div class="pfield"><label>ì›”ë¬¼</label>
            <select id="f-cont">
              <option value="Mar">3ì›”ë¬¼ (Mar)</option>
              <option value="Apr">4ì›”ë¬¼ (Apr)</option>
              <option value="May">5ì›”ë¬¼ (May)</option>
            </select>
          </div>
        </div>
        <div class="pf-grid-2">
          <div class="pfield"><label>ê¸°ì¤€ì¼</label><input type="date" id="f-date"></div>
          <div class="pfield"><label>ê´€ë ¨ ì‹œì¥ ë©”ëª¨</label><input type="text" id="f-memo" placeholder="Nat.Gas -6.26% / DXY +0.24%"></div>
        </div>
      </div>
      <div id="step-factors" style="display:none">
        <div class="m-section-label">03 Â· ê°€ê²© ë³€ë™ ìš”ì¸ ì„ íƒ</div>
        <div class="chip-group">â–¼ BEARISH â€” í•˜ë½ ìš”ì¸</div>
        <div class="chip-wrap" id="bear-chips"></div>
        <div class="chip-group" style="margin-top:12px">â–² BULLISH â€” ìƒìŠ¹ ìš”ì¸</div>
        <div class="chip-wrap" id="bull-chips"></div>
      </div>
    </div>
    <div class="mftr">
      <button class="mf-btn mf-parse" id="btn-parse" onclick="doParse()">ğŸ” íŒŒì‹±</button>
      <button class="mf-btn mf-save"  id="btn-save"  onclick="doSave()">â–¶ ì €ì¥</button>
      <button class="mf-close"                        onclick="closeModal()">ë‹«ê¸°</button>
    </div>
  </div>
</div>

<script>
// CLOCK
function tick() {
  const k = new Date(Date.now() + 9*3600000);
  document.getElementById('clock').textContent =
    k.toISOString().slice(0,10) + '  ' + k.toISOString().slice(11,19) + ' KST';
}
tick(); setInterval(tick, 1000);

// FACTORS
const FACTORS = [
  { t:'bear', kr:'ë¯¸Â·ì´ë€ í•µ í˜‘ìƒ ì§„ì „',       en:'US-Iran nuclear deal progress',       kw:['ì´ë€',['í•©ì˜','ì§„ì „']] },
  { t:'bear', kr:'ì¤‘ë™ ì§€ì •í•™ ë¦¬ìŠ¤í¬ ì™„í™”',     en:'Easing Middle East risk premium',     kw:['ì¤‘ë™','ì™„í™”'] },
  { t:'bear', kr:'IEA ìˆ˜ìš” ì „ë§ í•˜í–¥',           en:'IEA demand forecast downgraded',      kw:['iea','í•˜í–¥'] },
  { t:'bear', kr:'OPEC+ ì¦ì‚° ë…¼ì˜',              en:'OPEC+ output increase discussed',     kw:['opec','ì¦ì‚°'] },
  { t:'bear', kr:'ì¹´ìí í…¡ê¸°ì¦ˆ ìœ ì „ ì¬ê°œ',      en:'Tengiz oilfield ramping up',          kw:[['í…¡ê¸°ì¦ˆ','ì¹´ìí']] },
  { t:'bear', kr:'ë¯¸ ì›ìœ  ì¬ê³  ì¦ê°€ (EIA)',       en:'US crude inventory build (EIA)',      kw:['ì¬ê³ ','ì¦ê°€'] },
  { t:'bear', kr:'ë‹¬ëŸ¬ ê°•ì„¸',                    en:'USD strengthened (DXY up)',           kw:['ë‹¬ëŸ¬','ê°•ì„¸'] },
  { t:'bear', kr:'ê²½ê¸°ì¹¨ì²´ ìš°ë ¤',                en:'Recession/slowdown concerns',         kw:['ê²½ê¸°ì¹¨ì²´'] },
  { t:'bull', kr:'ì¤‘ë™ ê¸´ì¥ ê³ ì¡°',               en:'Middle East tensions escalating',     kw:['ì¤‘ë™','ê¸´ì¥'] },
  { t:'bull', kr:'í˜¸ë¥´ë¬´ì¦ˆ í•´í˜‘ ë¦¬ìŠ¤í¬',         en:'Hormuz Strait disruption risk',       kw:['í˜¸ë¥´ë¬´ì¦ˆ'] },
  { t:'bull', kr:'OPEC+ ê°ì‚° ìœ ì§€Â·ê°•í™”',         en:'OPEC+ maintained/deepened cuts',      kw:['opec','ê°ì‚°'] },
  { t:'bull', kr:'ë¯¸ ì›ìœ  ì¬ê³  ê°ì†Œ (EIA)',       en:'US crude inventory draw (EIA)',       kw:['ì¬ê³ ','ê°ì†Œ'] },
  { t:'bull', kr:'IEA/EIA ìˆ˜ìš” ì „ë§ ìƒí–¥',       en:'IEA/EIA demand upgrade',              kw:['iea','ìƒí–¥'] },
  { t:'bull', kr:'ë‹¬ëŸ¬ ì•½ì„¸',                    en:'USD weakened',                        kw:['ë‹¬ëŸ¬','ì•½ì„¸'] },
];

const selF = new Set();
let editId = null, parsedQuote = null;

// ì°¸ê³  ì›ë¬¸ ì¶”ì¶œ â€” ì¸ê³¼ êµ¬ì¡° ë¬¸ì¥ ìš°ì„ 
function extractQuote(txt) {
  const sents = txt
    .split(/(?<=[ë‹¤ìŠµë‹ˆë‹¤ê¹Œìš”]\.)\s+/)
    .map(s => s.replace(/^\s+|\s+$/g,''))
    .filter(s => s.length > 20 && s.length < 220);

  const causal = [
    /ê°€ìš´ë°.{4,50}(?:í•˜ë½|ìƒìŠ¹|ì•½ì„¸|ê°•ì„¸|ë§ˆê°)/,
    /ì†Œì‹[ì´ì—].{2,40}(?:í•˜ë½|ìƒìŠ¹|ì••ë°•|ì§€ì§€|ì˜í–¥)/,
    /ì˜í–¥ìœ¼ë¡œ.{4,40}(?:í•˜ë½|ìƒìŠ¹|ë§ˆê°)/,
    /ìš°ë ¤[ê°€ì—].{4,40}(?:í•˜ë½|ìƒìŠ¹|ì‘ìš©|ë¶€ë‹´)/,
    /(?:í•˜ë½|ìƒìŠ¹)ì„¸ë¥¼\s*ë³´ì˜€/,
    /(?:í•˜ë½|ìƒìŠ¹)ì„\s*(?:ë¶€ì¶”|ì§€ì§€|ê²¬ì¸|ì£¼ë„)/,
    /(?:í•˜ë½|ìƒìŠ¹)[^\n]{0,30}(?:ì†Œì‹|ì¬ë£Œ|ìš”ì¸|ì˜í–¥)/,
  ];
  for (const p of causal) {
    const found = sents.find(s => p.test(s));
    if (found) return found.replace(/^[^ê°€-í£a-zA-Z\$\d]+/,'').trim();
  }
  // fallback: ê°€ê²© ì–¸ê¸‰ + ì´ìœ  í‚¤ì›Œë“œ í¬í•¨ ë¬¸ì¥
  const fallback = sents.find(s =>
    /ë‹¬ëŸ¬|ë°°ëŸ´/.test(s) && /ë•Œë¬¸|ì´ìœ |ë”°ë¼|ì†ì—|ê°€ìš´ë°|ì˜í–¥/.test(s)
  );
  return fallback ? fallback.replace(/^[^ê°€-í£a-zA-Z\$\d]+/,'').trim() : null;
}

// MODAL
function openModal(id = null) {
  editId = id; selF.clear(); parsedQuote = null;
  document.getElementById('modal-title').textContent = id !== null ? 'â—ˆ EDIT ENTRY' : 'â—ˆ NEW WTI ENTRY';
  document.getElementById('news-ta').value = '';
  document.getElementById('parse-st').style.display = 'none';
  document.getElementById('parsed-wrap').style.display = 'none';
  document.getElementById('step-factors').style.display = 'none';
  document.getElementById('btn-save').style.display = 'none';
  const today = new Date(Date.now() + 9*3600000).toISOString().slice(0,10);
  document.getElementById('f-date').value = today;
  ['f-wti','f-abs','f-pct','f-brent','f-brentpct','f-memo'].forEach(i => document.getElementById(i).value = '');
  document.getElementById('f-cont').value = 'Mar';
  if (id !== null) {
    const e = getEntries().find(x => x.id === id);
    if (e) {
      document.getElementById('f-wti').value      = e.wti;
      document.getElementById('f-abs').value      = e.abs ?? '';
      document.getElementById('f-pct').value      = e.pct;
      document.getElementById('f-brent').value    = e.brent ?? '';
      document.getElementById('f-brentpct').value = e.brentPct ?? '';
      document.getElementById('f-cont').value     = e.cont;
      document.getElementById('f-date').value     = e.date;
      document.getElementById('f-memo').value     = e.memo ?? '';
      parsedQuote = e.quote ?? null;
      e.bears.concat(e.bulls).forEach(kr => {
        const idx = FACTORS.findIndex(f => f.kr === kr);
        if (idx >= 0) selF.add(idx);
      });
      document.getElementById('parsed-wrap').style.display = 'block';
      document.getElementById('step-factors').style.display = 'block';
      document.getElementById('btn-save').style.display = 'block';
    }
  }
  buildChips();
  document.getElementById('overlay').classList.add('open');
}
function closeModal() { document.getElementById('overlay').classList.remove('open'); }
document.addEventListener('keydown', e => { if (e.key==='Escape') closeModal(); });
document.getElementById('overlay').addEventListener('click', e => { if (e.target===document.getElementById('overlay')) closeModal(); });

function buildChips() {
  ['bear','bull'].forEach(t => {
    const c = document.getElementById(`${t}-chips`); c.innerHTML = '';
    FACTORS.forEach((f,i) => {
      if (f.t!==t) return;
      const ch = document.createElement('div');
      ch.className = 'chip' + (selF.has(i) ? ` sel-${t}` : '');
      ch.textContent = f.kr;
      ch.addEventListener('click', () => {
        selF.has(i) ? (selF.delete(i), ch.className='chip') : (selF.add(i), ch.className=`chip sel-${t}`);
      });
      c.appendChild(ch);
    });
  });
}

function autoDetect(txt) {
  const lo = txt.toLowerCase(); selF.clear();
  FACTORS.forEach((f,i) => {
    const hit = f.kw.every(k => Array.isArray(k) ? k.some(kk=>lo.includes(kk)) : lo.includes(k));
    if (hit) selF.add(i);
  });
}

// PARSE
function doParse() {
  const txt = document.getElementById('news-ta').value.trim();
  if (!txt) {
    document.getElementById('parsed-wrap').style.display = 'block';
    document.getElementById('step-factors').style.display = 'block';
    document.getElementById('btn-save').style.display = 'block';
    buildChips();
    showStatus('warn','í…ìŠ¤íŠ¸ ì—†ìŒ â€” ì•„ë˜ í•„ë“œì— ì§ì ‘ ì…ë ¥í•˜ì„¸ìš”.');
    return;
  }
  const f = {}; let m;
  m = txt.match(/(?:í•˜ë½í•œ|ì˜¤ë¥¸|ë°€ë¦°|ë‚´ë¦°)\s*ë°°ëŸ´ë‹¹\s*([\d.]+)ë‹¬ëŸ¬/);
  if (m) f.wti = parseFloat(m[1]);
  if (!f.wti) { m = txt.match(/ë°°ëŸ´ë‹¹\s*[\d.]+%\s*(?:í•˜ë½í•œ|ìƒìŠ¹í•œ|ì˜¤ë¥¸)\s*([\d.]+)ë‹¬ëŸ¬/); if (m) f.wti=parseFloat(m[1]); }
  const ws = (txt.match(/(?:WTI|ì„œë¶€í…ì‚¬ìŠ¤|í…ì‚¬ìŠ¤ì‚°ì›ìœ )[^\nã€‚]{0,200}/) || [''])[0];
  m = ws.match(/([\d.]+)ë‹¬ëŸ¬\(([\d.]+)%\)\s*(?:í•˜ë½|ë‚´ë¦°|ë°€ë¦°|ë–¨ì–´ì§„)/);
  if (m) { f.abs=-parseFloat(m[1]); f.pct=-parseFloat(m[2]); }
  if (!f.abs) { m=txt.match(/([\d.]+)ë‹¬ëŸ¬\(([\d.]+)%\)\s*(?:í•˜ë½|ë‚´ë¦°|ë°€ë¦°|ë–¨ì–´ì§„)/); if(m){f.abs=-parseFloat(m[1]);f.pct=-parseFloat(m[2]);} }
  if (!f.abs) { m=ws.match(/([\d.]+)ë‹¬ëŸ¬\(([\d.]+)%\)\s*(?:ìƒìŠ¹|ì˜¤ë¥¸|ì˜¬ë¼)/); if(m){f.abs=parseFloat(m[1]);f.pct=parseFloat(m[2]);} }
  if (!f.pct) { m=txt.match(/ë°°ëŸ´ë‹¹\s*([\d.]+)%\s*(í•˜ë½|ìƒìŠ¹)/); if(m) f.pct=m[2]==='í•˜ë½'?-parseFloat(m[1]):parseFloat(m[1]); }
  if (!f.abs && f.wti && f.pct) { const prev=f.wti/(1+f.pct/100); f.abs=parseFloat((f.wti-prev).toFixed(2)); }
  const brs = txt.match(/ë¸Œë ŒíŠ¸ìœ [^\nã€‚]{0,150}/g) || [];
  for (const s of brs) { const pm=s.match(/(?:ë°°ëŸ´ë‹¹|ê°€ê²©ì€)\s*([\d.]+)ë‹¬ëŸ¬/); if(pm&&parseFloat(pm[1])>10){f.brent=parseFloat(pm[1]);break;} }
  for (const s of brs) {
    let bm=s.match(/[\d.]+ë‹¬ëŸ¬\(([\d.]+)%\)\s*(?:ë‚´ë¦°|í•˜ë½í•œ|ë–¨ì–´ì§„)/); if(bm){f.brentPct=-parseFloat(bm[1]);break;}
    bm=s.match(/ë‹¬ëŸ¬ë¡œ\s*([\d.]+)%\s*(í•˜ë½|ìƒìŠ¹)/); if(bm){f.brentPct=bm[2]==='í•˜ë½'?-parseFloat(bm[1]):parseFloat(bm[1]);break;}
    bm=s.match(/\(([\d.]+)%\)\s*(?:ë‚´ë¦°|í•˜ë½)/); if(bm){f.brentPct=-parseFloat(bm[1]);break;}
  }
  if (f.wti)      document.getElementById('f-wti').value      = f.wti.toFixed(2);
  if (f.abs)      document.getElementById('f-abs').value      = f.abs.toFixed(2);
  if (f.pct)      document.getElementById('f-pct').value      = f.pct.toFixed(2);
  if (f.brent)    document.getElementById('f-brent').value    = f.brent.toFixed(2);
  if (f.brentPct) document.getElementById('f-brentpct').value = f.brentPct.toFixed(2);

  parsedQuote = extractQuote(txt);
  autoDetect(txt);
  document.getElementById('parsed-wrap').style.display = 'block';
  document.getElementById('step-factors').style.display = 'block';
  document.getElementById('btn-save').style.display = 'block';
  buildChips();
  const ok = f.wti && f.pct !== undefined;
  showStatus(ok?'ok':'warn',
    ok ? `âœ“ WTI $${f.wti.toFixed(2)} (${f.pct>=0?'+':''}${f.pct.toFixed(2)}%) Â· ìš”ì¸ ${selF.size}ê°œ ê°ì§€${parsedQuote?' Â· ì°¸ê³  ë¬¸ì¥ ì¶”ì¶œë¨':''}`
       : 'âš  ì¼ë¶€ ìˆ˜ì¹˜ ë¯¸ì¸ì‹ â€” ì§ì ‘ ìˆ˜ì •í•˜ì„¸ìš”.');
}

function showStatus(t,m) {
  const el=document.getElementById('parse-st');
  el.style.display='block'; el.className=`parse-status ${t}`; el.textContent=m;
}
function autoPct() {
  const wti=parseFloat(document.getElementById('f-wti').value);
  const abs=parseFloat(document.getElementById('f-abs').value);
  if(wti&&!isNaN(abs)&&wti-abs>0) document.getElementById('f-pct').value=(abs/(wti-abs)*100).toFixed(2);
}

// SAVE
function getEntries() { return JSON.parse(localStorage.getItem('wti_entries')||'[]'); }
function setEntries(a) { localStorage.setItem('wti_entries',JSON.stringify(a)); }

function doSave() {
  const wti=parseFloat(document.getElementById('f-wti').value);
  const pct=parseFloat(document.getElementById('f-pct').value);
  if(isNaN(wti)||isNaN(pct)){showStatus('err','WTI ì¢…ê°€ì™€ ë³€ë™ë¥ ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.');return;}
  const abs=parseFloat(document.getElementById('f-abs').value)||null;
  const brent=parseFloat(document.getElementById('f-brent').value)||null;
  const brentPct=parseFloat(document.getElementById('f-brentpct').value)||null;
  const cont=document.getElementById('f-cont').value;
  const date=document.getElementById('f-date').value;
  const memo=document.getElementById('f-memo').value.trim()||null;
  const bears=[],bulls=[];
  selF.forEach(i=>{ FACTORS[i].t==='bear'?bears.push(FACTORS[i].kr):bulls.push(FACTORS[i].kr); });

  const pctStr=(pct>=0?'+':'')+pct.toFixed(2)+'%';
  const absStr=abs!==null?(abs>=0?'+':'')+abs.toFixed(2):null;
  const dir=pct>0?'higher':pct<0?'lower':'unchanged';
  const dirKR=pct>0?'ìƒìŠ¹':pct<0?'í•˜ë½':'ë³´í•©';
  const d=new Date(date+'T00:00:00Z');
  const enDate=d.toLocaleDateString('en-US',{year:'numeric',month:'long',day:'numeric',timeZone:'UTC'});
  const krDate=date.replace(/-/g,'.');
  const bearF=bears.map(kr=>FACTORS.find(f=>f.kr===kr)).filter(Boolean);
  const bullF=bulls.map(kr=>FACTORS.find(f=>f.kr===kr)).filter(Boolean);

  let en=`WTI (${cont}, NYMEX) settled ${dir} on ${enDate} at $${wti.toFixed(2)}/bbl`;
  if(absStr) en+=` (${absStr} USD, ${pctStr})`;
  if(brent&&brentPct) en+=`. Brent (ICE): $${brent.toFixed(2)}/bbl (${(brentPct>=0?'+':'')+brentPct.toFixed(2)}%)`;
  en+='.';
  if(bearF.length) en+='\n\nDownside:\n'+bearF.map(f=>'  â€¢ '+f.en).join('\n');
  if(bullF.length) en+='\n\nUpside:\n'+bullF.map(f=>'  â€¢ '+f.en).join('\n');
  if(memo) en+='\n\nMarket: '+memo;

  let kr=`WTI ì›ìœ (${cont}ì›”ë¬¼, NYMEX)ëŠ” ${krDate} ì „ ê±°ë˜ì¼ ëŒ€ë¹„`;
  if(absStr) kr+=` ${absStr} USD(${pctStr})`;
  kr+=` ${dirKR}í•œ ë°°ëŸ´ë‹¹ $${wti.toFixed(2)}ì— ë§ˆê°í–ˆë‹¤.`;
  if(brent&&brentPct) kr+=` ë¸Œë ŒíŠ¸ìœ (ICE) $${brent.toFixed(2)} (${(brentPct>=0?'+':'')+brentPct.toFixed(2)}%).`;
  if(bearF.length) kr+='\n\nâ–¼ í•˜ë½ ìš”ì¸\n'+bearF.map(f=>'  â€¢ '+f.kr).join('\n');
  if(bullF.length) kr+='\n\nâ–² ìƒìŠ¹ ìš”ì¸\n'+bullF.map(f=>'  â€¢ '+f.kr).join('\n');
  if(pct<0&&bearF.length) kr+=`\n\n${bearF[0].kr} ë“± í•˜ë°© ì¬ë£Œ ì••ë°•ìœ¼ë¡œ ì•½ì„¸ ë§ˆê°.`;
  else if(pct>0&&bullF.length) kr+=`\n\n${bullF[0].kr} ë“±ì´ ìœ ê°€ë¥¼ ì§€ì§€í•˜ë©° ê°•ì„¸ ë§ˆê°.`;
  if(memo) kr+='\n\n[ê´€ë ¨ ì‹œì¥] '+memo;

  const entry={
    id: editId!==null?editId:Date.now(),
    wti,abs,pct,brent,brentPct,cont,date,memo,
    bears,bulls,en,kr,
    quote: parsedQuote,
    savedAt: new Date().toISOString()
  };
  let entries=getEntries();
  entries=editId!==null?entries.map(e=>e.id===editId?entry:e):[entry,...entries];
  setEntries(entries); renderAll(); closeModal();
}

// DELETE
function deleteEntry(id) {
  if(!confirm('ì´ í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  setEntries(getEntries().filter(e=>e.id!==id)); renderAll();
}

// RENDER
function renderAll() {
  const entries=getEntries();
  document.getElementById('empty').style.display=entries.length?'none':'block';
  document.getElementById('cards').innerHTML=entries.map(renderCard).join('');
}

function renderCard(e) {
  const dir=e.pct>0?'up':e.pct<0?'dn':'flt';
  const arrow=e.pct>0?'â–²':e.pct<0?'â–¼':'â”€';
  const pctStr=(e.pct>=0?'+':'')+e.pct.toFixed(2)+'%';
  const absStr=e.abs!=null?(e.abs>=0?'+':'')+e.abs.toFixed(2)+' USD':'';
  const krDate=e.date.replace(/-/g,'.');

  const bearItems=e.bears.map(kr=>{
    const f=FACTORS.find(x=>x.kr===kr);
    return f?`<div class="factor-item"><span class="fi-bullet bear">â–¼</span><div><div class="fi-kr">${f.kr}</div><div class="fi-en">${f.en}</div></div></div>`:'';
  }).join('');
  const bullItems=e.bulls.map(kr=>{
    const f=FACTORS.find(x=>x.kr===kr);
    return f?`<div class="factor-item"><span class="fi-bullet bull">â–²</span><div><div class="fi-kr">${f.kr}</div><div class="fi-en">${f.en}</div></div></div>`:'';
  }).join('');
  const hasFactors=bearItems||bullItems;
  const hasBody=hasFactors||e.quote||e.memo;

  return `<div class="brief" id="card-${e.id}">
    <div class="brief-strip">
      <div class="strip-date">
        <div class="sd-date">${krDate}</div>
        <div class="sd-cont">NYMEX Â· ${e.cont}ì›”ë¬¼</div>
      </div>
      <div class="strip-price">
        <div class="sp-val ${dir}">${arrow} ${e.wti.toFixed(2)}</div>
        <div class="sp-unit">USD / bbl</div>
        <div class="sp-delta">
          ${absStr?`<div class="sp-d-row"><span class="sp-d-label">Î”$</span><span class="sp-d-val ${dir}">${absStr}</span></div>`:''}
          <div class="sp-d-row"><span class="sp-d-label">Î”%</span><span class="sp-d-val ${dir}">${pctStr}</span></div>
        </div>
      </div>
      ${e.brent?`<div class="strip-brent">
        <div class="sb-label">Brent ICE</div>
        <div class="sb-val">$${e.brent.toFixed(2)}</div>
        ${e.brentPct!=null?`<div class="sb-chg ${e.brentPct>=0?'up':'dn'}">${(e.brentPct>=0?'+':'')+e.brentPct.toFixed(2)}%</div>`:''}
      </div>`:''}
      <div class="strip-actions">
        <button class="act-btn edit" onclick="openModal(${e.id})">âœ EDIT</button>
        <button class="act-btn del"  onclick="deleteEntry(${e.id})">âœ• DEL</button>
      </div>
    </div>

    ${hasBody?`<div class="brief-body">
      ${hasFactors?`<div class="factors-row">
        ${bearItems?`<div class="factor-col"><div class="fc-title bear"><span class="fc-dot bear"></span>Bearish Â· í•˜ë½ ìš”ì¸</div>${bearItems}</div>`:''}
        ${bullItems?`<div class="factor-col"><div class="fc-title bull"><span class="fc-dot bull"></span>Bullish Â· ìƒìŠ¹ ìš”ì¸</div>${bullItems}</div>`:''}
      </div>`:''}
      ${e.quote?`<div class="source-quote">
        <div class="sq-label">ğŸ“° ì›ë¬¸ ì°¸ê³  ë¬¸ì¥</div>
        <div class="sq-text">${e.quote}</div>
      </div>`:''}
      ${e.memo?`<div class="brief-memo"><div class="memo-label">Related Markets</div>${e.memo}</div>`:''}
    </div>`:''}

    <div class="brief-commentary">
      <div class="co-pane"><div class="co-label">EN</div><div class="co-text en">${e.en}</div></div>
      <div class="co-pane"><div class="co-label">KR</div><div class="co-text">${e.kr}</div></div>
    </div>
    <div class="brief-copy">
      <button class="cp-btn"     onclick="copyText(${e.id},'en')">Copy EN</button>
      <button class="cp-btn"     onclick="copyText(${e.id},'kr')">Copy KR</button>
      <button class="cp-btn pri" onclick="copyText(${e.id},'both')">â§‰ Copy Both</button>
    </div>
  </div>`;
}

function copyText(id,type) {
  const e=getEntries().find(x=>x.id==id); if(!e) return;
  const txt=type==='en'?e.en:type==='kr'?e.kr:e.en+'\n\n'+'â”'.repeat(48)+'\n\n'+e.kr;
  navigator.clipboard.writeText(txt).then(()=>{
    document.querySelectorAll(`#card-${id} .cp-btn`).forEach(b=>{
      const l=b.textContent.toLowerCase();
      if(type==='both'?l.includes('both'):l.includes(type)){b.classList.add('ok');setTimeout(()=>b.classList.remove('ok'),1800);}
    });
  });
}

renderAll();
</script>
</body>
</html>
