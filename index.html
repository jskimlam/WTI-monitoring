<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WTI MORNING BRIEF</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Mono:ital,wght@0,300;0,400;0,500;1,300&family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
:root {
  /* â”€â”€ ë‹¤í¬ ê·¸ë ˆì´ ë² ì´ìŠ¤ â”€â”€ */
  --bg:       #16181f;
  --surface:  #1e2128;
  --card:     #252930;
  --inset:    #1a1d24;
  --hdr:      #13151b;
  --border:   #2e3240;
  --border2:  #3d4255;

  /* â”€â”€ í¬ì¸íŠ¸ ì»¬ëŸ¬ â”€â”€ */
  --acc:      #60a5fa;   /* ë¸”ë£¨ â€” ë²„íŠ¼/ë§í¬ */
  --acc2:     #38bdf8;   /* ìŠ¤ì¹´ì´ â€” í—¤ë” ê°•ì¡° */
  --green:    #34d875;
  --red:      #f87171;

  /* â”€â”€ í…ìŠ¤íŠ¸ â”€â”€ */
  --text:     #e4e8f0;   /* ê¸°ë³¸ í°ìƒ‰ ê³„ì—´ */
  --text2:    #9aa3b8;   /* ë³´ì¡° */
  --dim:      #5a6378;   /* íë¦° */

  /* â”€â”€ ì˜ë¡œìš° ê³„í†µ (í…ìŠ¤íŠ¸/ë ˆì´ë¸” ê°€ì‹œì„±) â”€â”€ */
  --ylw:      #fbbf24;   /* ì•°ë²„ ì˜ë¡œìš° â€” ë ˆì´ë¸” */
  --ylw2:     #fde68a;   /* ì—°í•œ ë…¸ë‘ â€” ì›ë¬¸/ë‚ ì§œ */
  --ylw3:     #fef3c7;   /* ì•„ì´ë³´ë¦¬ â€” ì½”ë©˜í„°ë¦¬ */
  --ylw-dim:  #92701a;   /* ê³¨ë“œ ë”¤ â€” ë³´ë” */
  --gold:     #f59e0b;   /* ê³¨ë“œ â€” ë”°ì˜´í‘œ/ë³´ë” í¬ì¸íŠ¸ */

  /* â”€â”€ íƒœê·¸ â”€â”€ */
  --tag-bear-bg:  #2d1a1a; --tag-bear-txt: #f87171; --tag-bear-bd: #7f2e2e;
  --tag-bull-bg:  #1a2d1e; --tag-bull-txt: #34d875; --tag-bull-bd: #2e6e3a;
  --tag-dim-bg:   #1e2230; --tag-dim-txt:  #7a8aaa; --tag-dim-bd:  #2e3650;

  --mono: 'DM Mono', monospace;
  --sans: 'Noto Sans KR', sans-serif;
  --disp: 'Bebas Neue', sans-serif;
}
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html, body { min-height: 100%; background: var(--bg); color: var(--text); font-family: var(--sans); }

/* â•â• HEADER â•â• */
.hdr {
  position: sticky; top: 0; z-index: 100;
  background: var(--hdr); border-bottom: 2px solid var(--gold);
  display: flex; align-items: center; justify-content: space-between;
  padding: 0 36px; height: 64px;
  box-shadow: 0 2px 20px rgba(0,0,0,.5);
}
.hdr-left { display: flex; align-items: baseline; gap: 18px; }
.hdr-logo { font-family: var(--disp); font-size: 32px; letter-spacing: .14em; color: var(--ylw); }
.hdr-sub  { font-family: var(--mono); font-size: 11px; letter-spacing: .2em; color: var(--dim); text-transform: uppercase; }
.hdr-right { display: flex; align-items: center; gap: 12px; }
.hdr-clock { font-family: var(--mono); font-size: 13px; color: var(--ylw2); }
.btn-new {
  background: var(--gold); color: #1a1200; border: none; border-radius: 5px;
  padding: 9px 22px; font-family: var(--mono); font-size: 12px;
  font-weight: 700; letter-spacing: .12em; text-transform: uppercase;
  cursor: pointer; transition: background .15s;
}
.btn-new:hover { background: var(--ylw); }
.btn-refresh {
  background: transparent; border: 1px solid var(--border2); color: var(--dim);
  padding: 8px 16px; border-radius: 5px; font-family: var(--mono); font-size: 11px;
  letter-spacing: .1em; text-transform: uppercase; cursor: pointer; transition: all .15s;
}
.btn-refresh:hover { border-color: var(--ylw); color: var(--ylw); }

/* â•â• LAYOUT â•â• */
.wrap { max-width: 1020px; margin: 0 auto; padding: 36px 28px 80px; }
.empty { text-align: center; padding: 90px 0; font-family: var(--mono); font-size: 12px; letter-spacing: .12em; color: var(--dim); }
.empty .e-icon { font-size: 42px; margin-bottom: 16px; opacity: .2; }
.loading { text-align: center; padding: 60px 0; font-family: var(--mono); font-size: 12px; color: var(--dim); }
.spinner { width: 28px; height: 28px; border: 2px solid var(--border2); border-top-color: var(--gold); border-radius: 50%; animation: spin .7s linear infinite; margin: 0 auto 14px; }
@keyframes spin { to { transform: rotate(360deg); } }

/* â•â• CARD â•â• */
.brief {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 10px; margin-bottom: 28px; overflow: hidden;
  box-shadow: 0 4px 28px rgba(0,0,0,.4);
  animation: fadeUp .28s ease both;
}
@keyframes fadeUp { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:none} }

/* â•â• ìƒë‹¨: ê°€ê²© í—¤ë” (ì••ì¶•í˜• 1ì¤„) â•â• */
.brief-header {
  display: flex; align-items: center;
  background: var(--card); border-bottom: 1px solid var(--border);
  padding: 0;
}

/* ë‚ ì§œ/ì›”ë¬¼ */
.bh-date {
  padding: 18px 24px; border-right: 1px solid var(--border);
  display: flex; flex-direction: column; justify-content: center; gap: 5px;
  min-width: 172px; flex-shrink: 0;
}
.bh-date-val  { font-family: var(--mono); font-size: 19px; color: var(--ylw2); font-weight: 600; letter-spacing: .04em; }
.bh-date-cont { font-family: var(--mono); font-size: 11px; color: var(--dim); }

/* ê°€ê²© ë©”ì¸ */
.bh-price {
  display: flex; align-items: center; gap: 6px;
  padding: 18px 28px; flex-shrink: 0;
}
.bh-price-arrow { font-family: var(--disp); font-size: 36px; line-height: 1; }
.bh-price-arrow.up  { color: var(--green); }
.bh-price-arrow.dn  { color: var(--red); }
.bh-price-arrow.flt { color: var(--text); }
.bh-price-val  { font-family: var(--disp); font-size: 78px; line-height: 1; letter-spacing: .02em; }
.bh-price-val.up  { color: var(--green); }
.bh-price-val.dn  { color: var(--red); }
.bh-price-val.flt { color: var(--text); }
.bh-price-unit { font-family: var(--mono); font-size: 12px; color: var(--dim); align-self: flex-end; padding-bottom: 8px; line-height: 1.5; }

/* ë¸íƒ€ */
.bh-delta {
  display: flex; flex-direction: column; gap: 8px;
  padding: 18px 24px; border-left: 1px solid var(--border); flex-shrink: 0;
}
.bh-d-row   { display: flex; align-items: center; gap: 10px; }
.bh-d-label { font-family: var(--mono); font-size: 10px; letter-spacing: .1em; color: var(--dim); width: 30px; text-transform: uppercase; }
.bh-d-val   { font-family: var(--mono); font-size: 22px; font-weight: 600; }
.bh-d-val.up  { color: var(--green); }
.bh-d-val.dn  { color: var(--red); }

/* ë°©í–¥ ë±ƒì§€ */
.bh-dir {
  padding: 18px 20px; border-left: 1px solid var(--border);
  display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 5px;
  flex-shrink: 0;
}
.bh-dir-badge {
  font-family: var(--sans); font-size: 15px; font-weight: 700;
  padding: 6px 18px; border-radius: 24px; white-space: nowrap;
}
.bh-dir-badge.up  { background: rgba(52,216,117,.15); color: var(--green); border: 1px solid rgba(52,216,117,.3); }
.bh-dir-badge.dn  { background: rgba(248,113,113,.15); color: var(--red);   border: 1px solid rgba(248,113,113,.3); }
.bh-dir-badge.flt { background: rgba(90,99,120,.15);   color: var(--dim);   border: 1px solid var(--border2); }
.bh-dir-label { font-family: var(--mono); font-size: 10px; color: var(--dim); letter-spacing: .12em; text-transform: uppercase; }

/* EDIT/DEL â€” ìš°ì¸¡ ë */
.bh-actions { margin-left: auto; display: flex; flex-direction: column; border-left: 1px solid var(--border); min-width: 76px; align-self: stretch; }
.act-btn {
  flex: 1; display: flex; align-items: center; justify-content: center;
  background: transparent; border: none; cursor: pointer;
  font-family: var(--mono); font-size: 11px; letter-spacing: .1em; color: var(--dim);
  padding: 0 14px; transition: all .15s; text-transform: uppercase;
  border-bottom: 1px solid var(--border);
}
.act-btn:last-child { border-bottom: none; }
.act-btn.edit:hover { background: rgba(251,191,36,.08); color: var(--ylw); }
.act-btn.del:hover  { background: rgba(248,113,113,.08); color: var(--red); }

/* â•â• ì¤‘ë‹¨: 2ì»¬ëŸ¼ íŒ©íŠ¸ íŒ¨ë„ â•â• */
.brief-facts {
  display: grid; grid-template-columns: 1fr 1fr;
  border-bottom: 1px solid var(--border);
}
.fact-col {
  padding: 20px 24px;
  display: flex; flex-direction: column; gap: 12px;
}
.fact-col:first-child { border-right: 1px solid var(--border); }

/* ì»¬ëŸ¼ íƒ€ì´í‹€ */
.fact-col-title {
  display: flex; align-items: center; gap: 8px;
  font-family: var(--mono); font-size: 11px; letter-spacing: .18em; text-transform: uppercase;
  color: var(--ylw); padding-bottom: 10px; border-bottom: 1px solid var(--border);
}
.fact-col-title.counter { color: var(--ylw-dim); opacity: .8; }
.fc-dot { width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; }
.fc-dot.bear { background: var(--red); }
.fc-dot.bull { background: var(--green); }
.fc-dot.dim  { background: var(--dim); }

/* ìš”ì¸ íƒœê·¸ë“¤ */
.factor-tags { display: flex; flex-wrap: wrap; gap: 7px; }
.factor-tag {
  display: inline-block; padding: 5px 13px; border-radius: 20px;
  font-size: 13px; font-weight: 500;
}
.factor-tag.bear { background: var(--tag-bear-bg); color: var(--tag-bear-txt); border: 1px solid var(--tag-bear-bd); }
.factor-tag.bull { background: var(--tag-bull-bg); color: var(--tag-bull-txt); border: 1px solid var(--tag-bull-bd); }
.factor-tag.dim  { background: var(--tag-dim-bg);  color: var(--tag-dim-txt);  border: 1px solid var(--tag-dim-bd); }

/* ì›ë¬¸ ì¸ìš© */
.source-quote {
  background: var(--inset);
  border: 1px solid var(--ylw-dim);
  border-left: 3px solid var(--gold);
  border-radius: 6px; padding: 11px 15px;
}
.sq-label {
  font-family: var(--mono); font-size: 10px; letter-spacing: .16em; text-transform: uppercase;
  color: var(--ylw); margin-bottom: 7px; display: flex; align-items: center; gap: 6px;
}
.sq-text {
  font-size: 13px; line-height: 1.78; color: var(--ylw2); font-style: italic;
  display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden;
}
.sq-text::before { content: '"'; font-size: 18px; line-height: 0; vertical-align: -3px; margin-right: 3px; color: var(--gold); }
.sq-text::after  { content: '"'; font-size: 18px; line-height: 0; vertical-align: -3px; margin-left:  3px; color: var(--gold); }

.source-quote.counter {
  border-color: var(--border2); border-left-color: var(--dim);
}
.source-quote.counter .sq-label { color: var(--ylw-dim); }
.source-quote.counter .sq-text  { color: var(--text2); }
.source-quote.counter .sq-text::before,
.source-quote.counter .sq-text::after { color: var(--dim); }

/* ë¹ˆ ì»¬ëŸ¼ placeholder */
.fact-empty {
  font-family: var(--mono); font-size: 11px; color: var(--dim);
  padding: 8px 0; opacity: .5;
}

/* â•â• í•˜ë‹¨: ì½”ë©˜í„°ë¦¬ â•â• */
.brief-commentary {
  padding: 18px 24px; border-bottom: 1px solid var(--border);
  background: var(--inset);
}
.co-label {
  font-family: var(--mono); font-size: 11px; letter-spacing: .18em; text-transform: uppercase;
  color: var(--ylw); margin-bottom: 10px; display: flex; align-items: center; gap: 8px;
}
.co-label::after { content: ''; flex: 1; height: 1px; background: var(--ylw-dim); opacity: .4; }
.co-text { font-size: 15px; line-height: 1.9; color: var(--ylw3); white-space: pre-wrap; }

/* â•â• COPY ROW â•â• */
.brief-copy {
  padding: 12px 24px; display: flex; align-items: center; justify-content: flex-end; gap: 10px;
  background: var(--card);
}
.cp-btn {
  font-family: var(--mono); font-size: 11px; letter-spacing: .08em; text-transform: uppercase;
  background: transparent; border: 1px solid var(--border2); color: var(--dim);
  padding: 7px 16px; border-radius: 5px; cursor: pointer; transition: all .15s;
}
.cp-btn:hover     { border-color: var(--ylw); color: var(--ylw); }
.cp-btn.img:hover { border-color: var(--green); color: var(--green); }
.cp-btn.ok        { border-color: var(--green); color: var(--green); }

/* â•â• MODAL â•â• */
#overlay {
  position: fixed; inset: 0; z-index: 200;
  background: rgba(0,0,0,.75); backdrop-filter: blur(8px);
  display: none; align-items: center; justify-content: center;
}
#overlay.open { display: flex; }
#modal {
  width: 760px; max-height: 92vh;
  background: var(--surface); border: 1px solid var(--border2); border-radius: 12px;
  display: flex; flex-direction: column; overflow: hidden;
  box-shadow: 0 32px 80px rgba(0,0,0,.6); animation: mIn .22s ease;
}
@keyframes mIn { from{opacity:0;transform:translateY(12px) scale(.98)} to{opacity:1;transform:none} }
.mhdr {
  display: flex; align-items: center; justify-content: space-between;
  padding: 16px 26px; border-bottom: 1px solid var(--border);
  background: var(--hdr); flex-shrink: 0;
}
.mhdr-title { font-family: var(--mono); font-size: 13px; letter-spacing: .16em; text-transform: uppercase; color: var(--ylw); }
.mhdr-close {
  background: transparent; border: 1px solid var(--border2); color: var(--dim);
  width: 32px; height: 32px; border-radius: 4px; cursor: pointer; font-size: 16px;
  display: flex; align-items: center; justify-content: center; transition: all .15s;
}
.mhdr-close:hover { border-color: var(--red); color: var(--red); }
.mbody {
  flex: 1; overflow-y: auto; padding: 22px 26px;
  display: flex; flex-direction: column; gap: 18px; background: var(--bg);
}
.m-sec {
  background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 16px 20px;
  display: flex; flex-direction: column; gap: 12px;
}
.m-sec-label {
  font-family: var(--mono); font-size: 11px; letter-spacing: .18em; text-transform: uppercase;
  color: var(--ylw); margin-bottom: 2px; display: flex; align-items: center; gap: 8px;
}
.m-sec-label::after { content: ''; flex: 1; height: 1px; background: var(--ylw-dim); opacity: .35; }
#news-ta {
  width: 100%; height: 145px; resize: vertical;
  background: var(--card); border: 1px solid var(--border2); border-radius: 6px;
  color: var(--text); font-family: var(--sans); font-size: 14px; line-height: 1.72;
  padding: 12px 14px; outline: none; transition: border-color .15s;
}
#news-ta:focus { border-color: var(--gold); }
#news-ta::placeholder { color: var(--dim); font-size: 13px; }
#parsed-wrap, #step-factors { display: none; }
.pf-grid   { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 11px; }
.pf-grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 11px; }
.pfield { display: flex; flex-direction: column; gap: 5px; }
.pfield label { font-family: var(--mono); font-size: 10px; letter-spacing: .1em; text-transform: uppercase; color: var(--ylw-dim); }
.pfield input, .pfield select, .pfield textarea {
  background: var(--card); border: 1px solid var(--border2); border-radius: 6px;
  color: var(--text); font-family: var(--mono); font-size: 14px;
  padding: 9px 12px; outline: none; width: 100%; transition: border-color .15s;
}
.pfield input:focus, .pfield select:focus, .pfield textarea:focus { border-color: var(--gold); }
.pfield input.hi  { color: var(--ylw2); font-weight: 600; border-color: var(--ylw-dim); background: rgba(245,158,11,.05); }
.pfield input.pos { color: var(--green); }
.pfield input.neg { color: var(--red); }
.pfield textarea  { resize: vertical; min-height: 56px; font-family: var(--sans); font-size: 13px; line-height: 1.65; }
.parse-status {
  font-family: var(--mono); font-size: 12px; padding: 9px 13px;
  border-radius: 6px; margin-top: 4px; display: none;
}
.parse-status.ok   { background: rgba(52,216,117,.08);  border: 1px solid rgba(52,216,117,.3);  color: var(--green); }
.parse-status.warn { background: rgba(251,191,36,.08);  border: 1px solid rgba(251,191,36,.3);  color: var(--ylw); }
.parse-status.err  { background: rgba(248,113,113,.08); border: 1px solid rgba(248,113,113,.3); color: var(--red); }
.chip-sec-label {
  font-family: var(--mono); font-size: 10px; letter-spacing: .14em; text-transform: uppercase;
  color: var(--ylw-dim); margin-bottom: 6px; margin-top: 8px;
}
.chip-sec-label:first-child { margin-top: 0; }
.chip-wrap { display: flex; flex-wrap: wrap; gap: 7px; }
.chip {
  font-family: var(--sans); font-size: 13px; font-weight: 500;
  padding: 5px 12px; border-radius: 20px; border: 1px solid var(--border2);
  color: var(--dim); background: var(--card);
  cursor: pointer; transition: all .12s; user-select: none;
}
.chip:hover { border-color: var(--ylw); color: var(--ylw); }
.chip.sel-bear { background: var(--tag-bear-bg); border-color: var(--tag-bear-bd); color: var(--tag-bear-txt); }
.chip.sel-bull { background: var(--tag-bull-bg); border-color: var(--tag-bull-bd); color: var(--tag-bull-txt); }
.divider { height: 1px; background: var(--border); margin: 4px 0; }
.mftr {
  flex-shrink: 0; padding: 14px 26px; border-top: 1px solid var(--border);
  display: flex; gap: 10px; background: var(--surface);
}
.mf-btn {
  padding: 11px 18px; border: none; border-radius: 6px; cursor: pointer;
  font-family: var(--mono); font-size: 12px; letter-spacing: .1em;
  text-transform: uppercase; font-weight: 600; transition: all .15s;
}
.mf-parse       { flex: 1; background: var(--card); color: var(--ylw); border: 1px solid var(--ylw-dim); }
.mf-parse:hover { background: rgba(245,158,11,.1); border-color: var(--ylw); }
.mf-save        { flex: 2; background: var(--gold); color: #1a1200; display: none; }
.mf-save:hover  { background: var(--ylw); }
.mf-close {
  background: transparent; border: 1px solid var(--border2); color: var(--dim);
  padding: 11px 16px; border-radius: 6px; cursor: pointer;
  font-family: var(--mono); font-size: 12px; transition: all .15s;
}
.mf-close:hover { border-color: var(--red); color: var(--red); }

/* â•â• TOAST â•â• */
#toast {
  position: fixed; bottom: 28px; right: 28px; z-index: 9999;
  padding: 13px 20px; border-radius: 8px; font-family: var(--mono); font-size: 13px;
  font-weight: 500; color: #fff; opacity: 0; transform: translateY(10px);
  transition: all .24s; pointer-events: none; max-width: 320px;
  box-shadow: 0 8px 24px rgba(0,0,0,.5);
}
#toast.show { opacity: 1; transform: translateY(0); }
#toast.ok  { background: #166534; }
#toast.err { background: #991b1b; }
#toast.inf { background: #1e3a5f; }

::-webkit-scrollbar { width: 5px; }
::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 3px; }
</style>
</head>
<body>

<header class="hdr">
  <div class="hdr-left">
    <div class="hdr-logo">WTI BRIEF</div>
    <div class="hdr-sub">Crude Oil Â· Morning Monitor</div>
  </div>
  <div class="hdr-right">
    <div class="hdr-clock" id="clock"></div>
    <button class="btn-refresh" onclick="loadData()">â†» REFRESH</button>
    <button class="btn-new" onclick="openModal()">+ NEW ENTRY</button>
  </div>
</header>

<div class="wrap">
  <div id="loading" style="display:none"><div class="spinner"></div>ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
  <div class="empty" id="empty" style="display:none">
    <div class="e-icon">â—ˆ</div>
    <div style="color:var(--ylw2)">NO ENTRIES YET</div>
    <div style="margin-top:8px;font-size:11px;color:var(--dim)">
      <strong style="color:var(--ylw)">+ NEW ENTRY</strong> ë²„íŠ¼ìœ¼ë¡œ ì²« ë²ˆì§¸ ë¸Œë¦¬í”„ë¥¼ ì¶”ê°€í•˜ì„¸ìš”
    </div>
  </div>
  <div id="cards"></div>
</div>

<!-- MODAL -->
<div id="overlay">
  <div id="modal">
    <div class="mhdr">
      <div class="mhdr-title" id="modal-title">â—ˆ NEW WTI ENTRY</div>
      <button class="mhdr-close" onclick="closeModal()">âœ•</button>
    </div>
    <div class="mbody">

      <div class="m-sec">
        <div class="m-sec-label">01 Â· ë‰´ìŠ¤ í…ìŠ¤íŠ¸</div>
        <textarea id="news-ta" placeholder="WTI ê¸°ì‚¬ ì „ë¬¸ ë¶™ì—¬ë„£ê¸° â†’ íŒŒì‹± ë²„íŠ¼ í´ë¦­
ìˆ˜ì¹˜ / ì›”ë¬¼ / ë‚ ì§œ / ì£¼ìš”ì¸ / ë°˜ëŒ€ìš”ì¸ / ì›ë¬¸ / ì½”ë©˜í„°ë¦¬ ìë™ ìƒì„±

í…ìŠ¤íŠ¸ ì—†ì´ íŒŒì‹± â†’ ìˆ˜ë™ ì…ë ¥ ëª¨ë“œ"></textarea>
        <div class="parse-status" id="parse-st"></div>
      </div>

      <div class="m-sec" id="parsed-wrap">
        <div class="m-sec-label">02 Â· ìˆ˜ì¹˜ í™•ì¸ Â· ìˆ˜ì •</div>
        <div class="pf-grid" style="margin-bottom:11px">
          <div class="pfield"><label>WTI ì¢…ê°€ ($/bbl) *</label>
            <input type="number" id="f-wti" step="0.01" placeholder="62.33" class="hi"></div>
          <div class="pfield"><label>ì „ì¼æ¯” $</label>
            <input type="number" id="f-abs" step="0.01" placeholder="-0.56" oninput="autoPct()"></div>
          <div class="pfield"><label>ë³€ë™ë¥  %</label>
            <input type="number" id="f-pct" step="0.01" placeholder="-0.89"></div>
        </div>
        <div class="pf-grid-2" style="margin-bottom:11px">
          <div class="pfield"><label>ê¸°ì¤€ì¼ *</label>
            <input type="date" id="f-date"></div>
          <div class="pfield"><label>ì›”ë¬¼ *</label>
            <select id="f-cont">
              <option value="Mar">3ì›”ë¬¼ (Mar)</option>
              <option value="Apr">4ì›”ë¬¼ (Apr)</option>
              <option value="May">5ì›”ë¬¼ (May)</option>
              <option value="Jun">6ì›”ë¬¼ (Jun)</option>
            </select></div>
        </div>
        <div class="pf-grid-2">
          <div class="pfield"><label>ì½”ë©˜í„°ë¦¬</label>
            <textarea id="f-commentary" placeholder="ìë™ ìƒì„± ë˜ëŠ” ì§ì ‘ ì…ë ¥"></textarea></div>
          <div class="pfield"><label>ì£¼ìš”ì¸ ì›ë¬¸ (í•œ ë¬¸ì¥)</label>
            <textarea id="f-main-quote" placeholder="ìë™ ì¶”ì¶œ ë˜ëŠ” ì§ì ‘ ì…ë ¥"></textarea></div>
        </div>
      </div>

      <div class="m-sec" id="step-factors">
        <div class="m-sec-label">03 Â· ì£¼ìš”ì¸ ì„ íƒ</div>
        <div class="chip-sec-label">â–¼ BEARISH Â· í•˜ë½ ìš”ì¸</div>
        <div class="chip-wrap" id="main-chips-bear"></div>
        <div class="chip-sec-label">â–² BULLISH Â· ìƒìŠ¹ ìš”ì¸</div>
        <div class="chip-wrap" id="main-chips-bull"></div>
        <div class="divider"></div>
        <div class="m-sec-label">04 Â· ë°˜ëŒ€ìš”ì¸ (ì„ íƒì‚¬í•­)</div>
        <div class="chip-sec-label">â–¼ BEARISH</div>
        <div class="chip-wrap" id="counter-chips-bear"></div>
        <div class="chip-sec-label">â–² BULLISH</div>
        <div class="chip-wrap" id="counter-chips-bull"></div>
        <div style="margin-top:12px">
          <div class="pfield"><label>ë°˜ëŒ€ìš”ì¸ ì›ë¬¸ (í•œ ë¬¸ì¥)</label>
            <textarea id="f-counter-quote" placeholder="ìë™ ì¶”ì¶œ ë˜ëŠ” ì§ì ‘ ì…ë ¥"></textarea></div>
        </div>
      </div>

    </div>
    <div class="mftr">
      <button class="mf-btn mf-parse" id="btn-parse" onclick="doParse()">ğŸ” íŒŒì‹±</button>
      <button class="mf-btn mf-save"  id="btn-save"  onclick="doSave()">â–¶ êµ¬ê¸€ì‹œíŠ¸ ì €ì¥</button>
      <button class="mf-close"                        onclick="closeModal()">ë‹«ê¸°</button>
    </div>
  </div>
</div>

<div id="toast"></div>

<script>
const GAS_URL = 'https://script.google.com/macros/s/AKfycbwhEYfc54h-rmf3bORWJCMapYFiZ162Rrnh1ScnBLT0z_wzRc5mSL6lMC10XZPBCHbn/exec';

// â”€â”€ CLOCK â”€â”€
function tick() {
  const k = new Date(Date.now() + 9*3600000);
  document.getElementById('clock').textContent =
    k.toISOString().slice(0,10) + '  ' + k.toISOString().slice(11,19) + ' KST';
}
tick(); setInterval(tick, 1000);

// â”€â”€ ë‚ ì§œ í¬ë§· â”€â”€
function fmtDate(raw) {
  if (!raw) return '';
  const s = String(raw).trim();
  const m = s.match(/(\d{4})[.\-\/](\d{1,2})[.\-\/](\d{1,2})/);
  if (m) return `${m[1]}.${m[2].padStart(2,'0')}.${m[3].padStart(2,'0')}`;
  if (!isNaN(s) && s.length < 6) {
    const d = new Date(Math.round((parseFloat(s)-25569)*86400000));
    return d.getFullYear()+'.'+String(d.getMonth()+1).padStart(2,'0')+'.'+String(d.getDate()).padStart(2,'0');
  }
  return s.slice(0,10).replace(/-/g,'.');
}

// â”€â”€ FACTORS â”€â”€
const FACTORS = [
  { t:'bear', kr:'ë¯¸Â·ì´ë€ í•µ í˜‘ìƒ ì§„ì „',      en:'US-Iran nuclear deal progress',   kw:['ì´ë€',['í•©ì˜','ì§„ì „','í˜‘ìƒ']] },
  { t:'bear', kr:'ì¤‘ë™ ì§€ì •í•™ ë¦¬ìŠ¤í¬ ì™„í™”',    en:'Easing Middle East risk premium', kw:['ì¤‘ë™','ì™„í™”'] },
  { t:'bear', kr:'IEA ìˆ˜ìš” ì „ë§ í•˜í–¥',          en:'IEA demand forecast downgraded',  kw:['iea','í•˜í–¥'] },
  { t:'bear', kr:'OPEC+ ì¦ì‚° ë…¼ì˜',             en:'OPEC+ output increase discussed', kw:['opec','ì¦ì‚°'] },
  { t:'bear', kr:'ì¹´ìí í…¡ê¸°ì¦ˆ ìœ ì „ ì¬ê°œ',     en:'Tengiz oilfield ramping up',      kw:[['í…¡ê¸°ì¦ˆ','ì¹´ìí']] },
  { t:'bear', kr:'ë¯¸ ì›ìœ  ì¬ê³  ì¦ê°€ (EIA)',      en:'US crude inventory build',        kw:['ì¬ê³ ','ì¦ê°€'] },
  { t:'bear', kr:'ë‹¬ëŸ¬ ê°•ì„¸',                   en:'USD strengthened',                kw:['ë‹¬ëŸ¬','ê°•ì„¸'] },
  { t:'bear', kr:'ê²½ê¸°ì¹¨ì²´ ìš°ë ¤',               en:'Recession concerns',              kw:['ê²½ê¸°ì¹¨ì²´'] },
  { t:'bull', kr:'ì¤‘ë™ ê¸´ì¥ ê³ ì¡°',              en:'Middle East tensions escalating', kw:['ì¤‘ë™','ê¸´ì¥'] },
  { t:'bull', kr:'í˜¸ë¥´ë¬´ì¦ˆ í•´í˜‘ ë¦¬ìŠ¤í¬',        en:'Hormuz Strait risk',              kw:['í˜¸ë¥´ë¬´ì¦ˆ'] },
  { t:'bull', kr:'OPEC+ ê°ì‚° ìœ ì§€Â·ê°•í™”',        en:'OPEC+ cuts maintained/deepened',  kw:['opec','ê°ì‚°'] },
  { t:'bull', kr:'ë¯¸ ì›ìœ  ì¬ê³  ê°ì†Œ (EIA)',      en:'US crude inventory draw',         kw:['ì¬ê³ ','ê°ì†Œ'] },
  { t:'bull', kr:'IEA/EIA ìˆ˜ìš” ì „ë§ ìƒí–¥',      en:'IEA/EIA demand upgrade',          kw:['iea','ìƒí–¥'] },
  { t:'bull', kr:'ë‹¬ëŸ¬ ì•½ì„¸',                   en:'USD weakened',                    kw:['ë‹¬ëŸ¬','ì•½ì„¸'] },
  { t:'bull', kr:'í•­ëª¨ ì „ë‹¨ ë°°ì¹˜',              en:'US carrier group deployed',       kw:['í•­ëª¨','ì „ë‹¨'] },
];

const mainSel    = new Set();
const counterSel = new Set();
let editKey = null;

// â”€â”€ ë¬¸ì¥ íŠ¸ë¦¬ë° â”€â”€
function trimSent(s, max=100) {
  if (!s) return '';
  s = s.replace(/^[^ê°€-í£a-zA-Z$\d"]+/, '').trim();
  if (s.length <= max) return s;
  const cut = s.lastIndexOf(' ', max);
  return (cut > 60 ? s.slice(0, cut) : s.slice(0, max)) + 'â€¦';
}

// â”€â”€ ë¬¸ì¥ ë¶„ë¦¬ â”€â”€
function splitSents(txt) {
  return txt.split(/(?<=[ë‹¤ìŠµë‹ˆë‹¤ê¹Œìš”ì—ˆë‹¤]\.)\s+|(?<=ë‹¤\.\s)|(?<=\n)/)
    .map(s => s.trim()).filter(s => s.length > 15 && s.length < 300);
}

// â”€â”€ ì£¼ìš”ì¸ ì›ë¬¸ ì¶”ì¶œ â”€â”€
function extractMainQuote(txt) {
  const sents = splitSents(txt);
  const patterns = [
    /ê°€ìš´ë°.{4,80}(?:í•˜ë½|ìƒìŠ¹|ì•½ì„¸|ê°•ì„¸|ë§ˆê°|ë‚®ì•„|ë†’ì•„)/,
    /ì†Œì‹[ì´ì—].{2,60}(?:í•˜ë½|ìƒìŠ¹|ì••ë°•|ì§€ì§€|ì˜í–¥)/,
    /ë•Œë¬¸ìœ¼ë¡œ\s*ë¶„ì„/,
    /ì˜í–¥ìœ¼ë¡œ.{4,60}(?:í•˜ë½|ìƒìŠ¹|ë§ˆê°)/,
    /ìœ„í—˜\s*í”„ë¦¬ë¯¸ì—„.{0,40}(?:ì•½í•´|ê°•í•´|ë‚®ì•„|ë†’ì•„)/,
    /(?:í•˜ë½|ìƒìŠ¹)ì„¸ë¥¼\s*ë³´ì˜€/,
  ];
  for (const p of patterns) {
    const f = sents.find(s => p.test(s));
    if (f) return trimSent(f);
  }
  return null;
}

// â”€â”€ ë°˜ëŒ€ìš”ì¸ ì›ë¬¸ ì¶”ì¶œ â”€â”€
function extractCounterQuote(txt, idxSet) {
  if (!idxSet.size) return null;
  const sents = splitSents(txt);
  const kws = [...idxSet].flatMap(i => FACTORS[i].kw.flat().filter(k => typeof k === 'string'));
  for (const kw of kws) {
    const found = sents.find(s => s.includes(kw));
    if (found) return trimSent(found);
  }
  return null;
}

// â”€â”€ ìš”ì¸ ìë™ ê°ì§€ â”€â”€
function autoDetect(txt, direction) {
  const lo = txt.toLowerCase();
  mainSel.clear(); counterSel.clear();
  FACTORS.forEach((f, i) => {
    const hit = f.kw.every(k => Array.isArray(k) ? k.some(kk=>lo.includes(kk)) : lo.includes(k));
    if (!hit) return;
    if      (direction==='í•˜ë½' && f.t==='bear') mainSel.add(i);
    else if (direction==='ìƒìŠ¹' && f.t==='bull') mainSel.add(i);
    else counterSel.add(i);
  });
}

// â”€â”€ ì½”ë©˜í„°ë¦¬ ìƒì„± â”€â”€
function buildCommentary(wti, pct, abs, direction) {
  const pctStr = (pct>=0?'+':'')+pct.toFixed(2)+'%';
  const absStr = abs!==null ? `${abs>=0?'+':''}${abs.toFixed(2)} USD, ` : '';
  const mainArr    = [...mainSel].map(i=>FACTORS[i].kr);
  const counterArr = [...counterSel].map(i=>FACTORS[i].kr);
  let t = `WTI ì›ìœ ëŠ” ë°°ëŸ´ë‹¹ $${wti.toFixed(2)} (${absStr}${pctStr})ë¡œ ${direction} ë§ˆê°.`;
  if (mainArr.length)    t += ` ${mainArr.slice(0,2).join(', ')} ë“±ì´ ì£¼ìš” ${direction} ìš”ì¸ìœ¼ë¡œ ì‘ìš©.`;
  if (counterArr.length) t += ` ë‹¤ë§Œ ${counterArr[0]} ë“±ì€ ${direction==='í•˜ë½'?'ë‚™í­':'ìƒìŠ¹í­'}ì„ ì œí•œ.`;
  return t;
}

// â”€â”€ LOAD â”€â”€
async function loadData() {
  document.getElementById('loading').style.display = 'block';
  document.getElementById('cards').innerHTML = '';
  document.getElementById('empty').style.display = 'none';
  try {
    const res  = await fetch(GAS_URL + '?t=' + Date.now());
    const json = await res.json();
    if (!json.success) throw new Error(json.message);
    const rows = (json.data||[]).slice(1).reverse();
    if (!rows.length) { document.getElementById('empty').style.display = 'block'; return; }
    document.getElementById('cards').innerHTML = rows.map(rowToEntry).map(renderCard).join('');
  } catch(e) {
    toast('âŒ ë¡œë“œ ì‹¤íŒ¨: '+e.message, 'err');
    document.getElementById('empty').style.display = 'block';
  } finally {
    document.getElementById('loading').style.display = 'none';
  }
}

function rowToEntry(r) {
  return {
    date:           fmtDate(r[0]),
    contract:       String(r[1]||'').trim(),
    wti:            parseFloat(r[2])||0,
    abs:            (r[3]!==''&&r[3]!=null) ? parseFloat(r[3]) : null,
    pct:            parseFloat(r[4])||0,
    direction:      String(r[5]||'').trim(),
    mainFactors:    String(r[6]||'').trim(),
    mainQuote:      String(r[7]||'').trim(),
    commentary:     String(r[8]||'').trim(),
    counterFactors: String(r[9]||'').trim(),
    counterQuote:   String(r[10]||'').trim(),
  };
}

// â”€â”€ MODAL â”€â”€
function openModal(entryForEdit = null) {
  editKey = null; mainSel.clear(); counterSel.clear();
  document.getElementById('modal-title').textContent = entryForEdit ? 'â—ˆ EDIT ENTRY' : 'â—ˆ NEW WTI ENTRY';
  document.getElementById('news-ta').value = '';
  document.getElementById('parse-st').style.display = 'none';
  document.getElementById('parsed-wrap').style.display = 'none';
  document.getElementById('step-factors').style.display = 'none';
  document.getElementById('btn-save').style.display = 'none';
  const today = new Date(Date.now()+9*3600000).toISOString().slice(0,10);
  document.getElementById('f-date').value = today;
  document.getElementById('f-cont').value = 'Mar';
  ['f-wti','f-abs','f-pct','f-commentary','f-main-quote','f-counter-quote']
    .forEach(id => document.getElementById(id).value = '');

  if (entryForEdit) {
    editKey = { date: entryForEdit.date, contract: entryForEdit.contract };
    document.getElementById('f-wti').value           = entryForEdit.wti;
    document.getElementById('f-abs').value           = entryForEdit.abs ?? '';
    document.getElementById('f-pct').value           = entryForEdit.pct;
    document.getElementById('f-date').value          = entryForEdit.date.replace(/\./g,'-');
    document.getElementById('f-cont').value          = entryForEdit.contract;
    document.getElementById('f-commentary').value    = entryForEdit.commentary;
    document.getElementById('f-main-quote').value    = entryForEdit.mainQuote;
    document.getElementById('f-counter-quote').value = entryForEdit.counterQuote;
    entryForEdit.mainFactors.split(',').map(s=>s.trim()).forEach(kr=>{
      const idx=FACTORS.findIndex(f=>f.kr===kr); if(idx>=0) mainSel.add(idx);
    });
    entryForEdit.counterFactors.split(',').map(s=>s.trim()).forEach(kr=>{
      const idx=FACTORS.findIndex(f=>f.kr===kr); if(idx>=0) counterSel.add(idx);
    });
    document.getElementById('parsed-wrap').style.display = 'block';
    document.getElementById('step-factors').style.display = 'block';
    document.getElementById('btn-save').style.display = 'block';
  }
  buildChips();
  document.getElementById('overlay').classList.add('open');
}
function closeModal() { document.getElementById('overlay').classList.remove('open'); }
document.addEventListener('keydown', e => { if(e.key==='Escape') closeModal(); });
document.getElementById('overlay').addEventListener('click', e => {
  if(e.target===document.getElementById('overlay')) closeModal();
});

function buildChips() {
  buildChipGroup('main-chips-bear',    mainSel,    'bear');
  buildChipGroup('main-chips-bull',    mainSel,    'bull');
  buildChipGroup('counter-chips-bear', counterSel, 'bear');
  buildChipGroup('counter-chips-bull', counterSel, 'bull');
}
function buildChipGroup(cid, selSet, tf) {
  const c = document.getElementById(cid); c.innerHTML = '';
  FACTORS.forEach((f,i) => {
    if (f.t!==tf) return;
    const ch = document.createElement('div');
    ch.className = 'chip'+(selSet.has(i)?` sel-${f.t}`:'');
    ch.textContent = f.kr;
    ch.addEventListener('click', ()=>{
      if(selSet.has(i)){selSet.delete(i);ch.className='chip';}
      else{selSet.add(i);ch.className=`chip sel-${f.t}`;}
    });
    c.appendChild(ch);
  });
}

// â”€â”€ PARSE â”€â”€
function doParse() {
  const txt = document.getElementById('news-ta').value.trim();
  if (!txt) {
    document.getElementById('parsed-wrap').style.display='block';
    document.getElementById('step-factors').style.display='block';
    document.getElementById('btn-save').style.display='block';
    buildChips(); showStatus('warn','í…ìŠ¤íŠ¸ ì—†ìŒ â€” ìˆ˜ë™ ì…ë ¥ ëª¨ë“œ'); return;
  }
  const f={}; let m;
  m=txt.match(/(?:í•˜ë½í•œ|ì˜¤ë¥¸|ë°€ë¦°|ë‚´ë¦°)\s*ë°°ëŸ´ë‹¹\s*([\d.]+)ë‹¬ëŸ¬/); if(m) f.wti=parseFloat(m[1]);
  if(!f.wti){m=txt.match(/ë°°ëŸ´ë‹¹\s*[\d.]+%\s*(?:í•˜ë½í•œ|ìƒìŠ¹í•œ|ì˜¤ë¥¸)\s*([\d.]+)ë‹¬ëŸ¬/);if(m)f.wti=parseFloat(m[1]);}
  if(!f.wti){m=txt.match(/ë°°ëŸ´ë‹¹\s*([\d.]+)ë‹¬ëŸ¬ì—\s*(?:ê±°ë˜|ë§ˆê°|ì²´ê²°)/);if(m)f.wti=parseFloat(m[1]);}
  const ws=(txt.match(/(?:WTI|ì„œë¶€í…ì‚¬ìŠ¤|í…ì‚¬ìŠ¤ì‚°ì›ìœ )[^\nã€‚]{0,250}/)||[''])[0];
  m=ws.match(/([\d.]+)ë‹¬ëŸ¬\(([\d.]+)%\)\s*(?:í•˜ë½|ë‚´ë¦°|ë°€ë¦°|ë–¨ì–´ì§„)/);
  if(m){f.abs=-parseFloat(m[1]);f.pct=-parseFloat(m[2]);}
  if(!f.abs){m=txt.match(/([\d.]+)ë‹¬ëŸ¬\(([\d.]+)%\)\s*(?:í•˜ë½|ë‚´ë¦°|ë°€ë¦°|ë–¨ì–´ì§„)/);if(m){f.abs=-parseFloat(m[1]);f.pct=-parseFloat(m[2]);}}
  if(!f.abs){m=ws.match(/([\d.]+)ë‹¬ëŸ¬\(([\d.]+)%\)\s*(?:ìƒìŠ¹|ì˜¤ë¥¸|ì˜¬ë¼)/);if(m){f.abs=parseFloat(m[1]);f.pct=parseFloat(m[2]);}}
  if(!f.pct){m=txt.match(/ë°°ëŸ´ë‹¹\s*([\d.]+)%\s*(í•˜ë½|ìƒìŠ¹)/);if(m)f.pct=m[2]==='í•˜ë½'?-parseFloat(m[1]):parseFloat(m[1]);}
  if(!f.abs&&f.wti&&f.pct){const p=f.wti/(1+f.pct/100);f.abs=parseFloat((f.wti-p).toFixed(2));}

  // ì›”ë¬¼
  const contM=txt.match(/(3|4|5|6)ì›”\s*(?:ì¸ë„ë¶„|ë¬¼)/);
  if(contM){const map={'3':'Mar','4':'Apr','5':'May','6':'Jun'};document.getElementById('f-cont').value=map[contM[1]]||'Mar';}

  // ë‚ ì§œ
  const todayKST=new Date(Date.now()+9*3600000);
  const dayM=txt.match(/(\d{1,2})ì¼\s*\(í˜„ì§€ì‹œê°„\)/);
  if(dayM){
    const day=parseInt(dayM[1]);
    // í˜„ì§€ì‹œê°„ ë‚ ì§œ + 1 = KST ê¸°ì¤€ì¼
    const yr=todayKST.getFullYear(), mo=todayKST.getMonth();
    const d=new Date(Date.UTC(yr,mo,day+1));
    document.getElementById('f-date').value=d.toISOString().slice(0,10);
  } else {
    const dm=txt.match(/(\d{4})[ë…„.\-\/]\s*(\d{1,2})[ì›”.\-\/]\s*(\d{1,2})/);
    if(dm) document.getElementById('f-date').value=`${dm[1]}-${dm[2].padStart(2,'0')}-${dm[3].padStart(2,'0')}`;
  }

  if(f.wti)     document.getElementById('f-wti').value=f.wti.toFixed(2);
  if(f.abs!=null) document.getElementById('f-abs').value=f.abs.toFixed(2);
  if(f.pct!=null) document.getElementById('f-pct').value=f.pct.toFixed(2);

  const direction=(f.pct??0)>0?'ìƒìŠ¹':(f.pct??0)<0?'í•˜ë½':'ë³´í•©';
  autoDetect(txt, direction);

  const mainQuote    = extractMainQuote(txt);
  const counterQuote = extractCounterQuote(txt, counterSel);
  if(mainQuote)    document.getElementById('f-main-quote').value    = mainQuote;
  if(counterQuote) document.getElementById('f-counter-quote').value = counterQuote;
  if(f.wti&&f.pct!=null)
    document.getElementById('f-commentary').value = buildCommentary(f.wti,f.pct,f.abs??null,direction);

  document.getElementById('parsed-wrap').style.display='block';
  document.getElementById('step-factors').style.display='block';
  document.getElementById('btn-save').style.display='block';
  buildChips();

  const ok=f.wti&&f.pct!=null;
  const bits=[];
  if(ok) bits.push(`âœ“ WTI $${f.wti.toFixed(2)} (${f.pct>=0?'+':''}${f.pct.toFixed(2)}%)`);
  bits.push(`ì£¼ìš”ì¸ ${mainSel.size}ê°œ`);
  if(counterSel.size) bits.push(`ë°˜ëŒ€ìš”ì¸ ${counterSel.size}ê°œ`);
  if(mainQuote)    bits.push('ì£¼ìš”ì¸ ì›ë¬¸ ì¶”ì¶œ');
  if(counterQuote) bits.push('ë°˜ëŒ€ìš”ì¸ ì›ë¬¸ ì¶”ì¶œ');
  bits.push('ì½”ë©˜í„°ë¦¬ ìƒì„±');
  showStatus(ok?'ok':'warn', bits.join(' Â· '));
}

function showStatus(t,m){const el=document.getElementById('parse-st');el.style.display='block';el.className=`parse-status ${t}`;el.textContent=m;}
function autoPct(){
  const wti=parseFloat(document.getElementById('f-wti').value);
  const abs=parseFloat(document.getElementById('f-abs').value);
  if(wti&&!isNaN(abs)&&wti-abs>0) document.getElementById('f-pct').value=(abs/(wti-abs)*100).toFixed(2);
}

// â”€â”€ SAVE â”€â”€
async function doSave() {
  const wti=parseFloat(document.getElementById('f-wti').value);
  const pct=parseFloat(document.getElementById('f-pct').value);
  const dateRaw=document.getElementById('f-date').value;
  if(!dateRaw||isNaN(wti)||isNaN(pct)){showStatus('err','ê¸°ì¤€ì¼, WTI ì¢…ê°€, ë³€ë™ë¥ ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.');return;}
  const date=fmtDate(dateRaw);
  const abs=parseFloat(document.getElementById('f-abs').value)||null;
  const cont=document.getElementById('f-cont').value;
  const direction=pct>0?'ìƒìŠ¹':pct<0?'í•˜ë½':'ë³´í•©';
  const mainArr=[]; mainSel.forEach(i=>mainArr.push(FACTORS[i].kr));
  const counterArr=[]; counterSel.forEach(i=>counterArr.push(FACTORS[i].kr));
  const data={
    date,contract:cont,wti,abs:abs!==null?abs:'',pct,direction,
    mainFactors:    mainArr.join(', '),
    mainQuote:      document.getElementById('f-main-quote').value.trim(),
    commentary:     document.getElementById('f-commentary').value.trim(),
    counterFactors: counterArr.join(', '),
    counterQuote:   document.getElementById('f-counter-quote').value.trim(),
  };
  const btn=document.getElementById('btn-save');
  btn.textContent='ì €ì¥ ì¤‘...'; btn.disabled=true;
  try {
    const res=await fetch(GAS_URL,{method:'POST',headers:{'Content-Type':'text/plain'},
      body:JSON.stringify({action:editKey?'edit':'save',rowKey:editKey,data})});
    const r=await res.json();
    if(r.success){toast('âœ… '+r.message,'ok');closeModal();await loadData();}
    else toast('âŒ '+r.message,'err');
  } catch(e){toast('âŒ ì˜¤ë¥˜: '+e.message,'err');}
  finally{btn.textContent='â–¶ êµ¬ê¸€ì‹œíŠ¸ ì €ì¥';btn.disabled=false;}
}

// â”€â”€ DELETE â”€â”€
async function deleteEntry(date,contract) {
  if(!confirm(`${date} ${contract} í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
  try {
    const res=await fetch(GAS_URL,{method:'POST',headers:{'Content-Type':'text/plain'},
      body:JSON.stringify({action:'delete',rowKey:{date,contract}})});
    const r=await res.json();
    if(r.success){toast('ğŸ—‘ '+r.message,'ok');await loadData();}
    else toast('âŒ '+r.message,'err');
  } catch(e){toast('âŒ ì˜¤ë¥˜: '+e.message,'err');}
}

// â”€â”€ RENDER â”€â”€
function renderCard(e) {
  const dir    = e.pct>0?'up':e.pct<0?'dn':'flt';
  const arrow  = e.pct>0?'â–²':e.pct<0?'â–¼':'â”€';
  const dirTxt = e.direction||(e.pct>0?'ìƒìŠ¹':e.pct<0?'í•˜ë½':'ë³´í•©');
  const pctStr = (e.pct>=0?'+':'')+e.pct.toFixed(2)+'%';
  const absStr = e.abs!=null?(e.abs>=0?'+':'')+e.abs.toFixed(2)+' USD':'';
  const cardId = 'card-'+e.date.replace(/\./g,'-')+'-'+e.contract;

  const mainTags = e.mainFactors
    ? e.mainFactors.split(',').filter(s=>s.trim()).map(kr=>{
        const f=FACTORS.find(x=>x.kr===kr.trim());
        return `<span class="factor-tag ${f?f.t:'dim'}">${kr.trim()}</span>`;
      }).join('') : '';

  const counterTags = e.counterFactors
    ? e.counterFactors.split(',').filter(s=>s.trim()).map(kr=>{
        const f=FACTORS.find(x=>x.kr===kr.trim());
        return `<span class="factor-tag ${f?f.t:'dim'}">${kr.trim()}</span>`;
      }).join('') : '';

  const hasMain    = mainTags || e.mainQuote;
  const hasCounter = counterTags || e.counterQuote;
  const hasFacts   = hasMain || hasCounter;
  const eJson      = encodeURIComponent(JSON.stringify(e));

  return `<div class="brief" id="${cardId}">

    <!-- â‘  ê°€ê²© í—¤ë” -->
    <div class="brief-header">
      <div class="bh-date">
        <div class="bh-date-val">${e.date}</div>
        <div class="bh-date-cont">NYMEX Â· ${e.contract}ì›”ë¬¼</div>
      </div>
      <div class="bh-price">
        <div class="bh-price-arrow ${dir}">${arrow}</div>
        <div class="bh-price-val ${dir}">${e.wti.toFixed(2)}</div>
        <div class="bh-price-unit">USD<br>/ bbl</div>
      </div>
      <div class="bh-delta">
        ${absStr?`<div class="bh-d-row">
          <span class="bh-d-label">Î”$</span>
          <span class="bh-d-val ${dir}">${absStr}</span>
        </div>`:''}
        <div class="bh-d-row">
          <span class="bh-d-label">Î”%</span>
          <span class="bh-d-val ${dir}">${pctStr}</span>
        </div>
      </div>
      <div class="bh-dir">
        <div class="bh-dir-badge ${dir}">${dirTxt}</div>
        <div class="bh-dir-label">direction</div>
      </div>
      <div class="bh-actions">
        <button class="act-btn edit" onclick="openModal(JSON.parse(decodeURIComponent('${eJson}')))">âœ EDIT</button>
        <button class="act-btn del"  onclick="deleteEntry('${e.date}','${e.contract}')">âœ• DEL</button>
      </div>
    </div>

    <!-- â‘¡ 2ì»¬ëŸ¼ íŒ©íŠ¸ íŒ¨ë„ -->
    ${hasFacts?`<div class="brief-facts">

      <!-- ì£¼ìš”ì¸ ì»¬ëŸ¼ -->
      <div class="fact-col">
        <div class="fact-col-title main">
          <span class="fc-dot ${dir==='up'?'bull':'bear'}"></span>
          ì£¼ìš”ì¸ Â· ${dirTxt}
        </div>
        ${mainTags?`<div class="factor-tags">${mainTags}</div>`:'<div class="fact-empty">ê°ì§€ëœ ì£¼ìš”ì¸ ì—†ìŒ</div>'}
        ${e.mainQuote?`<div class="source-quote">
          <div class="sq-label">ğŸ“° ì›ë¬¸ ì°¸ê³ </div>
          <div class="sq-text">${e.mainQuote}</div>
        </div>`:''}
      </div>

      <!-- ë°˜ëŒ€ìš”ì¸ ì»¬ëŸ¼ -->
      <div class="fact-col">
        <div class="fact-col-title counter">
          <span class="fc-dot dim"></span>
          ë°˜ëŒ€ìš”ì¸ Â· ì œí•œì  ì˜í–¥
        </div>
        ${counterTags?`<div class="factor-tags">${counterTags}</div>`:'<div class="fact-empty">ë°˜ëŒ€ìš”ì¸ ì—†ìŒ</div>'}
        ${e.counterQuote?`<div class="source-quote counter">
          <div class="sq-label">ğŸ“° ë°˜ëŒ€ìš”ì¸ ì›ë¬¸</div>
          <div class="sq-text">${e.counterQuote}</div>
        </div>`:''}
      </div>

    </div>`:''}

    <!-- â‘¢ ì½”ë©˜í„°ë¦¬ -->
    ${e.commentary?`<div class="brief-commentary">
      <div class="co-label">ì½”ë©˜í„°ë¦¬</div>
      <div class="co-text">${e.commentary}</div>
    </div>`:''}

    <!-- ë²„íŠ¼ -->
    <div class="brief-copy">
      <button class="cp-btn img" onclick="downloadImage('${cardId}','${e.date}')">â¬‡ ì´ë¯¸ì§€</button>
      <button class="cp-btn"     onclick="copyText('${cardId}')">Copy</button>
    </div>

  </div>`;
}

// â”€â”€ COPY â”€â”€
function copyText(cardId) {
  const el=document.querySelector(`#${cardId} .co-text`);
  if(!el) return;
  navigator.clipboard.writeText(el.textContent.trim()).then(()=>{
    const btn=document.querySelector(`#${cardId} .cp-btn:not(.img)`);
    if(btn){btn.classList.add('ok');btn.textContent='âœ“ Copied';
      setTimeout(()=>{btn.classList.remove('ok');btn.textContent='Copy';},1800);}
  });
}

// â”€â”€ IMAGE â”€â”€
async function downloadImage(cardId, date) {
  const el=document.getElementById(cardId); if(!el) return;
  const btn=el.querySelector('.cp-btn.img');
  if(btn){btn.textContent='ìº¡ì²˜ ì¤‘...';btn.disabled=true;}
  try {
    const canvas=await html2canvas(el,{backgroundColor:'#1e2128',scale:2,useCORS:true,logging:false});
    const a=document.createElement('a');
    a.download=`WTI_${date}.png`; a.href=canvas.toDataURL('image/png'); a.click();
    toast('âœ… ì´ë¯¸ì§€ ì €ì¥ë¨','ok');
  } catch(e){toast('âŒ ì´ë¯¸ì§€ ì˜¤ë¥˜: '+e.message,'err');}
  finally{if(btn){btn.textContent='â¬‡ ì´ë¯¸ì§€';btn.disabled=false;}}
}

// â”€â”€ TOAST â”€â”€
function toast(msg,type='inf',ms=3200) {
  const t=document.getElementById('toast');
  t.textContent=msg; t.className=`show ${type}`;
  clearTimeout(t._t); t._t=setTimeout(()=>t.className='',ms);
}

loadData();
</script>
</body>
</html>
