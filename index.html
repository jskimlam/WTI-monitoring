<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WTI MORNING BRIEF</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Mono:ital,wght@0,300;0,400;0,500;1,300&family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
:root {
  --bg:      #1a1f2e;
  --surface: #222838;
  --card:    #262d3f;
  --inset:   #1e2434;
  --border:  #323d55;
  --border2: #3d4d6a;
  --acc:     #e8c46a;
  --acc2:    #5b9cf6;
  --green:   #34d875;
  --red:     #f26b6b;
  --text:    #e2e8f4;
  --text2:   #b0bcd4;
  --dim:     #6a7a99;
  --quote:   #c8d6f0;
  --mono:    'DM Mono', monospace;
  --sans:    'Noto Sans KR', sans-serif;
  --display: 'Bebas Neue', sans-serif;
}
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html, body { min-height: 100%; background: var(--bg); color: var(--text); font-family: var(--sans); }

/* â”€â”€ HEADER â”€â”€ */
.hdr {
  position: sticky; top: 0; z-index: 100;
  background: rgba(26,31,46,.96); backdrop-filter: blur(14px);
  border-bottom: 1px solid var(--border);
  display: flex; align-items: center; justify-content: space-between;
  padding: 0 32px; height: 62px;
}
.hdr-left  { display: flex; align-items: baseline; gap: 16px; }
.hdr-logo  { font-family: var(--display); font-size: 30px; letter-spacing: .12em; color: var(--acc); }
.hdr-sub   { font-family: var(--mono); font-size: 11px; letter-spacing: .18em; color: var(--dim); text-transform: uppercase; }
.hdr-right { display: flex; align-items: center; gap: 10px; }
.hdr-clock { font-family: var(--mono); font-size: 13px; color: var(--text2); }
.btn-new {
  display: flex; align-items: center; gap: 7px;
  background: var(--acc); color: #1a1f2e; border: none; border-radius: 4px;
  padding: 9px 20px; font-family: var(--mono); font-size: 12px;
  font-weight: 500; letter-spacing: .12em; text-transform: uppercase;
  cursor: pointer; transition: background .15s;
}
.btn-new:hover { background: #f0d080; }
.btn-refresh {
  background: transparent; border: 1px solid var(--border2); color: var(--dim);
  padding: 8px 14px; border-radius: 4px; font-family: var(--mono); font-size: 11px;
  letter-spacing: .1em; text-transform: uppercase; cursor: pointer; transition: all .15s;
}
.btn-refresh:hover { border-color: var(--acc2); color: var(--acc2); }

/* â”€â”€ LAYOUT â”€â”€ */
.wrap { max-width: 980px; margin: 0 auto; padding: 32px 24px 80px; }
.empty { text-align: center; padding: 90px 0; font-family: var(--mono); font-size: 12px; letter-spacing: .12em; color: var(--dim); }
.empty .e-icon { font-size: 40px; margin-bottom: 18px; opacity: .25; }
.loading { text-align: center; padding: 60px 0; font-family: var(--mono); font-size: 11px; color: var(--dim); letter-spacing: .1em; }
.spinner { width: 28px; height: 28px; border: 2px solid var(--border2); border-top-color: var(--acc2); border-radius: 50%; animation: spin .7s linear infinite; margin: 0 auto 14px; }
@keyframes spin { to { transform: rotate(360deg); } }

/* â”€â”€ BRIEF CARD â”€â”€ */
.brief {
  background: var(--surface); border: 1px solid var(--border); border-radius: 6px;
  margin-bottom: 24px; overflow: hidden;
  box-shadow: 0 4px 24px rgba(0,0,0,.2);
  animation: fadeUp .28s ease both;
}
@keyframes fadeUp { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:none} }

.brief-strip { display: flex; align-items: stretch; border-bottom: 1px solid var(--border); background: var(--card); }
.strip-date {
  padding: 20px 26px; border-right: 1px solid var(--border);
  display: flex; flex-direction: column; justify-content: center; gap: 5px; min-width: 170px;
}
.sd-date { font-family: var(--mono); font-size: 16px; color: var(--text); font-weight: 500; }
.sd-cont { font-family: var(--mono); font-size: 11px; color: var(--dim); }
.strip-price { flex: 1; display: flex; align-items: center; padding: 20px 30px; gap: 28px; }
.sp-val { font-family: var(--display); font-size: 72px; letter-spacing: .02em; line-height: 1; }
.sp-val.up  { color: var(--green); }
.sp-val.dn  { color: var(--red); }
.sp-val.flt { color: var(--text); }
.sp-unit { font-family: var(--mono); font-size: 13px; color: var(--dim); align-self: flex-end; padding-bottom: 8px; }
.sp-delta { display: flex; flex-direction: column; gap: 8px; padding-left: 28px; border-left: 1px solid var(--border); }
.sp-d-row   { display: flex; align-items: center; gap: 10px; }
.sp-d-label { font-family: var(--mono); font-size: 10px; letter-spacing: .1em; color: var(--dim); width: 32px; text-transform: uppercase; }
.sp-d-val   { font-family: var(--mono); font-size: 19px; font-weight: 500; }
.sp-d-val.up { color: var(--green); } .sp-d-val.dn { color: var(--red); }

.strip-actions { display: flex; flex-direction: column; border-left: 1px solid var(--border); }
.act-btn {
  flex: 1; display: flex; align-items: center; justify-content: center;
  background: transparent; border: none; cursor: pointer;
  font-family: var(--mono); font-size: 11px; letter-spacing: .1em; color: var(--dim);
  padding: 0 18px; transition: all .15s; text-transform: uppercase; gap: 5px;
  border-bottom: 1px solid var(--border);
}
.act-btn:last-child { border-bottom: none; }
.act-btn.edit:hover { background: rgba(91,156,246,.1); color: var(--acc2); }
.act-btn.del:hover  { background: rgba(242,107,107,.08); color: var(--red); }

.brief-body { padding: 22px 26px; border-bottom: 1px solid var(--border); }
.fc-title {
  font-family: var(--mono); font-size: 10px; letter-spacing: .16em; text-transform: uppercase;
  padding-bottom: 9px; margin-bottom: 10px; border-bottom: 1px solid var(--border);
  display: flex; align-items: center; gap: 7px;
}
.fc-title.main    { color: var(--text2); }
.fc-title.counter { color: var(--dim); }
.fc-dot { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; }
.fc-dot.bear { background: var(--red); }
.fc-dot.bull { background: var(--green); }
.fc-dot.dim  { background: var(--dim); }

.factor-tag {
  display: inline-block; padding: 3px 10px; border-radius: 3px;
  font-size: 13px; font-weight: 500; margin: 3px 4px 3px 0;
}
.factor-tag.bear { background: rgba(242,107,107,.12); color: var(--red); border: 1px solid rgba(242,107,107,.25); }
.factor-tag.bull { background: rgba(52,216,117,.12);  color: var(--green); border: 1px solid rgba(52,216,117,.25); }
.factor-tag.dim  { background: rgba(106,122,153,.1);  color: var(--dim); border: 1px solid rgba(106,122,153,.2); }

.source-quote {
  background: var(--inset); border: 1px solid var(--border);
  border-left: 3px solid var(--acc); border-radius: 4px;
  padding: 11px 16px; margin-top: 14px;
}
.sq-label { font-family: var(--mono); font-size: 9px; letter-spacing: .16em; text-transform: uppercase; color: var(--acc); margin-bottom: 6px; }
.sq-text  { font-size: 13px; line-height: 1.78; color: var(--quote); font-style: italic; }
.sq-text::before { content: '"'; color: var(--acc); font-size: 18px; line-height: 0; vertical-align: -3px; margin-right: 3px; }
.sq-text::after  { content: '"'; color: var(--acc); font-size: 18px; line-height: 0; vertical-align: -3px; margin-left:  3px; }

.source-quote.counter { border-left-color: var(--dim); margin-top: 10px; }
.source-quote.counter .sq-label { color: var(--dim); }

.brief-commentary { padding: 20px 26px; border-bottom: 1px solid var(--border); }
.co-label {
  font-family: var(--mono); font-size: 10px; letter-spacing: .16em; text-transform: uppercase;
  color: var(--dim); margin-bottom: 10px; display: flex; align-items: center; gap: 8px;
}
.co-label::after { content: ''; flex: 1; height: 1px; background: var(--border); }
.co-text { font-size: 14px; line-height: 1.9; color: var(--text2); white-space: pre-wrap; }

.brief-copy {
  padding: 12px 26px; display: flex; align-items: center; justify-content: flex-end; gap: 8px;
  background: var(--card);
}
.cp-btn {
  font-family: var(--mono); font-size: 11px; letter-spacing: .08em; text-transform: uppercase;
  background: transparent; border: 1px solid var(--border2); color: var(--dim);
  padding: 7px 15px; border-radius: 3px; cursor: pointer; transition: all .15s;
}
.cp-btn:hover    { border-color: var(--acc); color: var(--acc); }
.cp-btn.pri      { background: var(--acc2); color: #fff; border-color: var(--acc2); }
.cp-btn.img      { border-color: var(--border2); color: var(--dim); }
.cp-btn.ok       { border-color: var(--green); color: var(--green); }

/* â”€â”€ MODAL â”€â”€ */
#overlay {
  position: fixed; inset: 0; z-index: 200;
  background: rgba(14,18,30,.88); backdrop-filter: blur(10px);
  display: none; align-items: center; justify-content: center;
}
#overlay.open { display: flex; }
#modal {
  width: 740px; max-height: 92vh;
  background: var(--surface); border: 1px solid var(--border2); border-radius: 8px;
  display: flex; flex-direction: column; overflow: hidden;
  box-shadow: 0 32px 80px rgba(0,0,0,.5); animation: mIn .2s ease;
}
@keyframes mIn { from{opacity:0;transform:translateY(14px) scale(.98)} to{opacity:1;transform:none} }
.mhdr {
  display: flex; align-items: center; justify-content: space-between;
  padding: 16px 24px; border-bottom: 1px solid var(--border); background: var(--card); flex-shrink: 0;
}
.mhdr-title { font-family: var(--mono); font-size: 13px; letter-spacing: .14em; text-transform: uppercase; color: var(--acc); }
.mhdr-close {
  background: transparent; border: 1px solid var(--border2); color: var(--dim);
  width: 30px; height: 30px; border-radius: 3px; cursor: pointer; font-size: 16px;
  display: flex; align-items: center; justify-content: center; transition: all .15s;
}
.mhdr-close:hover { border-color: var(--red); color: var(--red); }
.mbody { flex: 1; overflow-y: auto; padding: 22px 24px; display: flex; flex-direction: column; gap: 18px; }
.m-sec-label { font-family: var(--mono); font-size: 10px; letter-spacing: .18em; text-transform: uppercase; color: var(--dim); margin-bottom: 8px; }
#news-ta {
  width: 100%; height: 140px; resize: vertical;
  background: var(--card); border: 1px solid var(--border); border-radius: 4px;
  color: var(--text); font-family: var(--sans); font-size: 13px; line-height: 1.72;
  padding: 12px 14px; outline: none; transition: border-color .15s;
}
#parsed-wrap, #step-factors { display: none; }
.pf-grid   { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
.pf-grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
.pfield { display: flex; flex-direction: column; gap: 5px; }
.pfield label { font-family: var(--mono); font-size: 10px; letter-spacing: .1em; text-transform: uppercase; color: var(--dim); }
.pfield input, .pfield select, .pfield textarea {
  background: var(--card); border: 1px solid var(--border); border-radius: 4px;
  color: var(--text); font-family: var(--mono); font-size: 14px;
  padding: 9px 11px; outline: none; width: 100%; transition: border-color .15s;
}
.pfield textarea { resize: vertical; min-height: 52px; font-family: var(--sans); font-size: 13px; line-height: 1.65; }

.parse-status {
  font-family: var(--mono); font-size: 12px; padding: 9px 13px;
  border-radius: 4px; margin-top: 6px; display: none;
}
.parse-status.ok   { background: rgba(52,216,117,.08);  border: 1px solid rgba(52,216,117,.25);  color: var(--green); }
.parse-status.warn { background: rgba(232,196,106,.08); border: 1px solid rgba(232,196,106,.25); color: var(--acc); }

.chip-wrap  { display: flex; flex-wrap: wrap; gap: 7px; }
.chip {
  font-family: var(--mono); font-size: 11px; letter-spacing: .04em;
  padding: 5px 13px; border-radius: 3px; border: 1px solid var(--border2);
  color: var(--dim); cursor: pointer; transition: all .12s; user-select: none;
}
.chip.sel-bear { background: rgba(242,107,107,.1); border-color: rgba(242,107,107,.45); color: var(--red); }
.chip.sel-bull { background: rgba(52,216,117,.1);  border-color: rgba(52,216,117,.45);  color: var(--green); }

.mftr {
  flex-shrink: 0; padding: 14px 24px; border-top: 1px solid var(--border);
  display: flex; gap: 8px; background: var(--card);
}
.mf-btn { padding: 11px 18px; border: none; border-radius: 4px; cursor: pointer; font-family: var(--mono); font-size: 12px; letter-spacing: .1em; text-transform: uppercase; font-weight: 500; transition: all .15s; }
.mf-parse       { flex: 1; background: var(--border2); color: var(--text); }
.mf-save        { flex: 2; background: var(--acc); color: #1a1f2e; display: none; }
.mf-close { background: transparent; border: 1px solid var(--border2); color: var(--dim); padding: 11px 16px; border-radius: 4px; cursor: pointer; font-family: var(--mono); font-size: 12px; transition: all .15s; }

/* TOAST */
#toast {
  position: fixed; bottom: 28px; right: 28px; z-index: 9999;
  padding: 12px 18px; border-radius: 6px; font-family: var(--mono); font-size: 12px;
  font-weight: 500; color: #fff; opacity: 0; transform: translateY(10px);
  transition: all .24s; pointer-events: none; max-width: 300px;
}
#toast.show { opacity: 1; transform: translateY(0); }
#toast.ok  { background: #1e6e40; }
#toast.err { background: #7a1f1f; }

::-webkit-scrollbar { width: 5px; }
::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 3px; }
</style>
</head>
<body>

<header class="hdr">
  <div class="hdr-left">
    <div class="hdr-logo">WTI BRIEF</div>
    <div class="hdr-sub">Crude Oil Â· Morning Monitor</div>
  </div>
  <div class="hdr-right">
    <div class="hdr-clock" id="clock"></div>
    <button class="btn-refresh" onclick="loadData()">â†» REFRESH</button>
    <button class="btn-new" onclick="openModal()">+ NEW ENTRY</button>
  </div>
</header>

<div class="wrap">
  <div id="loading" style="display:none"><div class="spinner"></div>ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
  <div class="empty" id="empty" style="display:none">
    <div class="e-icon">â—ˆ</div>
    <div>NO ENTRIES YET</div>
    <div style="margin-top:8px;font-size:10px">Click <strong style="color:var(--acc)">+ NEW ENTRY</strong> to add today's WTI brief</div>
  </div>
  <div id="cards"></div>
</div>

<div id="overlay">
  <div id="modal">
    <div class="mhdr">
      <div class="mhdr-title" id="modal-title">â—ˆ NEW WTI ENTRY</div>
      <button class="mhdr-close" onclick="closeModal()">âœ•</button>
    </div>
    <div class="mbody">
      <div>
        <div class="m-sec-label">01 Â· ë‰´ìŠ¤ í…ìŠ¤íŠ¸ ë¶™ì—¬ë„£ê¸°</div>
        <textarea id="news-ta" placeholder="WTI ê¸°ì‚¬ ì „ë¬¸ ë¶™ì—¬ë„£ê¸° â†’ ìë™ íŒŒì‹±"></textarea>
        <div class="parse-status" id="parse-st"></div>
      </div>

      <div id="parsed-wrap">
        <div class="m-sec-label">02 Â· ìˆ˜ì¹˜ í™•ì¸ ë° ìˆ˜ì •</div>
        <div class="pf-grid" style="margin-bottom:10px">
          <div class="pfield"><label>WTI ì¢…ê°€ ($/bbl) *</label><input type="number" id="f-wti" step="0.01"></div>
          <div class="pfield"><label>ì „ì¼æ¯” $</label><input type="number" id="f-abs" step="0.01" oninput="autoPct()"></div>
          <div class="pfield"><label>ë³€ë™ë¥  %</label><input type="number" id="f-pct" step="0.01"></div>
        </div>
        <div class="pf-grid-2" style="margin-bottom:10px">
          <div class="pfield"><label>ê¸°ì¤€ì¼ *</label><input type="date" id="f-date"></div>
          <div class="pfield"><label>ì›”ë¬¼ *</label>
            <select id="f-cont">
              <option value="Mar">3ì›”ë¬¼ (Mar)</option>
              <option value="Apr">4ì›”ë¬¼ (Apr)</option>
              <option value="May">5ì›”ë¬¼ (May)</option>
              <option value="Jun">6ì›”ë¬¼ (Jun)</option>
            </select>
          </div>
        </div>
        <div class="pf-grid-2">
          <div class="pfield"><label>ì½”ë©˜í„°ë¦¬ (ìë™ ì¶”ì¶œ)</label><textarea id="f-commentary" placeholder="ê¸°ì‚¬ ë‚´ìš© ìš”ì•½..."></textarea></div>
          <div class="pfield"><label>ì£¼ìš”ì¸ ì›ë¬¸ (ìë™ ì¶”ì¶œ)</label><textarea id="f-main-quote" placeholder="ì›ì¸ ë¬¸ì¥..."></textarea></div>
        </div>
      </div>

      <div id="step-factors">
        <div class="m-sec-label">03 Â· ì£¼ìš”ì¸ ì„ íƒ</div>
        <div class="chip-wrap" id="main-chips"></div>
        <div style="height:1px; background:var(--border); margin:14px 0"></div>
        <div class="m-sec-label">04 Â· ë°˜ëŒ€ìš”ì¸ ì„ íƒ (ì„ íƒì‚¬í•­)</div>
        <div class="chip-wrap" id="counter-chips"></div>
        <div style="margin-top:12px">
          <div class="pfield"><label>ë°˜ëŒ€ìš”ì¸ ì›ë¬¸</label><textarea id="f-counter-quote" placeholder="ë°˜ëŒ€ìš”ì¸ ì–¸ê¸‰ ë¬¸ì¥..."></textarea></div>
        </div>
      </div>
    </div>
    <div class="mftr">
      <button class="mf-btn mf-parse" id="btn-parse" onclick="doParse()">ğŸ” íŒŒì‹±</button>
      <button class="mf-btn mf-save"  id="btn-save"  onclick="doSave()">â–¶ êµ¬ê¸€ì‹œíŠ¸ ì €ì¥</button>
      <button class="mf-close" onclick="closeModal()">ë‹«ê¸°</button>
    </div>
  </div>
</div>

<div id="toast"></div>

<script>
// ì•Œë ¤ì£¼ì‹  ìƒˆë¡œìš´ GAS URL ì ìš©
const GAS_URL = 'https://script.google.com/macros/s/AKfycbwhEYfc54h-rmf3bORWJCMapYFiZ162Rrnh1ScnBLT0z_wzRc5mSL6lMC10XZPBCHbn/exec';

function tick() {
  const k = new Date(Date.now() + 9*3600000);
  document.getElementById('clock').textContent = k.toISOString().slice(0,10) + '  ' + k.toISOString().slice(11,19) + ' KST';
}
tick(); setInterval(tick, 1000);

const FACTORS = [
  { t:'bear', kr:'ë¯¸Â·ì´ë€ í•µ í˜‘ìƒ ì§„ì „', kw:['ì´ë€',['í•©ì˜','ì§„ì „']] },
  { t:'bear', kr:'ì¤‘ë™ ì§€ì •í•™ ë¦¬ìŠ¤í¬ ì™„í™”', kw:['ì¤‘ë™','ì™„í™”'] },
  { t:'bear', kr:'IEA ìˆ˜ìš” ì „ë§ í•˜í–¥', kw:['iea','í•˜í–¥'] },
  { t:'bear', kr:'OPEC+ ì¦ì‚° ë…¼ì˜', kw:['opec','ì¦ì‚°'] },
  { t:'bear', kr:'ë¯¸ ì›ìœ  ì¬ê³  ì¦ê°€ (EIA)', kw:['ì¬ê³ ','ì¦ê°€'] },
  { t:'bear', kr:'ë‹¬ëŸ¬ ê°•ì„¸', kw:['ë‹¬ëŸ¬','ê°•ì„¸'] },
  { t:'bear', kr:'ê²½ê¸°ì¹¨ì²´ ìš°ë ¤', kw:['ê²½ê¸°ì¹¨ì²´'] },
  { t:'bull', kr:'ì¤‘ë™ ê¸´ì¥ ê³ ì¡°', kw:['ì¤‘ë™','ê¸´ì¥'] },
  { t:'bull', kr:'OPEC+ ê°ì‚° ìœ ì§€Â·ê°•í™”', kw:['opec','ê°ì‚°'] },
  { t:'bull', kr:'ë¯¸ ì›ìœ  ì¬ê³  ê°ì†Œ (EIA)', kw:['ì¬ê³ ','ê°ì†Œ'] },
  { t:'bull', kr:'IEA/EIA ìˆ˜ìš” ì „ë§ ìƒí–¥', kw:['iea','ìƒí–¥'] },
  { t:'bull', kr:'ë‹¬ëŸ¬ ì•½ì„¸', kw:['ë‹¬ëŸ¬','ì•½ì„¸'] },
];

const mainSel = new Set();
const counterSel = new Set();
let editKey = null;

// â”€â”€ ì¶”ê°€ëœ ë¡œì§: ì½”ë©˜í„°ë¦¬ ìë™ ì¶”ì¶œ (í•µì‹¬ ë¬¸ì¥ ì°¾ê¸°) â”€â”€
function extractCommentary(txt) {
  const sents = txt.split(/(?<=[ë‹¤ìŠµë‹ˆë‹¤ê¹Œìš”]\.)\s+/).map(s => s.trim());
  const summary = sents.find(s => s.includes('ë§ˆê°') || s.includes('ê¸°ë¡') || s.includes('ë³´ì˜€ë‹¤')) || sents[0];
  return summary ? summary.substring(0, 150) : "";
}

// â”€â”€ ì£¼ìš”ì¸ ì›ë¬¸ ì¶”ì¶œ ë¡œì§ â”€â”€
function extractQuote(txt) {
  const sents = txt.split(/(?<=[ë‹¤ìŠµë‹ˆë‹¤ê¹Œìš”]\.)\s+/).map(s => s.trim()).filter(s => s.length > 20 && s.length < 220);
  const patterns = [/ê°€ìš´ë°.{4,50}(?:í•˜ë½|ìƒìŠ¹|ë§ˆê°)/, /ì†Œì‹[ì´ì—].{2,40}(?:í•˜ë½|ìƒìŠ¹)/, /ì˜í–¥ìœ¼ë¡œ.{4,40}(?:í•˜ë½|ìƒìŠ¹)/, /ìš°ë ¤[ê°€ì—].{4,40}(?:í•˜ë½|ìƒìŠ¹)/];
  for (const p of patterns) {
    const found = sents.find(s => p.test(s));
    if (found) return found.trim();
  }
  return null;
}

async function loadData() {
  document.getElementById('loading').style.display = 'block';
  document.getElementById('cards').innerHTML = '';
  document.getElementById('empty').style.display = 'none';
  try {
    const res = await fetch(GAS_URL + '?t=' + Date.now());
    const json = await res.json();
    if (!json.success) throw new Error(json.message);
    const rows = json.data.slice(1).reverse();
    if (!rows.length) { document.getElementById('empty').style.display = 'block'; return; }
    document.getElementById('cards').innerHTML = rows.map(r => ({
      date: String(r[0]||'').trim(), contract: String(r[1]||'').trim(),
      wti: parseFloat(r[2])||0, abs: r[3]!==''?parseFloat(r[3]):null, pct: parseFloat(r[4])||0,
      direction: String(r[5]||'').trim(), mainFactors: String(r[6]||'').trim(), mainQuote: String(r[7]||'').trim(),
      commentary: String(r[8]||'').trim(), counterFactors: String(r[9]||'').trim(), counterQuote: String(r[10]||'').trim()
    })).map(renderCard).join('');
  } catch(e) { toast('âŒ ë¡œë“œ ì‹¤íŒ¨: ' + e.message, 'err'); }
  finally { document.getElementById('loading').style.display = 'none'; }
}

function openModal(e = null) {
  editKey = null; mainSel.clear(); counterSel.clear();
  document.getElementById('modal-title').textContent = e ? 'â—ˆ EDIT ENTRY' : 'â—ˆ NEW WTI ENTRY';
  document.getElementById('news-ta').value = '';
  document.getElementById('parse-st').style.display = 'none';
  document.getElementById('parsed-wrap').style.display = 'none';
  document.getElementById('step-factors').style.display = 'none';
  document.getElementById('btn-save').style.display = 'none';

  const today = new Date(Date.now() + 9*3600000).toISOString().slice(0,10);
  document.getElementById('f-date').value = today;
  ['f-wti','f-abs','f-pct','f-commentary','f-main-quote','f-counter-quote'].forEach(id => document.getElementById(id).value = '');

  if (e) {
    editKey = { date: e.date, contract: e.contract };
    document.getElementById('f-wti').value = e.wti;
    document.getElementById('f-abs').value = e.abs ?? '';
    document.getElementById('f-pct').value = e.pct;
    document.getElementById('f-date').value = e.date;
    document.getElementById('f-cont').value = e.contract;
    document.getElementById('f-commentary').value = e.commentary;
    document.getElementById('f-main-quote').value = e.mainQuote;
    document.getElementById('f-counter-quote').value = e.counterQuote;
    e.mainFactors.split(',').forEach(k => { const i = FACTORS.findIndex(f=>f.kr===k.trim()); if(i>=0) mainSel.add(i); });
    e.counterFactors.split(',').forEach(k => { const i = FACTORS.findIndex(f=>f.kr===k.trim()); if(i>=0) counterSel.add(i); });
    document.getElementById('parsed-wrap').style.display = 'block';
    document.getElementById('step-factors').style.display = 'block';
    document.getElementById('btn-save').style.display = 'block';
  }
  buildChips();
  document.getElementById('overlay').classList.add('open');
}

function closeModal() { document.getElementById('overlay').classList.remove('open'); }

function buildChips() {
  const b = (id, s) => {
    const c = document.getElementById(id); c.innerHTML = '';
    FACTORS.forEach((f, i) => {
      const d = document.createElement('div');
      d.className = 'chip' + (s.has(i) ? ` sel-${f.t}` : '');
      d.textContent = f.kr;
      d.onclick = () => { if(s.has(i)) { s.delete(i); d.className='chip'; } else { s.add(i); d.className=`chip sel-${f.t}`; } };
      c.appendChild(d);
    });
  };
  b('main-chips', mainSel); b('counter-chips', counterSel);
}

// â”€â”€ ìˆ˜ì •ëœ doParse: ì½”ë©˜í„°ë¦¬ ë° ì£¼ìš”ì¸ ìë™ ì±„ìš°ê¸° â”€â”€
function doParse() {
  const txt = document.getElementById('news-ta').value.trim();
  if (!txt) {
    document.getElementById('parsed-wrap').style.display = 'block';
    document.getElementById('step-factors').style.display = 'block';
    document.getElementById('btn-save').style.display = 'block';
    buildChips(); return;
  }

  const f = {}; let m;
  m = txt.match(/(?:í•˜ë½í•œ|ì˜¤ë¥¸|ë°€ë¦°|ë‚´ë¦°)\s*ë°°ëŸ´ë‹¹\s*([\d.]+)ë‹¬ëŸ¬/); if(m) f.wti=parseFloat(m[1]);
  const ws = (txt.match(/(?:WTI|ì„œë¶€í…ì‚¬ìŠ¤|í…ì‚¬ìŠ¤ì‚°ì›ìœ )[^\nã€‚]{0,200}/)||[''])[0];
  m = ws.match(/([\d.]+)ë‹¬ëŸ¬\(([\d.]+)%\)\s*(?:í•˜ë½|ë‚´ë¦°|ë°€ë¦°|ë–¨ì–´ì§„)/);
  if(m){ f.abs=-parseFloat(m[1]); f.pct=-parseFloat(m[2]); }
  else { m=ws.match(/([\d.]+)ë‹¬ëŸ¬\(([\d.]+)%\)\s*(?:ìƒìŠ¹|ì˜¤ë¥¸|ì˜¬ë¼)/); if(m){f.abs=parseFloat(m[1]); f.pct=parseFloat(m[2]);} }

  if(f.wti) document.getElementById('f-wti').value = f.wti.toFixed(2);
  if(f.abs) document.getElementById('f-abs').value = f.abs.toFixed(2);
  if(f.pct) document.getElementById('f-pct').value = f.pct.toFixed(2);

  // ì½”ë©˜í„°ë¦¬ ë° ì£¼ìš”ì¸ ì¶”ì¶œ ê²°ê³¼ ì…ë ¥
  document.getElementById('f-commentary').value = extractCommentary(txt);
  const q = extractQuote(txt); if(q) document.getElementById('f-main-quote').value = q;

  const lo = txt.toLowerCase();
  mainSel.clear();
  FACTORS.forEach((f,i) => { if(f.kw.every(k => Array.isArray(k)?k.some(kk=>lo.includes(kk)):lo.includes(k))) mainSel.add(i); });

  document.getElementById('parsed-wrap').style.display = 'block';
  document.getElementById('step-factors').style.display = 'block';
  document.getElementById('btn-save').style.display = 'block';
  buildChips();
  const ok = f.wti && f.pct !== undefined;
  const el = document.getElementById('parse-st');
  el.style.display='block'; el.className=`parse-status ${ok?'ok':'warn'}`;
  el.textContent = ok ? 'âœ“ ë°ì´í„° ë° ì½”ë©˜í„°ë¦¬ ìë™ ì¶”ì¶œ ì™„ë£Œ' : 'âš  ìˆ˜ì¹˜ ì§ì ‘ í™•ì¸ í•„ìš”';
}

function autoPct() {
  const w = parseFloat(document.getElementById('f-wti').value);
  const a = parseFloat(document.getElementById('f-abs').value);
  if(w && !isNaN(a) && w-a>0) document.getElementById('f-pct').value = (a/(w-a)*100).toFixed(2);
}

async function doSave() {
  const w = parseFloat(document.getElementById('f-wti').value);
  const p = parseFloat(document.getElementById('f-pct').value);
  const d = document.getElementById('f-date').value;
  if(!d || isNaN(w) || isNaN(p)){ alert('í•„ìˆ˜ í•­ëª©ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }

  const data = {
    date: d, contract: document.getElementById('f-cont').value, wti: w,
    abs: document.getElementById('f-abs').value||'', pct: p, direction: p>0?'ìƒìŠ¹':p<0?'í•˜ë½':'ë³´í•©',
    mainFactors: Array.from(mainSel).map(i=>FACTORS[i].kr).join(', '),
    mainQuote: document.getElementById('f-main-quote').value.trim(),
    commentary: document.getElementById('f-commentary').value.trim(),
    counterFactors: Array.from(counterSel).map(i=>FACTORS[i].kr).join(', '),
    counterQuote: document.getElementById('f-counter-quote').value.trim()
  };

  const b = document.getElementById('btn-save'); b.textContent='ì €ì¥ ì¤‘...'; b.disabled=true;
  try {
    const res = await fetch(GAS_URL, { method:'POST', body: JSON.stringify({ action: editKey?'edit':'save', rowKey:editKey, data }) });
    const r = await res.json();
    if(r.success) { toast('âœ… ì €ì¥ ì™„ë£Œ', 'ok'); closeModal(); loadData(); }
    else toast('âŒ ' + r.message, 'err');
  } catch(e) { toast('âŒ ì˜¤ë¥˜: ' + e.message, 'err'); }
  finally { b.textContent='â–¶ êµ¬ê¸€ì‹œíŠ¸ ì €ì¥'; b.disabled=false; }
}

async function deleteEntry(date, contract) {
  if(!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  try {
    const res = await fetch(GAS_URL, { method:'POST', body: JSON.stringify({ action:'delete', rowKey:{ date, contract } }) });
    const r = await res.json();
    if(r.success) { toast('ğŸ—‘ ì‚­ì œë¨', 'ok'); loadData(); }
  } catch(e) { toast('âŒ ì˜¤ë¥˜', 'err'); }
}

function renderCard(e) {
  const dir = e.pct>0?'up':e.pct<0?'dn':'flt';
  const arrow = e.pct>0?'â–²':e.pct<0?'â–¼':'â”€';
  const eJson = encodeURIComponent(JSON.stringify(e));
  const mainTags = e.mainFactors ? e.mainFactors.split(',').map(k => `<span class="factor-tag ${FACTORS.find(x=>x.kr===k.trim())?.t||'dim'}">${k.trim()}</span>`).join('') : '';
  const counterTags = e.counterFactors ? e.counterFactors.split(',').map(k => k.trim()?`<span class="factor-tag dim">${k.trim()}</span>`:'').join('') : '';

  return `<div class="brief" id="card-${e.date}-${e.contract}">
    <div class="brief-strip">
      <div class="strip-date"><div class="sd-date">${e.date}</div><div class="sd-cont">NYMEX Â· ${e.contract}ì›”ë¬¼</div></div>
      <div class="strip-price">
        <div class="sp-val ${dir}">${arrow} ${e.wti.toFixed(2)}</div>
        <div class="sp-unit">USD / bbl</div>
        <div class="sp-delta">
          <div class="sp-d-row"><span class="sp-d-label">Î”$</span><span class="sp-d-val ${dir}">${e.abs??''}</span></div>
          <div class="sp-d-row"><span class="sp-d-label">Î”%</span><span class="sp-d-val ${dir}">${(e.pct>=0?'+':'')+e.pct.toFixed(2)}%</span></div>
        </div>
      </div>
      <div class="strip-actions">
        <button class="act-btn edit" onclick="openModal(JSON.parse(decodeURIComponent('${eJson}')))">âœ EDIT</button>
        <button class="act-btn del" onclick="deleteEntry('${e.date}','${e.contract}')">âœ• DEL</button>
      </div>
    </div>
    <div class="brief-body">
      ${mainTags?`<div><div class="fc-title main"><span class="fc-dot ${e.pct>0?'bull':'bear'}"></span>ì£¼ìš”ì¸ Â· ${e.direction}</div><div>${mainTags}</div>
      ${e.mainQuote?`<div class="source-quote"><div class="sq-label">ğŸ“° ì›ë¬¸ ì°¸ê³ </div><div class="sq-text">${e.mainQuote}</div></div>`:''}</div>`:''}
      ${counterTags?`<div style="margin-top:16px"><div class="fc-title counter"><span class="fc-dot dim"></span>ë°˜ëŒ€ìš”ì¸</div><div>${counterTags}</div>
      ${e.counterQuote?`<div class="source-quote counter"><div class="sq-label">ğŸ“° ë°˜ëŒ€ìš”ì¸ ì›ë¬¸</div><div class="sq-text">${e.counterQuote}</div></div>`:''}</div>`:''}
    </div>
    ${e.commentary?`<div class="brief-commentary"><div class="co-label">ì½”ë©˜í„°ë¦¬</div><div class="co-text">${e.commentary}</div></div>`:''}
    <div class="brief-copy">
      <button class="cp-btn img" onclick="downloadImage('card-${e.date}-${e.contract}','${e.date}')">â¬‡ ì´ë¯¸ì§€</button>
      <button class="cp-btn" onclick="copyText('${e.date}-${e.contract}')">Copy</button>
    </div>
  </div>`;
}

function copyText(id) {
  const el = document.querySelector(`#card-${id} .co-text`);
  if(el) { navigator.clipboard.writeText(el.textContent); toast('âœ“ ë³µì‚¬ë¨', 'ok'); }
}

async function downloadImage(id, date) {
  const el = document.getElementById(id);
  const canvas = await html2canvas(el, { backgroundColor: '#222838', scale: 2 });
  const a = document.createElement('a'); a.download = `WTI_${date}.png`; a.href = canvas.toDataURL(); a.click();
}

function toast(m, t) {
  const el = document.getElementById('toast'); el.textContent = m; el.className = `show ${t}`;
  setTimeout(() => el.className = '', 3000);
}

loadData();
</script>
</body>
</html>
